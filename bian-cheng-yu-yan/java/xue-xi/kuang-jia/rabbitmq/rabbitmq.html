<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>RabbitMQ - 折影轻梦</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="折影轻梦,Mixcm,轻惋,觅漫者,小舒同学,Xiaoshu,Nexmoe,产品,Meteor,探索者小舒,伴学OS1,Theme,Design,Product">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <meta name="description" content="RabbitMQ 以下具体内容参考自黑马程序员课程微服务开发框架SpringCloud+RabbitMQ+Docker+Redis+搜索+分布式微服务全技术栈课程  初识MQ同步调用微服务间基于Feign的调用就属于同步方式，存在一些问题。业务代码耦合严重，除此之外对性能影响也很严重，因为需要等待被调用的服务返回结果。不仅如此，而且如果被调用的服务中，有某个服务挂了，则整个服务调用都会出现问题。">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ">
<meta property="og:url" content="https://nexmoe.com/bian-cheng-yu-yan/java/xue-xi/kuang-jia/rabbitmq/rabbitmq.html">
<meta property="og:site_name" content="折影轻梦">
<meta property="og:description" content="RabbitMQ 以下具体内容参考自黑马程序员课程微服务开发框架SpringCloud+RabbitMQ+Docker+Redis+搜索+分布式微服务全技术栈课程  初识MQ同步调用微服务间基于Feign的调用就属于同步方式，存在一些问题。业务代码耦合严重，除此之外对性能影响也很严重，因为需要等待被调用的服务返回结果。不仅如此，而且如果被调用的服务中，有某个服务挂了，则整个服务调用都会出现问题。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402071726650.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402071919653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402072322477.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402073029943.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402073427083.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402073613643.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402073847983.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402074101842.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402074226842.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402074543152.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402074637327.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402080719815.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402082842181.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402210813058.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402210928426.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402211454812.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402211730081.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402214519822.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402214633520.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402215642007.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402215706608.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402220448895.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402222040723.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240403065247801.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240403065809837.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240403071928081.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240403072815201.png">
<meta property="article:published_time" content="2024-04-03T00:00:00.000Z">
<meta property="article:modified_time" content="2024-06-01T14:32:53.518Z">
<meta property="article:author" content="折影轻梦">
<meta property="article:tag" content="RabbitMQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402071726650.png">
    
<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1717252409304">
    
    <link rel="stylesheet" href="/css/style.css?v=1717252409304">

    
        
            <link rel="stylesheet" href="/custom.css?v=1717252409304">
        
    

    
<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>


    <script async src="/js/app.js?v=1717252409304"></script>
    
     

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4D4ZJ9G024"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());

  gtag("config", "G-4D4ZJ9G024");
</script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
    <div id="nexmoe-background">
        <div class="nexmoe-bg" 
            style="background-image: url(https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102206.jpg)"
        ></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="折影轻梦" class="mdui-btn mdui-btn-icon"><img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102017.jpg" alt="折影轻梦"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="折影轻梦">
            <img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102017.jpg" alt="折影轻梦" alt="折影轻梦">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>168</div>
        <div><span>标签</span>60</div>
        <div><span>分类</span>61</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/life.html" title="我的生活">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的生活
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
        
            
            <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        
            <form id="search_form">
                <label><input class="st-default-search-input" id="search_value" name="q" type="search" placeholder="搜索" style="
                    font-size: 15px !important;
                    height: 56px !important;
                    background-image: none;
                "></label>
            </form>
         
    </div>
</div>


	<script async src="/js/search.js?v=1717252409304"></script>



        
            
            <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="http://wpa.qq.com/msgrd?v=3&uin=938798576&site=qq&menu=yes"
			target="_blank"
			mdui-tooltip="{content: 'QQ群'}"
			style="
				color: rgb(249, 174, 8);
				background-color: rgba(249, 174, 8, .1);
			"
		>
			<i
				class="nexmoefont icon-QQ"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://space.bilibili.com/477448861/"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		>
	</div>
</div>

        
            
            
            
            
            
            
    </aside>
    <div class="nexmoe-copyright">
        &copy; 2024 折影轻梦
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
    <div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover"> 
            <img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102206.jpg" alt="RabbitMQ" loading="lazy">
            <h1>RabbitMQ</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2024年04月03日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/RabbitMQ/">RabbitMQ</a>
        
        
    </div>
    
    
    
    
    
</div>

    <h1 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h1><blockquote>
<p>以下具体内容参考自黑马程序员课程<code>微服务开发框架SpringCloud+RabbitMQ+Docker+Redis+搜索+分布式微服务全技术栈课程</code></p>
</blockquote>
<h2 id="初识MQ"><a href="#初识MQ" class="headerlink" title="初识MQ"></a>初识MQ</h2><h3 id="同步调用"><a href="#同步调用" class="headerlink" title="同步调用"></a>同步调用</h3><p>微服务间基于Feign的调用就属于同步方式，存在一些问题。业务代码耦合严重，除此之外对性能影响也很严重，因为需要等待被调用的服务返回结果。<br>不仅如此，而且如果被调用的服务中，有某个服务挂了，则整个服务调用都会出现问题。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402071726650.png" alt="image-20240402071726650" data-caption="image-20240402071726650" loading="lazy"></p>
<h3 id="异步调用"><a href="#异步调用" class="headerlink" title="异步调用"></a>异步调用</h3><p>异步调用常见实现就是事件驱动模式<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402071919653.png" alt="image-20240402071919653" data-caption="image-20240402071919653" loading="lazy"><br><strong>优势</strong></p>
<blockquote>
<p>前三个解决了同步调用的问题</p>
</blockquote>
<ol>
<li>服务解耦，现在只需要发送成功事件即可，不需要更改业务代码</li>
<li>性能提高，吞吐量升高，</li>
<li>服务没有强依赖，无需担心级联失败问题</li>
<li>流量削峰，broker能起到缓冲的作用，右侧的服务则按照自身能力来获取broker的事件<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402072322477.png" alt="image-20240402072322477" data-caption="image-20240402072322477" loading="lazy"><br><strong>劣势</strong><blockquote>
<p>异步通信的缺点</p>
</blockquote>
</li>
<li>依赖于Broker的可靠性、安全性、吞吐能力</li>
<li>架构复杂了，业务没有明显的流程线，不好追踪管理</li>
</ol>
<h3 id="MQ选型"><a href="#MQ选型" class="headerlink" title="MQ选型"></a>MQ选型</h3><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402073029943.png" alt="image-20240402073029943" data-caption="image-20240402073029943" loading="lazy"><br><strong>安装步骤省略</strong><br>rabbitmq的管理界面的端口为15672<br><a target="_blank" rel="noopener" href="http://localhost:15672/">http://localhost:15672</a><br>管理员的账号和密码是<code>guest</code></p>
<h4 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402073427083.png" alt="image-20240402073427083" data-caption="image-20240402073427083" loading="lazy"></p>
<blockquote>
<p><code>Overview</code>是总览，可以看到MQ的节点信息，当前为单节点运行，并不存在集群</p>
</blockquote>
<h4 id="Connections"><a href="#Connections" class="headerlink" title="Connections"></a>Connections</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402073613643.png" alt="image-20240402073613643" data-caption="image-20240402073613643" loading="lazy"></p>
<blockquote>
<p>无论是消息的<code>发布者</code>还是消息的<code>消费者</code>都需要与MQ建立连接</p>
</blockquote>
<h4 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402073847983.png" alt="image-20240402073847983" data-caption="image-20240402073847983" loading="lazy"></p>
<blockquote>
<p><code>Channels</code>是通道，在建立连接后需要创建<code>Channels</code>通道，然后消息的<code>发布者</code>和消息的<code>消费者</code>才能基于<code>Channels</code>完成消息的<code>发布</code>和<code>消费</code></p>
</blockquote>
<h4 id="Exchanges"><a href="#Exchanges" class="headerlink" title="Exchanges"></a>Exchanges</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402074101842.png" alt="image-20240402074101842" data-caption="image-20240402074101842" loading="lazy"></p>
<blockquote>
<p><code>Exchanges</code>交换机用于接收来自生产者的消息，将它们推入队列</p>
</blockquote>
<h4 id="Queues"><a href="#Queues" class="headerlink" title="Queues"></a>Queues</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402074226842.png" alt="image-20240402074226842" data-caption="image-20240402074226842" loading="lazy"></p>
<blockquote>
<p><code>Queues</code>队列用来做消息存储</p>
</blockquote>
<h4 id="Admin"><a href="#Admin" class="headerlink" title="Admin"></a>Admin</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402074543152.png" alt="image-20240402074543152" data-caption="image-20240402074543152" loading="lazy"></p>
<h4 id="MQ架构"><a href="#MQ架构" class="headerlink" title="MQ架构"></a>MQ架构</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402074637327.png" alt="image-20240402074637327" data-caption="image-20240402074637327" loading="lazy"></p>
<h3 id="常见消息模型"><a href="#常见消息模型" class="headerlink" title="常见消息模型"></a>常见消息模型</h3><blockquote>
<p><code>基本消息队列</code>和<code>工作消息队列</code>没有使用到交换机，属于简单队列模型</p>
</blockquote>
<ol>
<li>基本消息队列(BasicQueue)</li>
<li>工作消息队列(WorkQueue)</li>
<li>发布订阅( Publish、Subscribe )，又根据交换机类型不同分为三种<ol>
<li>Fanout Exchange:广播</li>
<li>Direct Exchange:路由</li>
<li>Topic Exchange:主题</li>
</ol>
</li>
</ol>
<h2 id="基本消息队列"><a href="#基本消息队列" class="headerlink" title="基本消息队列"></a>基本消息队列</h2><blockquote>
<p>这里建立的项目结构如下</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css">rabbitmq-demo<br>├─consumer<br>│  └─<span class="hljs-attribute">src</span><br>│      ├─<span class="hljs-selector-tag">main</span><br>│      │  └─resources<br>│      └─test<br>└─publisher<br>    └─<span class="hljs-attribute">src</span><br>        ├─<span class="hljs-selector-tag">main</span><br>        │  ├─java<br>        │  └─resources<br>        └─test<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402080719815.png" alt="image-20240402080719815" data-caption="image-20240402080719815" loading="lazy"></p>
<blockquote>
<p>父级pom</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rabbitmq-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>rabbitmq-demo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>rabbitmq-demo<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>consumer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>publisher<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>3.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>publisher</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rabbitmq-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>publisher<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>publisher<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>publisher<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.amqp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-rabbit-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>consumer与publisher一样，改名字即可</p>
<p>发送和监听消息的示例代码如下</p>
<p>需要注意的是：<code>RabbitMQ</code>的端口是<code>5672</code>，<code>管理页面</code>端口才是<code>15672</code>，这里端口需要写<code>5672</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * RabbitMQ发送消息测试</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: 不是菜狗爱编程</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2024/04/02/8:11</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMessageTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">// 1.建立连接</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span><br>        factory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        factory.setPort(<span class="hljs-number">5672</span>);<br>        factory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        factory.setUsername(<span class="hljs-string">&quot;tong&quot;</span>);<br>        factory.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">// 1.2.建立连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> factory.newConnection();<br>        <span class="hljs-comment">// 2.创建通道Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">// 3.创建队列</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        channel.queueDeclare(queueName, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// 4.发送消息</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, rabbitmq!&quot;</span>;<br>        channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, queueName, <span class="hljs-literal">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">&quot;发送消息成功：【&quot;</span> + message + <span class="hljs-string">&quot;】&quot;</span>);<br>        <span class="hljs-comment">// 5.关闭通道和连接</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * RabbitMQ监听消息测试</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: 不是菜狗爱编程</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2024/04/02/8:11</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ListenMessageTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenMessageTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">// 1.建立连接</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span><br>        factory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        factory.setPort(<span class="hljs-number">5672</span>);<br>        factory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        factory.setUsername(<span class="hljs-string">&quot;tong&quot;</span>);<br>        factory.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">// 1.2.建立连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> factory.newConnection();<br>        <span class="hljs-comment">// 2.创建通道Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">// 3.创建队列</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        channel.queueDeclare(queueName, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// 4.订阅消息</span><br>        channel.basicConsume(queueName, <span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope,</span><br><span class="hljs-params">                                       AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">// 5.处理消息</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body);<br>                System.out.println(<span class="hljs-string">&quot;接收到消息：【&quot;</span> + message + <span class="hljs-string">&quot;】&quot;</span>);<br>            &#125;<br>        &#125;);<br>        System.out.println(<span class="hljs-string">&quot;等待接收消息。。。。&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>基本消息队列的消息发送流程:</strong></p>
<ol>
<li>建立connection</li>
<li>创建channel</li>
<li>利用channel声明队列</li>
<li>利用channel向队列发送消息<br><strong>基本消息队列的消息接收流程:</strong></li>
<li>建立connection</li>
<li>创建channel</li>
<li>利用channel声明队列</li>
<li>定义consumer的消费行为handleDelivery()</li>
<li>利用channel将消费者与队列绑定</li>
</ol>
<h2 id="SpringAMQP"><a href="#SpringAMQP" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h2><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402082842181.png" alt="image-20240402082842181" data-caption="image-20240402082842181" loading="lazy"><br>特征</p>
<ol>
<li>侦听器容器，用异步处理入站消息</li>
<li>用于发送和接收消息的RabbitTemplate</li>
<li>RabbitAdmin用于自动声明队列，交换机和绑定关系<br>案例流程如下</li>
<li>在父工程中引入spring-amqp的依赖</li>
<li>在publisher服务中利用RabbitTemplate发送消息到simple.queue这个队列</li>
<li>在consumer服务中编写消费逻辑，绑定simple.queue这个队列<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * RabbitMQ发送消息测试</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: 不是菜狗爱编程</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2024/04/02/8:11</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMessageTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageWithRabbitMqTemplateTest</span><span class="hljs-params">()</span>&#123;<br>        String queueName=<span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        String message=<span class="hljs-string">&quot;你好，这是【RabbitTemplate】发送的消息&quot;</span>;<br>        rabbitTemplate.convertAndSend(queueName,message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>application.properties</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 主机名 192.168.XXX.XXX</span><br><span class="hljs-attr">spring.rabbitmq.host</span>=<span class="hljs-string">localhost</span><br><span class="hljs-comment"># 端口</span><br><span class="hljs-attr">spring.rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-comment"># 虚拟主机</span><br><span class="hljs-attr">spring.rabbitmq.virtual-host</span>=<span class="hljs-string">/</span><br><span class="hljs-attr">spring.rabbitmq.username</span>=<span class="hljs-string">tong</span><br><span class="hljs-attr">spring.rabbitmq.password</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402210813058.png" alt="image-20240402210813058" data-caption="image-20240402210813058" loading="lazy"><blockquote>
<p>点击<code>simple.queue</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402210928426.png" alt="image-20240402210928426" data-caption="image-20240402210928426" loading="lazy"><br>consumer工程的properties也同样配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqListener</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 简单队列侦听器</span><br><span class="hljs-comment">     * 消息发送者发送的是字符串，所以这边也适用字符串来接收</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &#123;&quot;simple.queue&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simpleQueueListener</span><span class="hljs-params">(String message)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;接收到的消息为:&#123;&#125;&quot;</span>,message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>启动consumer工程后接收到消息<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402211454812.png" alt="image-20240402211454812" data-caption="image-20240402211454812" loading="lazy"><br>发现<code>消息消失了</code>，因为这是MQ的机制，<code>阅后即焚</code>，消息不可重复消费</p>
</blockquote>
</li>
</ol>
<h2 id="工作消息队列"><a href="#工作消息队列" class="headerlink" title="工作消息队列"></a>工作消息队列</h2><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402211730081.png" alt="image-20240402211730081" data-caption="image-20240402211730081" loading="lazy"></p>
<blockquote>
<p>两个消费者共同消费生产者发布的消息，由于消息<code>阅后即焚</code>的特性，所以只能消费者1消费一部分消息，消费者2消费一部分消息<br>但是当发布的消息过多，两个消费者的能力不足，则多余的消息就会堆积在<code>队列</code>里<br>当<code>队列</code>存储的<code>消息</code>达到上限时，则会发生消息丢失</p>
<p>**<code>工作队列</code>**，可以提高消息处理速度，避免队列消息堆积<br><strong>实现思路如下</strong></p>
</blockquote>
<ol>
<li>在publisher服务中定义测试方法，每秒产生50条消息，发送到simple.queue的</li>
<li>在consumer服务中定义两个消息监听者，都监听simple.queue队列</li>
<li>消费者1每秒处理50条消息，消费者2每秒处理10条消息<br>所以照理来说，消费者应该能在<code>1s</code>内<code>消费完</code>消息<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMessageTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用工作队列测试发送消息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageWithWorkQueueTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        String queueName=<span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        String message=<span class="hljs-string">&quot;你好，这是消息&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) &#123;<br>            rabbitTemplate.convertAndSend(queueName,message+i);<br>            Thread.sleep(<span class="hljs-number">20</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqListener</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 工作队列侦听器1</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &#123;&quot;simple.queue&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">workQueueListener1</span><span class="hljs-params">(String message)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        log.info(<span class="hljs-string">&quot;工作队列侦听器1:接收到的消息为:&#123;&#125;&quot;</span>,message);<br>        Thread.sleep(<span class="hljs-number">20</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 工作队列侦听器2</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &#123;&quot;simple.queue&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">workQueueListener2</span><span class="hljs-params">(String message)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        log.info(<span class="hljs-string">&quot;工作队列侦听器2:接收到的消息为:&#123;&#125;&quot;</span>,message);<br>        Thread.sleep(<span class="hljs-number">200</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>打印日志如下</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.431</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">0</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.456</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">1</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.518</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">3</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.580</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">5</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.641</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">2</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.641</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">7</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.705</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">9</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.767</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">11</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.830</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">13</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.845</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">4</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.893</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">15</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">56.956</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">17</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.018</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">19</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.049</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">6</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.081</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">21</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.145</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">23</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.208</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">25</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.253</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">8</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.269</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">27</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.333</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">29</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.397</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">31</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.458</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">10</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.460</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">33</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.522</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">35</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.584</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">37</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.651</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">39</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.662</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">12</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.710</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">41</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.775</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">43</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.837</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">45</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.867</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">14</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.900</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">47</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">57.963</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#1-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">1</span>:接收到的消息为:你好，这是消息<span class="hljs-number">49</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">58.070</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">16</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">58.276</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">18</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">58.481</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">20</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">58.687</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">22</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">58.889</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">24</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">59.096</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">26</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">59.301</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">28</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">59.507</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">30</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">59.712</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">32</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">31</span>:<span class="hljs-number">59.917</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">34</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">32</span>:<span class="hljs-number">00.119</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">36</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">32</span>:<span class="hljs-number">00.321</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">38</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">32</span>:<span class="hljs-number">00.525</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">40</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">32</span>:<span class="hljs-number">00.730</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">42</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">32</span>:<span class="hljs-number">00.946</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">44</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">32</span>:<span class="hljs-number">01.150</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">46</span><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">02</span>T21:<span class="hljs-number">32</span>:<span class="hljs-number">01.353</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">9600</span> --- <span class="hljs-selector-attr">[ntContainer#0-1]</span> c<span class="hljs-selector-class">.e</span><span class="hljs-selector-class">.consumer</span><span class="hljs-selector-class">.listener</span><span class="hljs-selector-class">.RabbitMqListener</span>   : 工作队列侦听器<span class="hljs-number">2</span>:接收到的消息为:你好，这是消息<span class="hljs-number">48</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>根据日志打印的时间得知，消息处理的时间为<code>5s</code>，但我们预计的时间是<code>1s</code></p>
<p>这是因为由于rabbitmq的<code>预取机制</code>，会在消息消费前先平分获取到消息，但消息被消费者A获取后，其他的消费者就无法再消费这些消息了</p>
<p>所以这里可以看到<code>工作队列侦听器1</code>和<code>工作队列侦听器2</code>都各自消费了<code>25</code>条消息，且<code>工作队列侦听器1</code>消费的是<code>奇数</code>，<code>工作队列侦听器2</code>则是<code>偶数</code></p>
<p>添加<code>如下配置</code>即可解决</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 应用服务 WEB 访问端口</span><br><span class="hljs-attr">server.port</span>=<span class="hljs-string">8090</span><br><span class="hljs-comment"># 主机名 192.168.XXX.XXX</span><br><span class="hljs-attr">spring.rabbitmq.host</span>=<span class="hljs-string">localhost</span><br><span class="hljs-comment"># 端口</span><br><span class="hljs-attr">spring.rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-comment"># 虚拟主机</span><br><span class="hljs-attr">spring.rabbitmq.virtual-host</span>=<span class="hljs-string">/</span><br><span class="hljs-attr">spring.rabbitmq.username</span>=<span class="hljs-string">tong</span><br><span class="hljs-attr">spring.rabbitmq.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-comment"># 每次只取一条消息，处理完成再获取下一条</span><br><span class="hljs-attr">spring.rabbitmq.listener.simple.prefetch</span>=<span class="hljs-string">1</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="发布、订阅"><a href="#发布、订阅" class="headerlink" title="发布、订阅"></a>发布、订阅</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><blockquote>
<p>发布订阅模式与之前案例的区别就是允许将同一消息发送给多个消费者。实现方式是加入了exchange (交换机)。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402214519822.png" alt="image-20240402214519822" data-caption="image-20240402214519822" loading="lazy"><br>常见exchange类型包括:</p>
</blockquote>
<ol>
<li>Fanout: 广播</li>
<li>Direct: 路由</li>
<li>Topic: 话题<br><strong><code>注意</code></strong>: exchange负责消息路由，而不负责存储，路由失败则消息丢失</li>
</ol>
<h3 id="Fanout-发布订阅"><a href="#Fanout-发布订阅" class="headerlink" title="Fanout 发布订阅"></a>Fanout 发布订阅</h3><blockquote>
<p>Fanout Exchange会将接收到的消息路由到每一个跟其绑定的queue<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402214633520.png" alt="image-20240402214633520" data-caption="image-20240402214633520" loading="lazy"><br><strong>实现思路如下:</strong></p>
</blockquote>
<ol>
<li>在consumer服务中，利用代码声明队列、交换机，并将两者绑定</li>
<li>在consumer服务中，编写两个消费者方法，分别监听<code>fanout.queue1</code>和<code>fanout.queue2</code></li>
<li>在publisher中编写测试方法，向<code>fanout.exchange</code>发送消息<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * FanoutExchange配置</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: 不是菜狗爱编程</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2024/04/02/21:49</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FanoutExchangeConfig</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fanout交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> FanoutExchange&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">fanoutExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(<span class="hljs-string">&quot;fanout.exchange&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fanout队列1</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Queue&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">fanoutQueue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;fanoutQueue1&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fanout队列2</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Queue&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">fanoutQueue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;fanoutQueue2&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列1</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutQueue1   扇出队列1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutExchange 扇出交换</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Binding&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">buildingQueue1</span><span class="hljs-params">(Queue fanoutQueue1, FanoutExchange fanoutExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列2</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutQueue2   扇出队列1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutExchange 扇出交换</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Binding&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">buildingQueue2</span><span class="hljs-params">(Queue fanoutQueue2, FanoutExchange fanoutExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402215642007.png" alt="image-20240402215642007" data-caption="image-20240402215642007" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402215706608.png" alt="image-20240402215706608" data-caption="image-20240402215706608" loading="lazy"><blockquote>
<p>配置<code>交换机</code>和<code>队列</code>以及它们的<code>绑定关系</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FanoutExchangeConfig</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fanout交换机</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> FanoutExchange&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">fanoutExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(<span class="hljs-string">&quot;fanout.exchange&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fanout队列1</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Queue&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">fanoutQueue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;fanoutQueue1&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fanout队列2</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Queue&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">fanoutQueue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;fanoutQueue2&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列1</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutQueue1   扇出队列1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutExchange 扇出交换</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Binding&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">buildingQueue1</span><span class="hljs-params">(Queue fanoutQueue1, FanoutExchange fanoutExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列2</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutQueue2   扇出队列1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fanoutExchange 扇出交换</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Binding&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">buildingQueue2</span><span class="hljs-params">(Queue fanoutQueue2, FanoutExchange fanoutExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqListener</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fanout队列侦听器1</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &#123;&quot;fanoutQueue1&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fanoutQueueListener1</span><span class="hljs-params">(String message)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;fanout队列侦听器1:接收到的消息为:&#123;&#125;&quot;</span>,message);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fanout队列侦听器2</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &#123;&quot;fanoutQueue2&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fanoutQueueListener2</span><span class="hljs-params">(String message)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;fanout队列侦听器2:接收到的消息为:&#123;&#125;&quot;</span>,message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMessageTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用Fanout交换机测试发送消息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageWithFanoutExchangeTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        String exchangeName=<span class="hljs-string">&quot;fanout.exchange&quot;</span>;<br>        String message=<span class="hljs-string">&quot;你好，这是消息&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) &#123;<br>            rabbitTemplate.convertAndSend(exchangeName,<span class="hljs-string">&quot;&quot;</span>,message+i);<br>            Thread.sleep(<span class="hljs-number">20</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="DirectExchange"><a href="#DirectExchange" class="headerlink" title="DirectExchange"></a>DirectExchange</h3><blockquote>
<p>Direct Exchange会将接收到的消息根据规则路由到指定的Queue,因此称为路由模式(routes) 。</p>
<p>每一个Queue都与Exchange设置一个BindingKey</p>
<p>发布者发送消息时，指定消息的RoutingKey</p>
<p>Exchange将消息路由到BindingKey与消息RoutingKey一致的队列<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402220448895.png" alt="image-20240402220448895" data-caption="image-20240402220448895" loading="lazy"><br>**<code>需要注意</code>**：一个队列，可以绑定多个<code>key</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqListener</span> &#123;<br>   <br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * direct队列侦听器1</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            value = @Queue(&quot;directQueue1&quot;),</span><br><span class="hljs-meta">            exchange = @Exchange(value = &quot;direct.exchange&quot;,type = ExchangeTypes.DIRECT),</span><br><span class="hljs-meta">            key = &#123;&quot;red&quot;,&quot;blue&quot;&#125;</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">directQueueListener1</span><span class="hljs-params">(String message)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;direct队列侦听器1:接收到的消息为:&#123;&#125;&quot;</span>,message);<br>    &#125;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * direct队列侦听器2</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            value = @Queue(&quot;directQueue2&quot;),</span><br><span class="hljs-meta">            exchange = @Exchange(value = &quot;direct.exchange&quot;,type = ExchangeTypes.DIRECT),</span><br><span class="hljs-meta">            key = &#123;&quot;yellow&quot;,&quot;blue&quot;&#125;</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">directQueueListener2</span><span class="hljs-params">(String message)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;direct队列侦听器2:接收到的消息为:&#123;&#125;&quot;</span>,message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>启动<code>consumer</code>项目，前往rabbitmq网页。发现<code>direct.exchange</code>交换机和<code>directQueue1</code>、<code>directQueue2</code>队列已经声明了</p>
<p>查看绑定关系<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240402222040723.png" alt="image-20240402222040723" data-caption="image-20240402222040723" loading="lazy"></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMessageTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用Direct交换机测试发送消息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageWithDirectExchangeTest</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct.exchange&quot;</span>;<br>        String[] routingKeys=&#123;<span class="hljs-string">&quot;yellow&quot;</span>,<span class="hljs-string">&quot;red&quot;</span>,<span class="hljs-string">&quot;blue&quot;</span>&#125;;<br>        <span class="hljs-keyword">for</span> (String routingKey : routingKeys) &#123;<br>            rabbitTemplate.convertAndSend(exchangeName, routingKey, <span class="hljs-string">&quot;消息是:&quot;</span>+routingKey);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>日志打印如下</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">direct</span>队列侦听器<span class="hljs-number">2</span>:接收到的消息为:消息是:yellow<br><span class="hljs-attribute">direct</span>队列侦听器<span class="hljs-number">1</span>:接收到的消息为:消息是:red<br><span class="hljs-attribute">direct</span>队列侦听器<span class="hljs-number">1</span>:接收到的消息为:消息是:blue<br><span class="hljs-attribute">direct</span>队列侦听器<span class="hljs-number">2</span>:接收到的消息为:消息是:blue<br></code></pre></td></tr></table></figure>
<h3 id="TopicExchange"><a href="#TopicExchange" class="headerlink" title="TopicExchange"></a>TopicExchange</h3><blockquote>
<p><code>TopicExchange</code>与DirectExchange类似， 区别在于routingKey必须是多个单词的列表,并且以<code>.</code>分割。</p>
<p>Queue与Exchange指定<code>BindingKey</code>时可以使用通配符:<br><code>#</code>:代指0个或多个单词<br><code>*</code>:代指一个单词<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240403065247801.png" alt="image-20240403065247801" data-caption="image-20240403065247801" loading="lazy"><br><strong>实现思路如下</strong></p>
</blockquote>
<ol>
<li>并利用@RabbitListener声明Exchange、Queue、RoutingKey</li>
<li>在consumer服务中，编写两个消费者方法,分别监听<code>topic.queue1</code>和<code>topic.queue2</code></li>
<li>在publisher中编写测试方法，向<code>topic.exchange</code>发送消息<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * RabbitMQ 侦听器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: 不是菜狗爱编程</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2024/04/02/21:11</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqListener</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主题队列侦听器1</span><br><span class="hljs-comment">     * 接收 china 的一切信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            value = @Queue(&quot;topicQueue1&quot;),</span><br><span class="hljs-meta">            exchange = @Exchange(value = &quot;topic.exchange&quot;,type = ExchangeTypes.TOPIC),</span><br><span class="hljs-meta">            key = &quot;china.#&quot;</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">topicQueueListener1</span><span class="hljs-params">(String message)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;topic队列侦听器1:接收到的消息为:&#123;&#125;&quot;</span>,message);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主题队列侦听器2</span><br><span class="hljs-comment">     * 接收一切 news 信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            value = @Queue(&quot;topicQueue2&quot;),</span><br><span class="hljs-meta">            exchange = @Exchange(value = &quot;topic.exchange&quot;,type = ExchangeTypes.TOPIC),</span><br><span class="hljs-meta">            key = &quot;#.news&quot;</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">topicQueueListener2</span><span class="hljs-params">(String message)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;topic队列侦听器2:接收到的消息为:&#123;&#125;&quot;</span>,message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
启动项目后，确认绑定关系<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240403065809837.png" alt="image-20240403065809837" data-caption="image-20240403065809837" loading="lazy"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * RabbitMQ发送消息测试</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: 不是菜狗爱编程</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2024/04/02/8:11</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMessageTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用Topic交换机测试发送消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageWithTopicExchangeTest</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic.exchange&quot;</span>;<br>        String[] routingKeys=&#123;<span class="hljs-string">&quot;china.weather&quot;</span>,<span class="hljs-string">&quot;china.news&quot;</span>,<span class="hljs-string">&quot;Japan.weather&quot;</span>,<span class="hljs-string">&quot;Japan.news&quot;</span>&#125;;<br>        <span class="hljs-keyword">for</span> (String routingKey : routingKeys) &#123;<br>            rabbitTemplate.convertAndSend(exchangeName, routingKey, <span class="hljs-string">&quot;消息是:&quot;</span>+routingKey);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="消息转换器"><a href="#消息转换器" class="headerlink" title="消息转换器"></a>消息转换器</h2><blockquote>
<p>说明:在SpringAMQP的发送方法中，接收消息的类型是Object,也就是说我们可以发送任意对象类型的消息，SpringAMQP会帮我们序列化为字节后发送。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FanoutExchangeConfig</span> &#123;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 对象队列</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> Queue&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">objectQueue</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;objectQueue&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = &#123;&quot;objectQueue&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">objectQueueListener</span><span class="hljs-params">(Object object)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;objectQueue队列侦听器:接收到的消息为:&#123;&#125;&quot;</span>,object);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>这里将consumer启动之后，就会创建<code>objectQueue</code>队列</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMessageTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发送对象消息测试</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendObjectMessageTest</span><span class="hljs-params">()</span> &#123;<br>        String queueName=<span class="hljs-string">&quot;objectQueue&quot;</span>;<br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;马小跳&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;gender&quot;</span>,<span class="hljs-string">&quot;男&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-string">&quot;18&quot;</span>);<br>        rabbitTemplate.convertAndSend(queueName,map);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>消费消息的日志打印如下</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">objectQueue队列侦听器:接收到的消息为:(Body:<span class="hljs-string">&#x27;[serialized object]&#x27;</span> MessageProperties [headers=&#123;&#125;, <span class="hljs-attribute">contentType</span>=application/x-java-serialized-object, <span class="hljs-attribute">contentLength</span>=0, <span class="hljs-attribute">receivedDeliveryMode</span>=PERSISTENT, <span class="hljs-attribute">priority</span>=0, <span class="hljs-attribute">redelivered</span>=<span class="hljs-literal">false</span>, <span class="hljs-attribute">receivedExchange</span>=, <span class="hljs-attribute">receivedRoutingKey</span>=objectQueue, <span class="hljs-attribute">deliveryTag</span>=1, <span class="hljs-attribute">consumerTag</span>=amq.ctag-6jbSNzh0393W9MP8GZ1z-w, <span class="hljs-attribute">consumerQueue</span>=objectQueue])<br></code></pre></td></tr></table></figure>
<blockquote>
<p>这次将<code>consumer</code>项目关闭，我们重新发送信息，去<code>rabbitmq</code>管理页面看一看消息<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240403071928081.png" alt="image-20240403071928081" data-caption="image-20240403071928081" loading="lazy"><br>rabbitmq原生只支持字节，但是spring允许我们发送对象，这是因为使用了jdk序列化，但是这种序列化有缺点</p>
<ol>
<li>性能较差</li>
<li>安全性问题，容易出现注入问题</li>
<li>数据长度太长了（消息体越大，传输消息的速度越慢，而且占用额外的内存空间）</li>
</ol>
<p><code>如何重新设定序列化的方式？</code></p>
<p>Spring的对消息对象的处理是由<code>org.springframework.amqp.support.converter.MessageConverter</code>来处理的。</p>
<p>而默认实现是<code>SimpleMessageConverter</code>,基于JDK的ObjectOutputStream完成序列化。</p>
<p>如果要修改只需要定义一个MessageConverter类型的Bean即可。推荐用JSON方式序列化</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqConfig</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 采用json的方式将消息序列化</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> MessageConverter&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MessageConverter <span class="hljs-title function_">messageConverter</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>重新发送消息，前往rabbitmq管理页面查看<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240403072815201.png" alt="image-20240403072815201" data-caption="image-20240403072815201" loading="lazy"><br>消息消费也需要配置<code>jackson</code>依赖、<code>RabbitMqConfig</code>，上面代码复制粘贴即可，这里不再重复</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * RabbitMQ 侦听器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: 不是菜狗爱编程</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2024/04/02/21:11</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqListener</span> &#123;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 对象队列侦听器</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> map 对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &#123;&quot;objectQueue&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">objectQueueListener</span><span class="hljs-params">(Map&lt;String,Object&gt; map)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;objectQueue队列侦听器:接收到的消息为:&#123;&#125;&quot;</span>,map);<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) &#123;<br>            System.out.println(<span class="hljs-string">&quot;entry = &quot;</span> + entry);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>总结</strong><br>SpringAMQP中消息的序列化和反序列化是怎么实现的?</p>
<ol>
<li>利用MessageConverter实现的，默认是JDK的序列化</li>
<li>注意发送方与接收方必须使用相同的MessageConverter</li>
</ol>

    
  </article>

  
      

  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a>
    
</div>
  
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
    data-repo="nexmoe/nexmoe.com"
    data-repo-id="R_kgDOJI1XUA"
    data-category="General"
    data-category-id="DIC_kwDOJI1XUM4CU1nn"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>

      </div>
  
</div>
</div>
        <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">1.</span> <span class="toc-text">RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E8%AF%86MQ"><span class="toc-number">1.1.</span> <span class="toc-text">初识MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.1.</span> <span class="toc-text">同步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.2.</span> <span class="toc-text">异步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ%E9%80%89%E5%9E%8B"><span class="toc-number">1.1.3.</span> <span class="toc-text">MQ选型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Overview"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Connections"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">Connections</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Channels"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">Channels</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exchanges"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">Exchanges</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Queues"><span class="toc-number">1.1.3.5.</span> <span class="toc-text">Queues</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Admin"><span class="toc-number">1.1.3.6.</span> <span class="toc-text">Admin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQ%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.3.7.</span> <span class="toc-text">MQ架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.4.</span> <span class="toc-text">常见消息模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.2.</span> <span class="toc-text">基本消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringAMQP"><span class="toc-number">1.3.</span> <span class="toc-text">SpringAMQP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.4.</span> <span class="toc-text">工作消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E3%80%81%E8%AE%A2%E9%98%85"><span class="toc-number">1.5.</span> <span class="toc-text">发布、订阅</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.5.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fanout-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-number">1.5.2.</span> <span class="toc-text">Fanout 发布订阅</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DirectExchange"><span class="toc-number">1.5.3.</span> <span class="toc-text">DirectExchange</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TopicExchange"><span class="toc-number">1.5.4.</span> <span class="toc-text">TopicExchange</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">1.6.</span> <span class="toc-text">消息转换器</span></a></li></ol></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
    </div>
    <div id="nexmoe-search-space">
	<div class="search-container">
		<div class="search-header">
			<div class="search-input-container">
				<input
					class="search-input"
					type="text"
					placeholder="搜索"
					oninput="sinput();"
				/>
			</div>
			<a class="search-close" onclick="sclose();">×</a>
		</div>
		<div class="search-body"></div>
	</div>
</div>

    
    
</body>

</html>
