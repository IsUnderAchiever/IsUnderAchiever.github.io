<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>Redis - 折影轻梦</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="折影轻梦,Mixcm,轻惋,觅漫者,小舒同学,Xiaoshu,Nexmoe,产品,Meteor,探索者小舒,伴学OS1,Theme,Design,Product">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <meta name="description" content="Redis单点Redis的问题 数据丢失问题Redis是内存存储，服务重启可能会丢失数据 并发能力问题单节点Redis并发能力虽然不错，但也无法满足如618这样的高并发场景 故障恢复问题如果Redis宕机，则服务不可用，需要一种自动的故障恢复手段 存储能力问题Redis基于内存，单节点能存储的数据量难以满足海量数据需求 解决方案   数据丢失问题实现Redis数据持久化 并发能力问题搭建主从集群，">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="https://nexmoe.com/bian-cheng-yu-yan/java/xue-xi/kuang-jia/redis/redis.html">
<meta property="og:site_name" content="折影轻梦">
<meta property="og:description" content="Redis单点Redis的问题 数据丢失问题Redis是内存存储，服务重启可能会丢失数据 并发能力问题单节点Redis并发能力虽然不错，但也无法满足如618这样的高并发场景 故障恢复问题如果Redis宕机，则服务不可用，需要一种自动的故障恢复手段 存储能力问题Redis基于内存，单节点能存储的数据量难以满足海量数据需求 解决方案   数据丢失问题实现Redis数据持久化 并发能力问题搭建主从集群，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415211506657.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415213015095.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415213600960.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415214253132.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415214743582.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415215054692.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416063931474.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416070837220.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416070901240.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416070908369.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416071004714.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416071252667.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416071420341.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421125052157.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421135026402.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421133144513.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421140154283.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421142455620.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421142858831.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421142916435.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421143048582.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421143606124.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421143752145.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421143738686.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421144659573.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421150448468.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421151021414.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421151554098.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212010655.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212010983.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212017069.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212101080.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212106197.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212224751.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212227284.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220644926.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220734941.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220736397.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220740344.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220751093.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220800499.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220758218.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220802251.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220822902.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220824380.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220825414.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220826733.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220830568.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220831656.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220831464.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222011412.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222011833.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222015126.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222015689.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222016266.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222017371.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222017656.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222048262.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222051246.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222053908.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222109918.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222116235.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404232154657.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404232210854.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404240738901.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404240809279.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242013465.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404240829903.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242021196.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242021909.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242044685.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242047718.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242049543.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242050050.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242053831.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242055720.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242056356.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242059554.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242101468.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242103921.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242109850.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242110235.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242125244.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242127034.png">
<meta property="og:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242128817.png">
<meta property="article:published_time" content="2024-04-24T13:30:00.000Z">
<meta property="article:modified_time" content="2024-06-01T14:12:24.940Z">
<meta property="article:author" content="折影轻梦">
<meta property="article:tag" content="折影轻梦,Mixcm,轻惋,觅漫者,小舒同学,Xiaoshu,Nexmoe,产品,Meteor,探索者小舒,伴学OS1,Theme,Design,Product">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415211506657.png">
    
<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1717251230301">
    
    <link rel="stylesheet" href="/css/style.css?v=1717251230301">

    
        
            <link rel="stylesheet" href="/custom.css?v=1717251230301">
        
    

    
<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>


    <script async src="/js/app.js?v=1717251230301"></script>
    
     

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4D4ZJ9G024"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());

  gtag("config", "G-4D4ZJ9G024");
</script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
    <div id="nexmoe-background">
        <div class="nexmoe-bg" 
            style="background-image: url(https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102206.jpg)"
        ></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="折影轻梦" class="mdui-btn mdui-btn-icon"><img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102017.jpg" alt="折影轻梦"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="折影轻梦">
            <img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102017.jpg" alt="折影轻梦" alt="折影轻梦">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>168</div>
        <div><span>标签</span>60</div>
        <div><span>分类</span>61</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/life.html" title="我的生活">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的生活
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
        
            
            <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        
            <form id="search_form">
                <label><input class="st-default-search-input" id="search_value" name="q" type="search" placeholder="搜索" style="
                    font-size: 15px !important;
                    height: 56px !important;
                    background-image: none;
                "></label>
            </form>
         
    </div>
</div>


	<script async src="/js/search.js?v=1717251230301"></script>



        
            
            <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="http://wpa.qq.com/msgrd?v=3&uin=938798576&site=qq&menu=yes"
			target="_blank"
			mdui-tooltip="{content: 'QQ群'}"
			style="
				color: rgb(249, 174, 8);
				background-color: rgba(249, 174, 8, .1);
			"
		>
			<i
				class="nexmoefont icon-QQ"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://space.bilibili.com/477448861/"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		>
	</div>
</div>

        
            
            
            
            
            
            
    </aside>
    <div class="nexmoe-copyright">
        &copy; 2024 折影轻梦
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
    <div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover"> 
            <img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102206.jpg" alt="Redis" loading="lazy">
            <h1>Redis</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2024年04月24日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/Redis/">Redis</a>
        
        
    </div>
    
    
    
    
    
</div>

    <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="单点Redis的问题"><a href="#单点Redis的问题" class="headerlink" title="单点Redis的问题"></a>单点Redis的问题</h2><ol>
<li>数据丢失问题<br>Redis是内存存储，服务重启可能会丢失数据</li>
<li>并发能力问题<br>单节点Redis并发能力虽然不错，但也无法满足如618这样的高并发场景</li>
<li>故障恢复问题<br>如果Redis宕机，则服务不可用，需要一种自动的故障恢复手段</li>
<li>存储能力问题<br>Redis基于内存，单节点能存储的数据量难以满足海量数据需求<blockquote>
<p><strong>解决方案</strong></p>
</blockquote>
</li>
<li>数据丢失问题<br>实现Redis数据持久化</li>
<li>并发能力问题<br>搭建主从集群，实现读写分离(提高并发能力，实现高可用，进一步避免宕机导致的数据丢失)</li>
<li>故障恢复问题<br>利用Redis哨兵，实现健康检测和自动恢复</li>
<li>存储能力问题<br>搭建分片集群，利用插槽机制实现动态扩容</li>
</ol>
<h2 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h2><h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><blockquote>
<p>RDB全称Redis Database Backup file ( Redis数据备份文件)，也被叫做Redis数据快照。简单来说就是把内存中的所有数据都记录到<code>磁盘</code>中。当Redis实例故障重启后，从磁盘读取快照文件,恢复数据。</p>
<p>快照文件称为RDB文件，默认是保存在当前运行目录。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli<br><span class="hljs-comment"># 由Redis主进程来执行RDB，会阻塞其他命令</span><br><span class="hljs-comment"># 而将数据备份到磁盘中的速度又很慢，不推介这种方法</span><br>save<br><span class="hljs-comment"># 子进程在后台异步执行RDB，避免主进程受到影响</span><br>bgsave<br></code></pre></td></tr></table></figure>
<p><strong>Redis停机时，会自动进行一次RDB备份</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">C:\Users\Administrator&gt;redis-cli<br><span class="hljs-comment"># 测试redis连接</span><br>127.0.0.1:6379&gt; ping<br>PONG<br><span class="hljs-comment"># 存数据</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> num 123<br>OK<br><span class="hljs-comment"># 取数据</span><br>127.0.0.1:6379&gt; get num<br><span class="hljs-string">&quot;123&quot;</span><br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>停止Redis，日志打印如下</p>
</blockquote>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><code class="hljs jboss-cli">D:\Redis&gt;redis-server.exe redis.windows.conf<br>                _._<br>           _.-``__ &#x27;&#x27;-<span class="hljs-string">._</span><br>      _.-``    `.  `_.  &#x27;&#x27;-<span class="hljs-string">._</span>           Redis 3.0.504 <span class="hljs-params">(00000000/0)</span> 64 bit<br>  <span class="hljs-string">.-</span>`` <span class="hljs-string">.-</span>```.  ```\/    _.,_ &#x27;&#x27;-<span class="hljs-string">._</span><br> <span class="hljs-params">(    &#x27;      ,       .-`  | `,    )</span>     Running in standalone mode<br> |`-<span class="hljs-string">._</span>`-<span class="hljs-string">...-</span>` __.<span class="hljs-string">..-.</span>``-<span class="hljs-string">._</span>|&#x27;` _.-&#x27;|     Port: 6379<br> |    `-<span class="hljs-string">._</span>   `<span class="hljs-string">._</span>    /     _.-&#x27;    |     PID: 3204<br>  `-<span class="hljs-string">._</span>    `-<span class="hljs-string">._</span>  `-<span class="hljs-string">./</span>  _.-&#x27;    _.-&#x27;<br> |`-<span class="hljs-string">._</span>`-<span class="hljs-string">._</span>    `-<span class="hljs-string">.__.-</span>&#x27;    _.-&#x27;_.-&#x27;|<br> |    `-<span class="hljs-string">._</span>`-<span class="hljs-string">._</span>        _.-&#x27;_.-&#x27;    |           http:<span class="hljs-string">//redis.io</span><br>  `-<span class="hljs-string">._</span>    `-<span class="hljs-string">._</span>`-<span class="hljs-string">.__.-</span>&#x27;_.-&#x27;    _.-&#x27;<br> |`-<span class="hljs-string">._</span>`-<span class="hljs-string">._</span>    `-<span class="hljs-string">.__.-</span>&#x27;    _.-&#x27;_.-&#x27;|<br> |    `-<span class="hljs-string">._</span>`-<span class="hljs-string">._</span>        _.-&#x27;_.-&#x27;    |<br>  `-<span class="hljs-string">._</span>    `-<span class="hljs-string">._</span>`-<span class="hljs-string">.__.-</span>&#x27;_.-&#x27;    _.-&#x27;<br>      `-<span class="hljs-string">._</span>    `-<span class="hljs-string">.__.-</span>&#x27;    _.-&#x27;<br>          `-<span class="hljs-string">._</span>        _.-&#x27;<br>              `-<span class="hljs-string">.__.-</span>&#x27;<br>[3204] 15 Apr 21<span class="hljs-function">:11</span><span class="hljs-function">:30.427</span> <span class="hljs-comment"># Server started, Redis version 3.0.504</span><br>[3204] 15 Apr 21<span class="hljs-function">:11</span><span class="hljs-function">:30.443</span> * DB loaded from disk: 0.000 seconds<br>[3204] 15 Apr 21<span class="hljs-function">:11</span><span class="hljs-function">:30.443</span> * The server is now ready to accept connections on port 6379<br>[3204] 15 Apr 21<span class="hljs-function">:12</span><span class="hljs-function">:39.581</span> <span class="hljs-comment"># User requested shutdown...</span><br>[3204] 15 Apr 21<span class="hljs-function">:12</span><span class="hljs-function">:39.581</span> * Saving the final RDB snapshot before exiting.<br>[3204] 15 Apr 21<span class="hljs-function">:12</span><span class="hljs-function">:39.581</span> * DB saved on disk<br>[3204] 15 Apr 21<span class="hljs-function">:12</span><span class="hljs-function">:39.581</span> <span class="hljs-comment"># Redis is now ready to exit, bye bye...</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>这里有一句<code>Saving the final RDB snapshot before exiting.</code></p>
<p>Redis将文件保存在运行目录中</p>
<p>我这是<code>windows</code>系统，如果是<code>linux</code>则使用<code>ls</code>、<code>ll</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415211506657.png" alt="image-20240415211506657" data-caption="image-20240415211506657" loading="lazy"><br>但是我们担心如果突然宕机还没来得及持久化怎么办，我们更加希望隔一段时间持久化一次</p>
<p>Redis内部有触发RDB的机制，可以在redis.conf文件中找到， 格式如下:</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 900秒内，如果至少一个key被修改，则执行bgsave</span><br><span class="hljs-comment"># 如果是save &quot;&quot; 则表示禁用Redis</span><br><span class="hljs-attr">save</span> <span class="hljs-string">900 1</span><br><span class="hljs-attr">save</span> <span class="hljs-string">300 10</span><br><span class="hljs-attr">save</span> <span class="hljs-string">60 10000</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>RDB的其他配置也可以在配置文件中设置</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 是否压缩，建议不开启，压缩也会消耗CPU，磁盘不值钱</span><br><span class="hljs-attr">rdbcompression</span> <span class="hljs-string">yes</span><br><span class="hljs-comment"># RDB文件名称</span><br><span class="hljs-attr">dbfilename</span> <span class="hljs-string">dump.rdb</span><br><span class="hljs-comment"># 文件保存的路径</span><br><span class="hljs-attr">dir</span> <span class="hljs-string">./</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>bgsave开始时会<code>fork</code>主进程得到子进程，子进程共享主进程的内存数据。完成fork后读取内存数据并写入RDB文件。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415213015095.png" alt="image-20240415213015095" data-caption="image-20240415213015095" loading="lazy"><br>fork采用的是copy-on-write技术:<br>当主进程执行读操作时,访问共享内存;<br>当主进程执行写操作时，则会拷贝一份数据，执行写操作。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415213600960.png" alt="image-20240415213600960" data-caption="image-20240415213600960" loading="lazy"></p>
</blockquote>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>RDB方式bgsave的基本流程?</p>
<ol>
<li>fork主进程得到一-个子进程，共享内存空间</li>
<li>子进程读取内存数据并写入新的RDB文件</li>
<li>用新RDB文件替换旧的RDB文件。<br>RDB会在什么时候执行? save 60 1000代表什么含义?</li>
<li>默认是服务停止时。</li>
<li>代表60秒内至少执行1000次修改则触发RDB<br>RDB的缺点?</li>
<li>RDB执行间隔时间长，两次RDB之间写入数据有丟失的风险</li>
<li>fork子进程、压缩、写出RDB文件都比较耗时</li>
</ol>
<h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><blockquote>
<p>AOF全称为Append Only File ( 追加文件)。Redis处理的每-一个写命令都会记录在AOF文件，可以看做是命令日志文件。</p>
<p>如果需要恢复数据，将日志文件里的命令全部执行一遍即可<br>AOF默认是关闭的，需要修改redis.conf配置文件来开启AOF:</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 是否开启A0F功能，默认是no </span><br><span class="hljs-attr">appendonly</span> <span class="hljs-string">no</span><br><span class="hljs-comment"># AOF文件的名称</span><br><span class="hljs-attr">appendfilename</span> <span class="hljs-string">&quot;appendonly.aof&quot;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>AOF的命令记录的频率也可以通过redis.conf文件来配:</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 表示每执行一次写命令，立即记录到AOF文件</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">always</span><br><span class="hljs-comment"># 写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">everysec</span><br><span class="hljs-comment"># 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">no</span><br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415214253132.png" alt="image-20240415214253132" data-caption="image-20240415214253132" loading="lazy"><br>由于AOF记录的是命令操作，而不是直接记录值，所以会比RDB文件大很多<br>因为是记录命令, AOF文件会比RDB文件大的多。而且AOF会记录对同一个key的多次写操作，但只有最后一-次写操作才有意义。通过执行bgrewriteaof命令，可以让AOF文件执行重写功能，用最少的命令达到相同效果。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415214743582.png" alt="image-20240415214743582" data-caption="image-20240415214743582" loading="lazy"><br>Redis也会在<code>触发阈值</code>时自动去重写AOF文件。阈值也可以在redis.conf中配置: </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># AOF文件比上次文件增长超过多少百分比则触发重写</span><br><span class="hljs-attr">auto-aof-rewrite-percentage</span> <span class="hljs-string">100</span><br><span class="hljs-comment"># AOF文件体积最小多大以上才触发重写</span><br><span class="hljs-attr">auto-aof-rewrite-min-size</span> <span class="hljs-string">64mb</span><br></code></pre></td></tr></table></figure>
<p><code>RDB</code>和<code>AOF</code>各有自己的优缺点，如果对数据安全性要求较高,在实际开发中往往会结合两者来使用。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240415215054692.png" alt="image-20240415215054692" data-caption="image-20240415215054692" loading="lazy"></p>
<h2 id="Redis主从"><a href="#Redis主从" class="headerlink" title="Redis主从"></a>Redis主从</h2><blockquote>
<p>单节点Redis的并发能力是有上限的，要近一步提高Redis的并发能力，就需要搭建主从集群，实现读写分离。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416063931474.png" alt="image-20240416063931474" data-caption="image-20240416063931474" loading="lazy"><br>开启RDB，关闭AOF</p>
<p>一主二从 A（B、C） 一个master两个slave&#x2F;replica</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 禁用RDB</span><br><span class="hljs-comment"># save &quot;&quot;</span><br><span class="hljs-attr">save</span> <span class="hljs-string">900 1</span><br><span class="hljs-attr">save</span> <span class="hljs-string">300 10</span><br><span class="hljs-attr">save</span> <span class="hljs-string">60 10000</span><br><span class="hljs-attr">appendonly</span> <span class="hljs-string">no</span><br></code></pre></td></tr></table></figure>
<h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><p>windows配置redis集群查看<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41846320/article/details/83753667">该博客</a></p>
<blockquote>
<p>主节点<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416070837220.png" alt="image-20240416070837220" data-caption="image-20240416070837220" loading="lazy"><br>从节点<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416070901240.png" alt="image-20240416070901240" data-caption="image-20240416070901240" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416070908369.png" alt="image-20240416070908369" data-caption="image-20240416070908369" loading="lazy"><br>从节点只能读数据，不能写数据<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416071004714.png" alt="image-20240416071004714" data-caption="image-20240416071004714" loading="lazy"><br>关闭主节点后，从节点的状态<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416071252667.png" alt="image-20240416071252667" data-caption="image-20240416071252667" loading="lazy"><br>重启主节点后，从节点的状态<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240416071420341.png" alt="image-20240416071420341" data-caption="image-20240416071420341" loading="lazy"></p>
</blockquote>
<h3 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h3><blockquote>
<p>接下来演示<code>docker配置redis集群</code>，参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43025151/article/details/134205482">博客链接</a><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421125052157.png" alt="image-20240421125052157" data-caption="image-20240421125052157" loading="lazy"><br>可以看到本地已经拉取了<code>redis</code>镜像<br>在<code>/root</code>目录下新建一个<code>redis.conf</code>文件和<code>data</code>目录<br><code>data</code>用以存储redis持久化文件，<code>redis.conf</code>作为redis的配置文件，这里配置<code>主从集群</code>，所以需要新建三个<code>conf</code>和<code>data</code>，目录及文件如下<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421135026402.png" alt="image-20240421135026402" data-caption="image-20240421135026402" loading="lazy"><br><code>redis-7001.conf</code>下载<a target="_blank" rel="noopener" href="https://gitee.com/tongstyle/blog-img/raw/master/img/redis-7001.conf">链接</a></p>
<p>启动容器，这里使用<code>7001</code>作为端口号</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name redis-master \<br>-v /root/redis/redis-7001.conf:/etc/redis/redis.conf \<br>-v /root/redis/data:/data \<br>-dp 7001:6379 \<br>redis:latest \<br>redis-server /etc/redis/redis.conf<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421133144513.png" alt="image-20240421133144513" data-caption="image-20240421133144513" loading="lazy"></p>
<blockquote>
<p>配置文件直接复制7001即可，反正将来也是以容器为单位启动，不会造成端口冲突，但是虚拟机(宿主机)的端口映射则不能都写7001了</p>
<p>7001端口已经被<code>master</code>占据了，剩下两个<code>slave</code>使用<code>7002、7003</code></p>
<p>修改对应的持久化目录<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421140154283.png" alt="image-20240421140154283" data-caption="image-20240421140154283" loading="lazy"><br><code>redis-7001.conf</code>文件中添加如下配置</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">slave-announce-ip 192.168.56.10<br>slave-announce-port 7001<br></code></pre></td></tr></table></figure>
<p><code>redis-7002.conf、redis-7003.conf</code>也是一样</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">slave-announce-ip 192.168.56.10<br>slave-announce-port 7002<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">slave-announce-ip 192.168.56.10<br>slave-announce-port 7003<br></code></pre></td></tr></table></figure>
<blockquote>
<p>启动<code>slave</code></p>
<p>在启动 slave 的<code>命令</code>中需要指出其 <code>slaveof</code> 于谁，这种是<code>临时方案</code>，重启失效</p>
<p><code>永久方案</code>是在conf文件中配置<code>slaveof &lt;master_ip&gt; &lt;master_port&gt;</code></p>
<p>redis5.0之后新增<code>replicaof</code>效果和<code>slaveof</code> 一样</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name redis-slave1 \<br>-v /root/redis/redis-7002.conf:/etc/redis/redis.conf \<br>-v /root/redis/data:/data \<br>-dp 7002:6379 \<br>redis:latest \<br>redis-server /etc/redis/redis.conf --slaveof 192.168.56.10 7001<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name redis-slave2 \<br>-v /root/redis/redis-7003.conf:/etc/redis/redis.conf \<br>-v /root/redis/data:/data \<br>-dp 7003:6379 \<br>redis:latest \<br>redis-server /etc/redis/redis.conf --slaveof 192.168.56.10 7001<br></code></pre></td></tr></table></figure>
<blockquote>
<p>关系查看</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it redis-master redis-cli info replication<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421142455620.png" alt="image-20240421142455620" data-caption="image-20240421142455620" loading="lazy"></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it redis-slave1 redis-cli info replication<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it redis-slave2 redis-cli info replication<br></code></pre></td></tr></table></figure>
<blockquote>
<p>slave1<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421142858831.png" alt="image-20240421142858831" data-caption="image-20240421142858831" loading="lazy"><br>slave2<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421142916435.png" alt="image-20240421142916435" data-caption="image-20240421142916435" loading="lazy"><br>此时停止master</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker stop redis-master<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421143048582.png" alt="image-20240421143048582" data-caption="image-20240421143048582" loading="lazy"></p>
<blockquote>
<p>尝试向slave中写入数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it redis-slave1 /bin/bash<br>redis-cli<br><span class="hljs-built_in">set</span> name tigerhhzz11<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421143606124.png" alt="image-20240421143606124" data-caption="image-20240421143606124" loading="lazy"></p>
<blockquote>
<p>向master中写入数据，在slave中读出<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421143752145.png" alt="image-20240421143752145" data-caption="image-20240421143752145" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421143738686.png" alt="image-20240421143738686" data-caption="image-20240421143738686" loading="lazy"></p>
</blockquote>
<h2 id="数据同步原理"><a href="#数据同步原理" class="headerlink" title="数据同步原理"></a>数据同步原理</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>主从第一次同步是<code>全量同步</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421144659573.png" alt="image-20240421144659573" data-caption="image-20240421144659573" loading="lazy"></p>
<blockquote>
<p>master怎么知道slave是否是第一次请求数据呢？这里会用到两个很重要的概念:</p>
<p><code>Replication id</code>:简称replid, 是数据集的标记，id一致则说明是同一数据集。每一个master都有唯一的replid,slave则会<code>继承</code>master节点的replid</p>
<p><code>offset</code>:偏移量,随着记录在repl_baklog 中的数据增多而逐渐增大。slave完成同步时也会记录当前同步的offset。如果slave的offset小于master的offset,说明slave数据落后于master,需要更新。</p>
<p>因此slave做数据同步,必须向master声明自己的<code>replication id</code>和<code>offset</code>, master才可以判断到底需要同步哪些数据</p>
<p>master需要根据<code>replid</code>判断slave节点是否是第一次来做数据同步，<code>replid</code>不一致就是第一次做数据同步<br><strong>查看容器日志</strong><br>可以查看容器日志，数据同步步骤请看总结</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker logs redis-master <br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker logs redis-slave1<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker logs redis-slave2<br></code></pre></td></tr></table></figure>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ol>
<li>slave节点请求增量同步</li>
<li>master节点判断replid,发现不一致, 拒绝增量同步</li>
<li>master将完整内存数据生成RDB，发送RDB到slave</li>
<li>slave清空本地数据，加载master的RDB</li>
<li>master将RDB期间的命令记录在repl_baklog,并持续将log中的命令发送给slave</li>
<li>slave执行接收到的命令，保持与master之间的同步</li>
</ol>
<h3 id="增量同步"><a href="#增量同步" class="headerlink" title="增量同步"></a>增量同步</h3><p>主从第一次同步是<code>全量同步</code>,但如果slave重启后同步，则执行<code>增量同步</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421150448468.png" alt="image-20240421150448468" data-caption="image-20240421150448468" loading="lazy"></p>
<blockquote>
<p><code>repl_baklog</code>本质是一个<code>环形数组</code>，slave与master数据之间的差异&#x3D;master-slave（图中红色线段的部分）</p>
<p>当数据记完一圈后，会覆盖掉上次的内容继续往下记载，slave也会继续跟着master往后同步数据</p>
<p>但是这样就存在<code>无法进行增量同步</code>的情况</p>
<p><code>repl_baklog</code>大小有上限，写满后会覆盖最早的数据。如果slave断开时间过久，导致数据被覆盖,则无法实现增量同步，只能再次全量同步。</p>
<p>如果master已经覆盖掉上一次的内容，开始记入第二圈的数据，而slave由于某种原因宕机，导致master覆盖的数据并没有同步完成<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421151021414.png" alt="image-20240421151021414" data-caption="image-20240421151021414" loading="lazy"><br>此时就只能做全量同步了，无法进行增量同步</p>
<p>应当尽可能的减少全量同步，因为它的性能较差。或许可以进一步优化全量同步的性能</p>
<p>可以从以下几个方面来优化Redis主从就集群:</p>
<ol>
<li><p>在master中配置repl-diskless-sync yes启用无磁盘复制，避免全量同步时的磁盘IO。</p>
<p>(避免磁盘读写，采用网络传输，适用于磁盘较慢、网络较快的情况)</p>
</li>
<li><p>Redis单节点上的内存占用不要太大，减少RDB导致的过多磁盘IO</p>
</li>
<li><p>适当提高repl_baklog的大小，发现slave宕机时尽快实现故障恢复,尽可能避免全量同步</p>
</li>
<li><p>限制一个master上的slave节点数量，如果实在是太多slave,则可以采用<code>主-从-从</code>链式结构，减少master压力<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/image-20240421151554098.png" alt="image-20240421151554098" data-caption="image-20240421151554098" loading="lazy"></p>
</li>
</ol>
</blockquote>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>简述全量同步和增量同步区别?</p>
<ol>
<li>全量同步: master将完整 内存数据生成RDB，发送RDB到slave。后续命令则记录在repl_ baklog, 逐个发送给slave。</li>
<li>增量同步: slave提交自己的offset到master, master获取repl_ baklog中 从offset之后的命令给slave<br>什么时候执行全量同步?</li>
<li>slave节点第一次连接master节点时</li>
<li>slave节点断开时间太久，repl_baklog中的offset已经被覆盖时<br>什么时候执行增量同步?<br>slave节点断开又恢复,并且在repl_baklog中 能找到offset时</li>
</ol>
<h2 id="Redis哨兵"><a href="#Redis哨兵" class="headerlink" title="Redis哨兵"></a>Redis哨兵</h2><h3 id="哨兵的作用和工作原理"><a href="#哨兵的作用和工作原理" class="headerlink" title="哨兵的作用和工作原理"></a>哨兵的作用和工作原理</h3><blockquote>
<p>slave节点宕机恢复后可以找master节点同步数据，如果<code>master</code>节点<code>宕机</code>怎么办?</p>
<p>master节点如果宕机，那么此时用户无法进行<code>redis数据写入</code>的操作，可用性下降了</p>
<p>我们需要去监控集群中的节点状态，在master节点挂掉之后，选一个新的master，增进挂掉的master重启后，作为slave<br>Redis提供了哨兵(Sentinel) 机制来实现主从集群的自动故障恢复。哨兵的结构和作用如下:<br><strong>监控</strong>: Sentinel 会不断检查您的master和slave是否按预期工作<br><strong>自动故障恢复</strong>:如果master故障，Sentinel会将一个slave提升为master。当故障实例恢复后也以新的master为主<br><strong>通知</strong>: Sentinel充当Redis客户端的服务发现来源，当集群发生故障转移时，会将最新信息推送给Redis的客户端<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212010655.png" alt="image-20240421195306145" data-caption="image-20240421195306145" loading="lazy"></p>
</blockquote>
<h4 id="服务状态监控"><a href="#服务状态监控" class="headerlink" title="服务状态监控"></a>服务状态监控</h4><p>Sentinel基于心跳机制监测服务状态,每隔1秒向集群的每个实例发送ping命令:</p>
<ul>
<li>主观下线:如果某sentinel节点发现某实例未在规定时间响应，则认为该实例主观下线。</li>
<li>客观下线:若超过指定数量( quorum)的sentinel都认为该实例主观下线，则该实例客观下线。quorum值最好超过Sentinel实例数量的一半。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212010983.png" alt="image-20240421200042664" data-caption="image-20240421200042664" loading="lazy"></li>
</ul>
<h4 id="选举新的master"><a href="#选举新的master" class="headerlink" title="选举新的master"></a>选举新的master</h4><p>一旦发现master故障，sentinel需 要在salve中选择- -一个作为新的master,选择依据是这样的:</p>
<ol>
<li>首先会判断slave节点与master节点断开时间长短，如果超过指定值( down-after-milliseconds * 10)则会排除该slave节点</li>
<li>然后判断slave节点的slave-priority值, 越小优先级越高，如果是0则永不参与选举</li>
<li>如果slave-prority一样，则判断slave节点的effset值， 越大说明数据越新，优先级越高</li>
<li>最后是判断slave节点的运行id大小，越小优先级越高。</li>
</ol>
<h4 id="实现故障转移"><a href="#实现故障转移" class="headerlink" title="实现故障转移"></a>实现故障转移</h4><p>当选中了其中一个slave为新的master后(例如slave1)，故障的转移的步骤如下:</p>
<ol>
<li>sentinel给 备选的slave1节点发送<code>slaveof no one</code>命令,让该节点成为master</li>
<li>sentinel给所有其它slave发送<code>slaveof 192.168.150.101 7002</code>命令，让这些slave成为新master的从节点，开始从新的master上同步数据。</li>
<li>最后，sentinel将故障节点标记为slave,当故障节点恢复后会自动成为新的master的slave节点<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212017069.png" alt="image-20240421201712016" data-caption="image-20240421201712016" loading="lazy"></li>
</ol>
<h4 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h4><p>Sentinel的三个作用是什么?</p>
<ol>
<li>监控</li>
<li>故障转移</li>
<li>通知<br>Sentinel如何判断一个redis实例是否健康?</li>
<li>每隔1秒发送一次ping命令，如果超过一定时间没有 相向则认为是主观下线</li>
<li>如果大多数sentinel都认为实例主观下线，则判定服务下线<br>故障转移步骤有哪些?</li>
<li>首先选定一个slave作为新的master,执行slaveof no one</li>
<li>然后让所有节点都执行slaveof 新master</li>
<li>修改故障节点配置，添加slaveof 新master</li>
</ol>
<h3 id="搭建哨兵集群"><a href="#搭建哨兵集群" class="headerlink" title="搭建哨兵集群"></a>搭建哨兵集群</h3><blockquote>
<p>手动创建<code>sentinel</code>下的<code>s1、s2、s3</code>，然后配置<code>sentinel.conf</code>文件<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212101080.png" alt="image-20240421210126992" data-caption="image-20240421210126992" loading="lazy"></p>
</blockquote>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><code class="hljs crmsh">port <span class="hljs-number">27001</span><br>sentinel announce-ip <span class="hljs-number">192.168</span>.<span class="hljs-number">56.10</span><br>sentinel <span class="hljs-literal">monitor</span> redis-<span class="hljs-keyword">master</span> <span class="hljs-title">192</span>.<span class="hljs-number">168.56</span>.<span class="hljs-number">10</span> <span class="hljs-number">7001</span> <span class="hljs-number">2</span><br>sentinel down-after-milliseconds redis-<span class="hljs-keyword">master</span> <span class="hljs-title">5000</span><br>sentinel failover-timeout redis-<span class="hljs-keyword">master</span> <span class="hljs-title">60000</span><br></code></pre></td></tr></table></figure>
<p>解读：</p>
<ul>
<li><code>port 27001</code>：是当前sentinel实例的端口</li>
<li><code>sentinel monitor redis-master192.168.56.10 7001 2</code>：指定主节点信息<ul>
<li><code>redis-master</code>：主节点名称，自定义，任意写</li>
<li><code>192.168.56.10 7001</code>：主节点的ip和端口</li>
<li><code>2</code>：选举master时的quorum值<blockquote>
<p>启动<code>sentinel</code>的<code>jar</code>包<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212106197.png" alt="image-20240421210646154" data-caption="image-20240421210646154" loading="lazy"><br>启动三个sentinel容器</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-1 \<br>-v /root/redis/sentinel/sentinel1.conf:/etc/redis/sentinel.conf \<br>-dp 27001:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-2 \<br>-v /root/redis/sentinel/sentinel2.conf:/etc/redis/sentinel.conf \<br>-dp 27002:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-3 \<br>-v /root/redis/sentinel/sentinel3.conf:/etc/redis/sentinel.conf \<br>-dp 27003:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<blockquote>
<p>关系查看</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it sentinel-1 redis-cli -h 192.168.56.10 -p 27001 info sentinel<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212224751.png" alt="image-20240421222424683" data-caption="image-20240421222424683" loading="lazy"><blockquote>
<p>注意目录对应关系，如果在运行容器时，将<code>conf</code>路径写错了，则可能出现如下情况<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404212227284.png" alt="image-20240421222751214" data-caption="image-20240421222751214" loading="lazy"><br>此时停止<code>redis-master</code>节点，查看<code>sentinel</code>日志</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker stop redis-master <br>docker logs sentinel-1<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220644926.png" alt="image-20240422064431835" data-caption="image-20240422064431835" loading="lazy"><blockquote>
<p>解决办法，直接挂载整个目录，而不是只挂载某个conf文件，注意<code>权限</code>设置为777，目录和文件都要设置</p>
<p><code>chmod 777 -R &lt;file&gt;</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220734941.png" alt="image-20240422073450817" data-caption="image-20240422073450817" loading="lazy"></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-1 \<br>-v /root/redis/sentinel/s1:/etc/redis \<br>-dp 27001:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-2 \<br>-v /root/redis/sentinel/s2:/etc/redis \<br>-dp 27002:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-3 \<br>-v /root/redis/sentinel/s3:/etc/redis \<br>-dp 27003:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<blockquote>
<p>但是日志打印还有一个警告<br><strong>1:X 21 Apr 2024 23:33:24.072 # WARNING: The TCP backlog setting of 511 cannot be enforced because &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn is set to the lower value of 128.</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220736397.png" alt="image-20240422073645324" data-caption="image-20240422073645324" loading="lazy"><br>解决办法</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">vim /etc/sysctl.conf<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220740344.png" alt="image-20240422074046273" data-caption="image-20240422074046273" loading="lazy"><blockquote>
<p>文件新增如下内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf">net.core.somaxconn = 1024<br>vm.overcommit_memory = 1<br></code></pre></td></tr></table></figure>
<blockquote>
<p>添加完成后，刷新内核参数，立即生效</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">/sbin/sysctl -p<br></code></pre></td></tr></table></figure>
<blockquote>
<p>但是我这里并没有生效，所以采用如下方法</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-1 --sysctl net.core.somaxconn=1024 \<br>-v /root/redis/sentinel/s1:/etc/redis \<br>-dp 27001:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-2 --sysctl net.core.somaxconn=1024 \<br>-v /root/redis/sentinel/s2:/etc/redis \<br>-dp 27002:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name sentinel-3 --sysctl net.core.somaxconn=1024 \<br>-v /root/redis/sentinel/s3:/etc/redis \<br>-dp 27003:26379 \<br>redis:latest \<br>redis-sentinel /etc/redis/sentinel.conf<br></code></pre></td></tr></table></figure>
<blockquote>
<p>问题已经解决<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220751093.png" alt="image-20240422075110021" data-caption="image-20240422075110021" loading="lazy"><br>停掉<code>redis-master</code></p>
<p>查看sentinel日志</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> logs sentinel-<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220800499.png" alt="image-20240422080023345" data-caption="image-20240422080023345" loading="lazy"><blockquote>
<p>查看redis节点状态，发现<code>7003</code>确实成为<code>master</code>了</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it redis-slave2 redis-cli info replication<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220758218.png" alt="image-20240422075815065" data-caption="image-20240422075815065" loading="lazy"><blockquote>
<p>重启<code>7001</code>，发现原来的<code>master</code>变成<code>slave</code>了<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220802251.png" alt="image-20240422080253175" data-caption="image-20240422080253175" loading="lazy"></p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="RedisTemplate的哨兵模式"><a href="#RedisTemplate的哨兵模式" class="headerlink" title="RedisTemplate的哨兵模式"></a>RedisTemplate的哨兵模式</h3><blockquote>
<p>新建项目，导入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">logging:</span><br>    <span class="hljs-attr">level:</span><br>      <span class="hljs-attr">io.lettuce.core:</span> <span class="hljs-string">debug</span><br>    <span class="hljs-attr">pattern:</span><br>        <span class="hljs-attr">dateformat:</span> <span class="hljs-string">yyyy-MM-dd</span> <span class="hljs-string">HH:mm:ss:SSS</span><br><span class="hljs-attr">spring:</span><br>    <span class="hljs-attr">data:</span><br>        <span class="hljs-attr">redis:</span><br>            <span class="hljs-attr">sentinel:</span><br>                <span class="hljs-comment"># 指定master 节点名称</span><br>                <span class="hljs-attr">master:</span> <span class="hljs-string">mymaster</span><br>                <span class="hljs-comment"># 指定redis-sentinel集群信息</span><br>                <span class="hljs-attr">nodes:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:27001</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:27002</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:27003</span><br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TestController</span><span class="hljs-params">(StringRedisTemplate redisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;<br>    &#125;<br>    <span class="hljs-meta">@GetMapping(&quot;/get/&#123;key&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String key)</span> &#123;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForValue().get(key);<br>    &#125;<br>    <span class="hljs-meta">@GetMapping(&quot;/set/&#123;key&#125;/&#123;value&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">set</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String key,<span class="hljs-meta">@PathVariable</span> String value)</span> &#123;<br>        redisTemplate.opsForValue().set(key,value);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>配置<code>Redis</code>读写分离</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisDemoApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(RedisDemoApplication.class, args);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 配置Redis的读写策略，实现master写入、slave读取(读写分离</span><br><span class="hljs-comment">     * MASTER:从主节点读取</span><br><span class="hljs-comment">     * MASTER_PREFERRED: 优先从master节点读取，master不可用才读取replica</span><br><span class="hljs-comment">     * REPLICA:从slave (replica) 节点读取</span><br><span class="hljs-comment">     * REPLICA_PREFERRED: 优先从slave (replica) 节点读取，所有的slave都不可用才读取master)</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> LettuceClientConfigurationBuilderCustomizer&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> LettuceClientConfigurationBuilderCustomizer <span class="hljs-title function_">configurationBuilderCustomizer</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> clientConfigurationBuilder -&gt; clientConfigurationBuilder.readFrom(ReadFrom.REPLICA_PREFERRED);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220822902.png" alt="image-20240422082247840" data-caption="image-20240422082247840" loading="lazy"></p>
<blockquote>
<p>报错<code>io.lettuce.core.RedisCommandExecutionException: ERR No such master with that name</code></p>
<p>名称改为<code>redis-master</code>，与<code>sentinel.conf</code>文件中的配置保持一致<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220824380.png" alt="image-20240422082422321" data-caption="image-20240422082422321" loading="lazy"></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">logging:</span><br>    <span class="hljs-attr">level:</span><br>      <span class="hljs-attr">io.lettuce.core:</span> <span class="hljs-string">debug</span><br>    <span class="hljs-attr">pattern:</span><br>        <span class="hljs-attr">dateformat:</span> <span class="hljs-string">yyyy-MM-dd</span> <span class="hljs-string">HH:mm:ss:SSS</span><br><span class="hljs-attr">spring:</span><br>    <span class="hljs-attr">data:</span><br>        <span class="hljs-attr">redis:</span><br>            <span class="hljs-attr">sentinel:</span><br>                <span class="hljs-comment"># 指定master 节点名称</span><br>                <span class="hljs-attr">master:</span> <span class="hljs-string">redis-master</span><br>                <span class="hljs-comment"># 指定redis-sentinel集群信息</span><br>                <span class="hljs-attr">nodes:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:27001</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:27002</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:27003</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>访问<code>http://localhost:8080/get/name</code>(得有一个叫name的数据)<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220825414.png" alt="image-20240422082543326" data-caption="image-20240422082543326" loading="lazy"><br><strong>可以看到这里通过7002来获取数据</strong><br>访问<code>http://localhost:8080/set/name/333</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220826733.png" alt="image-20240422082647557" data-caption="image-20240422082647557" loading="lazy"><br><strong>可以看到这里通过7003来设置数据</strong><br>重启<code>redis-slave2</code></p>
</blockquote>
<figure class="highlight maxima"><table><tr><td class="code"><pre><code class="hljs maxima">docker <span class="hljs-built_in">restart</span> redis-slave2<br></code></pre></td></tr></table></figure>
<blockquote>
<p>此时<code>slave1(7002)</code>被选为master<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220830568.png" alt="image-20240422083027509" data-caption="image-20240422083027509" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220831656.png" alt="image-20240422083109475" data-caption="image-20240422083109475" loading="lazy"><br><code>7003</code>为<code>replica</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404220831464.png" alt="image-20240422083125383" data-caption="image-20240422083125383" loading="lazy"><br>使用idea连接虚拟机</p>
<p><code>Deployment-&gt;Configuration</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222011412.png" alt="image-20240422201104329" data-caption="image-20240422201104329" loading="lazy"><br>新建<code>SFTP</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222011833.png" alt="image-20240422201138710" data-caption="image-20240422201138710" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222015126.png" alt="image-20240422201502055" data-caption="image-20240422201502055" loading="lazy"><br>查看虚拟机文件</p>
<p><code>Deployment-&gt;Browse Remote Host</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222015689.png" alt="image-20240422201551614" data-caption="image-20240422201551614" loading="lazy"><br>右侧就可以看到虚拟机的文件信息了<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222016266.png" alt="image-20240422201634100" data-caption="image-20240422201634100" loading="lazy"><br>打开命令窗口</p>
<p>点击<code>Tools-&gt;Start SSH Session</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222017371.png" alt="image-20240422201705287" data-caption="image-20240422201705287" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222017656.png" alt="image-20240422201727483" data-caption="image-20240422201727483" loading="lazy"></p>
</blockquote>
<h2 id="Redis分片集群"><a href="#Redis分片集群" class="headerlink" title="Redis分片集群"></a>Redis分片集群</h2><blockquote>
<p>我们知道单节点的Redis内存不要设置过高，在内存的持久化或者数据同步的时候会导致大量的IO，性能会下降</p>
<p>但是如果内存降低之后无法存储海量的数据怎么办？</p>
<p>解决了高并发读，高并发写怎么解决？</p>
</blockquote>
<h3 id="分片集群结构"><a href="#分片集群结构" class="headerlink" title="分片集群结构"></a>分片集群结构</h3><p>主从和哨兵可以解决高可用、高并发读的问题。但是依然有两个问题没有解决:</p>
<ul>
<li>海量数据存储问题</li>
<li>高并发写的问题<br>使用分片集群可以解决.上述问题，分片集群特征:</li>
<li>集群中有多个master,每个master保存不同数据</li>
<li>每个master都可以有多个slave节点</li>
<li>master之间通过ping监测彼此健康状态</li>
<li>客户端请求可以访问集群任意节点，最终都会被转发到正确节点<blockquote>
<p>此时不再需要哨兵机制了，<code>master</code>节点之间可以互相监控各自的状态</p>
<p>集群结构如下表所示</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>角色</th>
<th>容器名称</th>
<th>网络模式</th>
<th>地址及端口</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>master</td>
<td>master-cluster-1</td>
<td>host</td>
<td>192.168.56.10:8001</td>
</tr>
<tr>
<td>2</td>
<td>master</td>
<td>master-cluster-2</td>
<td>host</td>
<td>192.168.56.10:8002</td>
</tr>
<tr>
<td>3</td>
<td>master</td>
<td>master-cluster-3</td>
<td>host</td>
<td>192.168.56.10:8003</td>
</tr>
<tr>
<td>4</td>
<td>slave</td>
<td>slave-cluster-1</td>
<td>host</td>
<td>192.168.56.10:9001</td>
</tr>
<tr>
<td>5</td>
<td>slave</td>
<td>slave-cluster-2</td>
<td>host</td>
<td>192.168.56.10:9002</td>
</tr>
<tr>
<td>6</td>
<td>slave</td>
<td>slave-cluster-3</td>
<td>host</td>
<td>192.168.56.10:9003</td>
</tr>
<tr>
<td>在<code>/root/redis-cluster</code>下新建配置文件<code>redis.conf</code></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>并打开以下两处的注释</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 开启 cluster 功能，即分布式系统功能</span><br><span class="hljs-attr">cluster-enabled</span> <span class="hljs-string">yes</span><br><span class="hljs-comment"># 指定其需要的配置文件名称</span><br><span class="hljs-attr">cluster-config-file</span> <span class="hljs-string">nodes-6379.conf</span><br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222048262.png" alt="image-20240422204825169" data-caption="image-20240422204825169" loading="lazy"><blockquote>
<p>重命名<code>redis.conf</code>为<code>redis1.conf</code>，并复制成其他五份<code>redis2.conf、redis3.conf、redis4.conf、redis5.conf、redis6.conf</code></p>
<p>这6份配置文件内容完全相同</p>
<p>更改文件之后记得上传<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222051246.png" alt="image-20240422205154155" data-caption="image-20240422205154155" loading="lazy"><br>停止之前运行的<code>redis、sentinel</code>容器</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker stop redis-master redis-slave1 redis-slave2 sentinel-1 sentinel-2 sentinel-3<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222053908.png" alt="image-20240422205342819" data-caption="image-20240422205342819" loading="lazy"><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name master-cluster-1 \<br>--network host \<br>-v /root/redis-cluster/redis1.conf:/etc/redis/redis.conf \<br>-v /root/redis-cluster/data/8001:/data \<br>-d redis:latest redis-server /etc/redis/redis.conf \<br>--port 8001<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name master-cluster-2 \<br>--network host \<br>-v /root/redis-cluster/redis2.conf:/etc/redis/redis.conf \<br>-v /root/redis-cluster/data/8002:/data \<br>-d redis:latest redis-server /etc/redis/redis.conf \<br>--port 8002<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name master-cluster-3 \<br>--network host \<br>-v /root/redis-cluster/redis3.conf:/etc/redis/redis.conf \<br>-v /root/redis-cluster/data/8003:/data \<br>-d redis:latest redis-server /etc/redis/redis.conf \<br>--port 8003<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name slave-cluster-1 \<br>--network host \<br>-v /root/redis-cluster/redis4.conf:/etc/redis/redis.conf \<br>-v /root/redis-cluster/data/9001:/data \<br>-d redis:latest redis-server /etc/redis/redis.conf \<br>--port 9001<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name slave-cluster-2 \<br>--network host \<br>-v /root/redis-cluster/redis5.conf:/etc/redis/redis.conf \<br>-v /root/redis-cluster/data/9002:/data \<br>-d redis:latest redis-server /etc/redis/redis.conf \<br>--port 9002<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name slave-cluster-3 \<br>--network host \<br>-v /root/redis-cluster/redis6.conf:/etc/redis/redis.conf \<br>-v /root/redis-cluster/data/9003:/data \<br>-d redis:latest redis-server /etc/redis/redis.conf \<br>--port 9003<br></code></pre></td></tr></table></figure>
<blockquote>
<p>6 个节点启动后，它们仍是 6 个独立的 Redis，通过 <code>redis-cli --cluster create</code> 命令可将 6个节点创建为一个分布式系统。–cluster replicas 1 指定每个 master 会带有一个slave 副本。</p>
<p>所以前三个是<code>主</code>，后三个是<code>从</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it master-cluster-1 /bin/bash<br>redis-cli --cluster create --cluster-replicas 1 192.168.56.10:8001 192.168.56.10:8002 192.168.56.10:8003 192.168.56.10:9001 192.168.56.10:9002 192.168.56.10:9003<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222109918.png" alt="image-20240422210937770" data-caption="image-20240422210937770" loading="lazy"><blockquote>
<p>查看节点信息</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli -c -p 8003 cluster nodes<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404222116235.png" alt="image-20240422211623156" data-caption="image-20240422211623156" loading="lazy"><blockquote>
<p>这样就可以查看到节点的信息了</p>
</blockquote>
</li>
</ul>
<h3 id="散列插槽"><a href="#散列插槽" class="headerlink" title="散列插槽"></a>散列插槽</h3><p>Redis会把每一个master节 点映射到0~16383共16384个插槽(hashslot) 上，查看集群信息时就能看到:<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404232154657.png" alt="image-20240423215451539" data-caption="image-20240423215451539" loading="lazy"></p>
<blockquote>
<p>我们这里插槽分布如下</p>
<table>
<thead>
<tr>
<th>端口</th>
<th>插槽范围</th>
</tr>
</thead>
<tbody><tr>
<td>8001</td>
<td>0-5460</td>
</tr>
<tr>
<td>8002</td>
<td>5461-10922</td>
</tr>
<tr>
<td>8003</td>
<td>10923-16383</td>
</tr>
<tr>
<td>数据key不是与节点绑定,而是与插槽绑定。redis会根据key的有效部分计算插槽值，分两种情况:</td>
<td></td>
</tr>
</tbody></table>
</blockquote>
<ul>
<li>key中包含”{}”,且”{}”中至少包含1个字符， “{}”中的部分是有效部分</li>
<li>key中不包含”{}” ，整个key都是有效部分<br>例如: key是num,那么就根据num计算,如果是{itcast}num,则根据itcast计算。计算方式是利用CRC16算法得到一个hash值，然后对16384取余,得到的结果就是slot值。<blockquote>
<p>连接redis</p>
<p>注意这里一定要加<code>-c</code>，代表<code>集群模式</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli -c -p 8001<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404232210854.png" alt="image-20240423221028770" data-caption="image-20240423221028770" loading="lazy"><blockquote>
<p>redis会先算出插槽的值，最后找到对应的ip及端口，存储(获取)对应redis实例里的数据<br>Redis如何判断某个key应该在哪个实例?</p>
</blockquote>
</li>
</ul>
<ol>
<li>将16384个插槽分配到不同的实例</li>
<li>根据key的有 效部分计算哈希值，对16384取余余数作为插槽，寻找插槽所在实例即可<br>如何将同一类数据固定的保存在同一个Redis实例?<br>这一类数据使用相同的有效部分，例如key都以{typeld}为前缀，这样{a}name、{a}gender就能都存储在8003端口上</li>
</ol>
<h3 id="集群伸缩"><a href="#集群伸缩" class="headerlink" title="集群伸缩"></a>集群伸缩</h3><p>redis-cli –cluster提供了很多操作集群的命令，可以通过下面方式查看:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it master-cluster-1 /bin/bash<br>redis-cli --cluster <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404240738901.png" alt="image-20240424073841796" data-caption="image-20240424073841796" loading="lazy"></p>
<blockquote>
<p>向集群中添加一个新的master节点,并向其中存储num &#x3D; 10<br><strong>需求</strong><br>启动一个新的redis实例，端口为<code>8004</code><br>添加8004到之前的集群，并作为一个master节点<br>给8004节点分配插槽，使得num这个key可以存储到8004实例<br>分析，这里有几个关键点</p>
<ol>
<li>新增redis(master)实例到集群</li>
<li>分配插槽，使其能够存储<code>num</code>作为key(hashkey为<code>2765</code>)</li>
</ol>
<p>参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhoujinyi/p/11606935.html">博客</a><br><strong>复制一份<code>redis7.conf</code>文件</strong></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name master-cluster-4 \<br>--network host \<br>-v /root/redis-cluster/redis7.conf:/etc/redis/redis.conf \<br>-v /root/redis-cluster/data/8004:/data \<br>-d redis:latest redis-server /etc/redis/redis.conf \<br>--port 8004<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404240809279.png" alt="image-20240424080947181" data-caption="image-20240424080947181" loading="lazy"></p>
<blockquote>
<p>可以看到集群节点里并没有新建的<code>8004</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it master-cluster-1 /bin/bash<br>redis-cli -c -p 8003 cluster nodes<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242013465.png" alt="image-20240424082942970" data-caption="image-20240424082942970" loading="lazy"></p>
<blockquote>
<p>查看帮助文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli --cluster <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404240829903.png" alt="image-20240424082917801" data-caption="image-20240424082917801" loading="lazy"></p>
<blockquote>
<p>添加节点到集群</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli --cluster add-node 192.168.56.10:8004 192.168.56.10:8003<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242021196.png" alt="image-20240424202128104" data-caption="image-20240424202128104" loading="lazy"></p>
<blockquote>
<p>再次查看集群信息，可以看到<code>8004</code>是作为master的，但是并没有给它分配插槽</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli -c -p 8003 cluster nodes<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242021909.png" alt="image-20240424202157821" data-caption="image-20240424202157821" loading="lazy"></p>
<blockquote>
<p>接下来需要为<code>8004</code>分配至少<code>0~2765</code>的插槽，这里就直接分配前<code>3000</code>个了<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242044685.png" alt="image-20240424204432417" data-caption="image-20240424204432417" loading="lazy"><br>输入<code>yes</code></p>
<p>再次查看节点信息，可以看到已经分配了<code>0-2999</code>的插槽</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli -p 8004 cluster nodes<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242047718.png" alt="image-20240424204721576" data-caption="image-20240424204721576" loading="lazy"></p>
<blockquote>
<p>试一下获取<code>num</code>，可以看到是从8004上获取的数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli -c -p 8001<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242049543.png" alt="image-20240424204902473" data-caption="image-20240424204902473" loading="lazy"></p>
<blockquote>
<p><strong>练习</strong></p>
<p>删除8004节点<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242050050.png" alt="image-20240424205045856" data-caption="image-20240424205045856" loading="lazy"><br>转移插槽<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242053831.png" alt="image-20240424205333760" data-caption="image-20240424205333760" loading="lazy"><br>删除节点，可以看到<code>8004</code>节点已经被移除</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli --cluster del-node 192.168.56.10:8004 969b40741ba2c93557ff9013a774f98322f77ba0<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242055720.png" alt="image-20240424205522582" data-caption="image-20240424205522582" loading="lazy"></p>
<blockquote>
<p>删除容器<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242056356.png" alt="image-20240424205605167" data-caption="image-20240424205605167" loading="lazy"></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">rm</span> -f master-cluster-4<br>docker ps<br></code></pre></td></tr></table></figure>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><h4 id="自动故障转移"><a href="#自动故障转移" class="headerlink" title="自动故障转移"></a>自动故障转移</h4><blockquote>
<p>当集群中有一个master宕机会发生什么呢?<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242059554.png" alt="image-20240424205957402" data-caption="image-20240424205957402" loading="lazy"><br>重新启动8002<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242101468.png" alt="image-20240424210155393" data-caption="image-20240424210155393" loading="lazy"><br>可以看到<code>8002</code>变成了<code>master</code>，而<code>9002</code>变成了<code>slaver</code>，实现了自动故障转移</p>
</blockquote>
<h4 id="手动故障转移"><a href="#手动故障转移" class="headerlink" title="手动故障转移"></a>手动故障转移</h4><p>利用<code>cluster failover</code>命令可以手动让集群中的某个master宕机，切换到执行cluster failover命令的这个slave节点，实现无感知的数据迁移。其流程如下:<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242103921.png" alt="image-20240424210353844" data-caption="image-20240424210353844" loading="lazy"><br>手动的Failover支持三种不同模式:</p>
<ol>
<li>缺省:默认的流程，如图1~6步</li>
<li>force:省略了对offset的一致性校验</li>
<li>takeover:直接执行第5步，忽略数据一致性、忽略master状态和其它master的意见<blockquote>
<p><strong>练习</strong></p>
<p>手动故障转移，让<code>8002</code>重新变成master<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242109850.png" alt="image-20240424210932755" data-caption="image-20240424210932755" loading="lazy"></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">CLUSTER FAILOVER<br></code></pre></td></tr></table></figure>
<blockquote>
<p>看到<code>8002</code>重新变成master<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242110235.png" alt="image-20240424211012127" data-caption="image-20240424211012127" loading="lazy"></p>
</blockquote>
</li>
</ol>
<h3 id="RedisTemplate"><a href="#RedisTemplate" class="headerlink" title="RedisTemplate"></a>RedisTemplate</h3><p>RedisTemplate底层同样基于lettuce实现了分片集群的支持，而使用的步骤与哨兵模式基本一致:</p>
<ol>
<li>引入redis的starter依赖</li>
<li>配置分片集群地址</li>
<li>配置读写分离<br>与哨兵模式相比，其中只有分片集群的配置方式略有差异，如下:<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 配置分片集群</span><br><span class="hljs-attr">spring:</span><br>    <span class="hljs-attr">data:</span><br>        <span class="hljs-attr">redis:</span><br>            <span class="hljs-attr">cluster:</span><br>                <span class="hljs-comment"># 指定分片集群的每一个节点信息</span><br>                <span class="hljs-attr">nodes:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:8001</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:8002</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:8003</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:9001</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:9002</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:9003</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>访问<code>http://localhost:8080/get/a</code></p>
<p>查看日志，通过<code>9003</code>获取到<code>a</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242125244.png" alt="image-20240424212554166" data-caption="image-20240424212554166" loading="lazy"><br>查看节点信息</p>
<p><code>9003</code>的master是<code>8003</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">redis-cli -c -p 8003 cluster nodes<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242127034.png" alt="image-20240424212728958" data-caption="image-20240424212728958" loading="lazy"><blockquote>
<p>访问<code>http://localhost:8080/set/a/666</code></p>
<p>通过<code>8003</code>去set值<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://gitee.com/tongstyle/blog-img/raw/master/img/202404242128817.png" alt="image-20240424212846737" data-caption="image-20240424212846737" loading="lazy"></p>
</blockquote>
</li>
</ol>

    
  </article>

  
      

  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
</div>
  
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
    data-repo="nexmoe/nexmoe.com"
    data-repo-id="R_kgDOJI1XUA"
    data-category="General"
    data-category-id="DIC_kwDOJI1XUM4CU1nn"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>

      </div>
  
</div>
</div>
        <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis"><span class="toc-number">1.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E7%82%B9Redis%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">单点Redis的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">Redis持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RDB"><span class="toc-number">1.2.1.</span> <span class="toc-text">RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOF"><span class="toc-number">1.2.2.</span> <span class="toc-text">AOF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E4%B8%BB%E4%BB%8E"><span class="toc-number">1.3.</span> <span class="toc-text">Redis主从</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows"><span class="toc-number">1.3.1.</span> <span class="toc-text">windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux"><span class="toc-number">1.3.2.</span> <span class="toc-text">linux</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.</span> <span class="toc-text">数据同步原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.1.</span> <span class="toc-text">步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">1.4.2.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="toc-number">1.4.3.</span> <span class="toc-text">增量同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">1.4.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%93%A8%E5%85%B5"><span class="toc-number">1.5.</span> <span class="toc-text">Redis哨兵</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E7%9A%84%E4%BD%9C%E7%94%A8%E5%92%8C%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.1.</span> <span class="toc-text">哨兵的作用和工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">服务状态监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E4%B8%BE%E6%96%B0%E7%9A%84master"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">选举新的master</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">实现故障转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4"><span class="toc-number">1.5.2.</span> <span class="toc-text">搭建哨兵集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RedisTemplate%E7%9A%84%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.3.</span> <span class="toc-text">RedisTemplate的哨兵模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="toc-number">1.6.</span> <span class="toc-text">Redis分片集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.1.</span> <span class="toc-text">分片集群结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%A3%E5%88%97%E6%8F%92%E6%A7%BD"><span class="toc-number">1.6.2.</span> <span class="toc-text">散列插槽</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%BC%B8%E7%BC%A9"><span class="toc-number">1.6.3.</span> <span class="toc-text">集群伸缩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.6.4.</span> <span class="toc-text">故障转移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">自动故障转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">手动故障转移</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RedisTemplate"><span class="toc-number">1.6.5.</span> <span class="toc-text">RedisTemplate</span></a></li></ol></li></ol></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
    </div>
    <div id="nexmoe-search-space">
	<div class="search-container">
		<div class="search-header">
			<div class="search-input-container">
				<input
					class="search-input"
					type="text"
					placeholder="搜索"
					oninput="sinput();"
				/>
			</div>
			<a class="search-close" onclick="sclose();">×</a>
		</div>
		<div class="search-body"></div>
	</div>
</div>

    
    
</body>

</html>
