<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>多级缓存.html - 折影轻梦</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="折影轻梦,Mixcm,轻惋,觅漫者,小舒同学,Xiaoshu,Nexmoe,产品,Meteor,探索者小舒,伴学OS1,Theme,Design,Product">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <meta name="description" content="多级缓存传统缓存的问题 传统的缓存策略一般是请求到达Tomcat后，先查询Redis,如果未命中则查询数据库，存在下面的问题:请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈Redis缓存失效时，会对数据库产生冲击  多级缓存方案多级缓存就是充分利用请求处理的每个环节,分别添加缓存，减轻Tomcat压力，提升服务性能:  减轻了tomcat的压力，避免了对数据库的压力，需要在ngi">
<meta property="og:type" content="article">
<meta property="og:title" content="多级缓存.html">
<meta property="og:url" content="https://nexmoe.com/bian-cheng-yu-yan/java/xue-xi/kuang-jia/duo-ji-huan-cun/duo-ji-huan-cun.html">
<meta property="og:site_name" content="折影轻梦">
<meta property="og:description" content="多级缓存传统缓存的问题 传统的缓存策略一般是请求到达Tomcat后，先查询Redis,如果未命中则查询数据库，存在下面的问题:请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈Redis缓存失效时，会对数据库产生冲击  多级缓存方案多级缓存就是充分利用请求处理的每个环节,分别添加缓存，减轻Tomcat压力，提升服务性能:  减轻了tomcat的压力，避免了对数据库的压力，需要在ngi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404242144598.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404242147940.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404242149087.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250741940.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250742532.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250744238.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250801495.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250801005.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250804293.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404252104807.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404252154083.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404271937233.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404271939787.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404271947581.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404272006323.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404272013371.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404272021885.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404272021225.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404280759689.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404280808615.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404280816959.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292010118.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292013794.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292014207.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292018619.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292018327.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292019049.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292030122.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300745207.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300752746.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300756714.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300757137.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300800606.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300800644.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300821701.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062026467.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062026232.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062044303.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062124605.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062125223.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062127347.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062128659.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070800294.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070803813.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070804039.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070826797.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070829863.png">
<meta property="article:published_time" content="2024-06-01T14:12:25.000Z">
<meta property="article:modified_time" content="2024-06-01T14:32:53.437Z">
<meta property="article:author" content="折影轻梦">
<meta property="article:tag" content="折影轻梦,Mixcm,轻惋,觅漫者,小舒同学,Xiaoshu,Nexmoe,产品,Meteor,探索者小舒,伴学OS1,Theme,Design,Product">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404242144598.png">
    
<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1717252409271">
    
    <link rel="stylesheet" href="/css/style.css?v=1717252409271">

    
        
            <link rel="stylesheet" href="/custom.css?v=1717252409271">
        
    

    
<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>


    <script async src="/js/app.js?v=1717252409271"></script>
    
     

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4D4ZJ9G024"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());

  gtag("config", "G-4D4ZJ9G024");
</script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
    <div id="nexmoe-background">
        <div class="nexmoe-bg" 
            style="background-image: url(https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102206.jpg)"
        ></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="折影轻梦" class="mdui-btn mdui-btn-icon"><img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102017.jpg" alt="折影轻梦"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="折影轻梦">
            <img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102017.jpg" alt="折影轻梦" alt="折影轻梦">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>168</div>
        <div><span>标签</span>60</div>
        <div><span>分类</span>61</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/life.html" title="我的生活">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的生活
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
        
            
            <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        
            <form id="search_form">
                <label><input class="st-default-search-input" id="search_value" name="q" type="search" placeholder="搜索" style="
                    font-size: 15px !important;
                    height: 56px !important;
                    background-image: none;
                "></label>
            </form>
         
    </div>
</div>


	<script async src="/js/search.js?v=1717252409271"></script>



        
            
            <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="http://wpa.qq.com/msgrd?v=3&uin=938798576&site=qq&menu=yes"
			target="_blank"
			mdui-tooltip="{content: 'QQ群'}"
			style="
				color: rgb(249, 174, 8);
				background-color: rgba(249, 174, 8, .1);
			"
		>
			<i
				class="nexmoefont icon-QQ"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://space.bilibili.com/477448861/"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		>
	</div>
</div>

        
            
            
            
            
            
            
    </aside>
    <div class="nexmoe-copyright">
        &copy; 2024 折影轻梦
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
    <div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover"> 
            <img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102206.jpg" alt="多级缓存.html" loading="lazy">
            <h1>多级缓存.html</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2024年06月01日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a>
        
        
    </div>
    
    
    
    
    
</div>

    <h1 id="多级缓存"><a href="#多级缓存" class="headerlink" title="多级缓存"></a>多级缓存</h1><h2 id="传统缓存的问题"><a href="#传统缓存的问题" class="headerlink" title="传统缓存的问题"></a>传统缓存的问题</h2><blockquote>
<p>传统的缓存策略一般是请求到达Tomcat后，先查询Redis,如果未命中则查询数据库，存在下面的问题:<br>请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈<br>Redis缓存失效时，会对数据库产生冲击<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404242144598.png" alt="image-20240424214450555" data-caption="image-20240424214450555" loading="lazy"></p>
</blockquote>
<h2 id="多级缓存方案"><a href="#多级缓存方案" class="headerlink" title="多级缓存方案"></a>多级缓存方案</h2><p>多级缓存就是充分利用请求处理的每个环节,分别添加缓存，减轻Tomcat压力，提升服务性能:<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404242147940.png" alt="image-20240424214727874" data-caption="image-20240424214727874" loading="lazy"></p>
<blockquote>
<p>减轻了<code>tomcat</code>的压力，避免了对数据库的压力，需要在nginx内部实现对于redis、tomcat访问的业务代码</p>
<p>将来会将<code>nginx</code>部署为集群<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404242149087.png" alt="image-20240424214908046" data-caption="image-20240424214908046" loading="lazy"></p>
</blockquote>
<ol>
<li>JVM进程缓存(Tomcat缓存)</li>
<li>Lua语法入门</li>
<li>实现多级缓存</li>
<li>缓存同步策略</li>
</ol>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><blockquote>
<p>后期做数据同步需要用到MySQL的主从功能，所以需要大家在虚拟机中，利用Docker来运行一个MySQL容器。</p>
<p>为了方便后期配置MySQL，我们先准备两个目录，用于挂载容器的数据和配置文件目录：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 进入/tmp目录</span><br><span class="hljs-built_in">cd</span> /tmp<br><span class="hljs-comment"># 创建文件夹</span><br><span class="hljs-built_in">mkdir</span> mysql<br><span class="hljs-comment"># 进入mysql目录</span><br><span class="hljs-built_in">cd</span> mysql<br></code></pre></td></tr></table></figure>
<h3 id="运行命令"><a href="#运行命令" class="headerlink" title="运行命令"></a>运行命令</h3><blockquote>
<p>在&#x2F;tmp&#x2F;mysql&#x2F;conf目录添加一个my.cnf文件，作为mysql的配置文件：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 创建文件</span><br><span class="hljs-built_in">touch</span> /tmp/mysql/conf/my.cnf<br></code></pre></td></tr></table></figure>
<p><strong>文件内容如下</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf">[mysqld]<br>skip-name-resolve<br>character_set_server=utf8<br>datadir=/var/lib/mysql<br>server-id=1000<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run \<br> -p 3307:3306 \<br> --name mysql-demo \<br> -v <span class="hljs-variable">$PWD</span>/conf:/etc/mysql/conf.d \<br> -v <span class="hljs-variable">$PWD</span>/logs:/logs \<br> -v <span class="hljs-variable">$PWD</span>/data:/var/lib/mysql \<br> -e MYSQL_ROOT_PASSWORD=123456 \<br> --privileged \<br> -d \<br> mysql:5.7.25<br></code></pre></td></tr></table></figure>
<p><strong>重启容器</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker restart mysql-demo<br></code></pre></td></tr></table></figure>
<p>navicat新建连接<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250741940.png" alt="image-20240425074130881" data-caption="image-20240425074130881" loading="lazy"><br>新建数据库<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250742532.png" alt="image-20240425074220509" data-caption="image-20240425074220509" loading="lazy"><br>执行sql</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `tb_item`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_item`  (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;商品id&#x27;</span>,<br>  `title` <span class="hljs-type">varchar</span>(<span class="hljs-number">264</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品标题&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span> COMMENT <span class="hljs-string">&#x27;商品名称&#x27;</span>,<br>  `price` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;价格（分）&#x27;</span>,<br>  `image` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品图片&#x27;</span>,<br>  `category` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;类目名称&#x27;</span>,<br>  `brand` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;品牌名称&#x27;</span>,<br>  `spec` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;规格&#x27;</span>,<br>  `status` <span class="hljs-type">int</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">&#x27;商品状态 1-正常，2-下架，3-删除&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `update_time` datetime <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;更新时间&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,<br>  INDEX `status`(`status`) <span class="hljs-keyword">USING</span> BTREE,<br>  INDEX `updated`(`update_time`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">50002</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8_general_ci COMMENT <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;商品表&#x27;</span> ROW_FORMAT <span class="hljs-operator">=</span> COMPACT;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10001</span>, <span class="hljs-string">&#x27;RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4&#x27;</span>, <span class="hljs-string">&#x27;SALSA AIR&#x27;</span>, <span class="hljs-number">16900</span>, <span class="hljs-string">&#x27;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&#x27;</span>, <span class="hljs-string">&#x27;拉杆箱&#x27;</span>, <span class="hljs-string">&#x27;RIMOWA&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;颜色\&quot;: \&quot;红色\&quot;, \&quot;尺码\&quot;: \&quot;26寸\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10002</span>, <span class="hljs-string">&#x27;安佳脱脂牛奶 新西兰进口轻欣脱脂250ml*24整箱装*2&#x27;</span>, <span class="hljs-string">&#x27;脱脂牛奶&#x27;</span>, <span class="hljs-number">68600</span>, <span class="hljs-string">&#x27;https://m.360buyimg.com/mobilecms/s720x720_jfs/t25552/261/1180671662/383855/33da8faa/5b8cf792Neda8550c.jpg!q70.jpg.webp&#x27;</span>, <span class="hljs-string">&#x27;牛奶&#x27;</span>, <span class="hljs-string">&#x27;安佳&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;数量\&quot;: 24&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10003</span>, <span class="hljs-string">&#x27;唐狮新品牛仔裤女学生韩版宽松裤子 A款/中牛仔蓝（无绒款） 26&#x27;</span>, <span class="hljs-string">&#x27;韩版牛仔裤&#x27;</span>, <span class="hljs-number">84600</span>, <span class="hljs-string">&#x27;https://m.360buyimg.com/mobilecms/s720x720_jfs/t26989/116/124520860/644643/173643ea/5b860864N6bfd95db.jpg!q70.jpg.webp&#x27;</span>, <span class="hljs-string">&#x27;牛仔裤&#x27;</span>, <span class="hljs-string">&#x27;唐狮&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;颜色\&quot;: \&quot;蓝色\&quot;, \&quot;尺码\&quot;: \&quot;26\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10004</span>, <span class="hljs-string">&#x27;森马(senma)休闲鞋女2019春季新款韩版系带板鞋学生百搭平底女鞋 黄色 36&#x27;</span>, <span class="hljs-string">&#x27;休闲板鞋&#x27;</span>, <span class="hljs-number">10400</span>, <span class="hljs-string">&#x27;https://m.360buyimg.com/mobilecms/s720x720_jfs/t1/29976/8/2947/65074/5c22dad6Ef54f0505/0b5fe8c5d9bf6c47.jpg!q70.jpg.webp&#x27;</span>, <span class="hljs-string">&#x27;休闲鞋&#x27;</span>, <span class="hljs-string">&#x27;森马&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;颜色\&quot;: \&quot;白色\&quot;, \&quot;尺码\&quot;: \&quot;36\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10005</span>, <span class="hljs-string">&#x27;花王（Merries）拉拉裤 M58片 中号尿不湿（6-11kg）（日本原装进口）&#x27;</span>, <span class="hljs-string">&#x27;拉拉裤&#x27;</span>, <span class="hljs-number">38900</span>, <span class="hljs-string">&#x27;https://m.360buyimg.com/mobilecms/s720x720_jfs/t24370/119/1282321183/267273/b4be9a80/5b595759N7d92f931.jpg!q70.jpg.webp&#x27;</span>, <span class="hljs-string">&#x27;拉拉裤&#x27;</span>, <span class="hljs-string">&#x27;花王&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;型号\&quot;: \&quot;XL\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>, <span class="hljs-string">&#x27;2019-05-01 00:00:00&#x27;</span>);<br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `tb_item_stock`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_item_stock`  (<br>  `item_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品id，关联tb_item表&#x27;</span>,<br>  `stock` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">9999</span> COMMENT <span class="hljs-string">&#x27;商品库存&#x27;</span>,<br>  `sold` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;商品销量&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`item_id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> InnoDB <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="hljs-operator">=</span> COMPACT;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item_stock` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10001</span>, <span class="hljs-number">99996</span>, <span class="hljs-number">3219</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item_stock` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10002</span>, <span class="hljs-number">99999</span>, <span class="hljs-number">54981</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item_stock` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10003</span>, <span class="hljs-number">99999</span>, <span class="hljs-number">189</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item_stock` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10004</span>, <span class="hljs-number">99999</span>, <span class="hljs-number">974</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_item_stock` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10005</span>, <span class="hljs-number">99999</span>, <span class="hljs-number">18649</span>);<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250744238.png" alt="image-20240425074417184" data-caption="image-20240425074417184" loading="lazy"><br><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250755125.rar">基本工程下载</a><br><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250758691.rar">nginx配置</a><br>在nginx目录下，运行命令启动nginx</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">start nginx.exe<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250801495.png" alt="image-20240425080100462" data-caption="image-20240425080100462" loading="lazy"></p>
<blockquote>
<p>访问页面<code>http://localhost/item.html?id=10001</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250801005.png" alt="image-20240425080135891" data-caption="image-20240425080135891" loading="lazy"><br>现在，页面是假数据展示的。我们需要向服务器发送ajax请求，查询商品数据。<br>打开控制台，可以看到页面有发起<code>ajax</code>查询数据<br>而这个请求地址同样是80端口，所以被当前的nginx反向代理了。<br>查看nginx的conf目录下的<code>nginx.conf</code>文件<br>其中的关键配置如下：<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404250804293.png" alt="image-20210816114416561" data-caption="image-20210816114416561" loading="lazy"><br>其中的192.168.150.101是我的虚拟机IP，也就是我的Nginx业务集群要部署的地方：<br>完整内容如下：</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush     on;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br>    <span class="hljs-section">upstream</span> nginx-cluster&#123;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.150.101:8081</span>;<br>    &#125;<br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br>  <span class="hljs-section">location</span> /api &#123;<br>            <span class="hljs-attribute">proxy_pass</span> http://nginx-cluster;<br>        &#125;<br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;<br>        <span class="hljs-section">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="本地进程缓存"><a href="#本地进程缓存" class="headerlink" title="本地进程缓存"></a>本地进程缓存</h2><p>缓存在日常开发中启动至关重要的作用，由于是存储在内存中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。我们把缓存分为两类:<br>分布式缓存，例如Redis:</p>
<ul>
<li><p>优点:存储容量更大、可靠性更好、可以在集群间共享</p>
</li>
<li><p>缺点:访问缓存有网络开销</p>
</li>
<li><p>场景:缓存数据量较大、可靠性要求较高、需要在集群间共享<br>进程本地缓存，例如HashMap、GuavaCache:</p>
</li>
<li><p>优点:读取本地内存,没有网络开销，速度更快</p>
</li>
<li><p>缺点:存储容量有限、可靠性较低、无法共享</p>
</li>
<li><p>场景:性能要求较高，缓存数据量较小</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testBasicOps</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 创建缓存对象</span><br>    Cache&lt;String, String&gt; cache = Caffeine.newBuilder().build();<br>    <span class="hljs-comment">// 存数据</span><br>    cache.put(<span class="hljs-string">&quot;gf&quot;</span>, <span class="hljs-string">&quot;迪丽热巴&quot;</span>);<br>    <span class="hljs-comment">// 取数据，不存在则返回null</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> cache.getIfPresent(<span class="hljs-string">&quot;gf&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;gf = &quot;</span> + gf);<br>    <span class="hljs-comment">// 取数据，不存在则去数据库查询</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">defaultGF</span> <span class="hljs-operator">=</span> cache.get(<span class="hljs-string">&quot;defaultGF&quot;</span>, key -&gt; &#123;<br>        <span class="hljs-comment">// 这里可以去数据库根据 key查询value</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;柳岩&quot;</span>;<br>    &#125;);<br>    System.out.println(<span class="hljs-string">&quot;defaultGF = &quot;</span> + defaultGF);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Caffeine提供了三种缓存驱逐策略:</p>
</li>
<li><p>基于容量:设置缓存的数量上限</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 创建缓存对象</span><br>Cache&lt;String, String&gt; cache = Caffeine.newBuilder()<br>        <span class="hljs-comment">// 设置缓存大小上限为 1</span><br>        .maximumSize(<span class="hljs-number">1</span>)<br>        .build();<br></code></pre></td></tr></table></figure></li>
<li><p>基于时间:设置缓存的有效时间</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 创建缓存对象</span><br>Cache&lt;String, String&gt; cache = Caffeine.newBuilder()<br>        <span class="hljs-comment">// 设置缓存有效期为 10 秒</span><br>        .expireAfterWrite(Duration.ofSeconds(<span class="hljs-number">1</span>))<br>        .build();<br></code></pre></td></tr></table></figure>
</li>
<li><p>基于引用:设置缓存为软引用或弱引用,利用GC来回收缓存数据。性能较差,不建议使用。<br>在默认情况下，当一个缓存元素过期的时候，Caffeine不会<code>自动立即</code>将其<code>清理</code>和驱逐。而是在一次读或写操作后， 或者在空闲时间完成对失效数据的驱逐。</p>
<blockquote>
<p>实现商品的查询的本地进程缓存</p>
<p>利用Caffeine实现下列需求:</p>
<ul>
<li>给根据id查询商品的业务添加缓存，缓存未命中时查询数据库</li>
<li>给根据id查询商品库存的业务添加缓存，缓存未命中时查询数据库</li>
<li>缓存初始大小为100</li>
<li>缓存上限为10000<br>新建配置类<br>这里<code>10_000</code>其实是指<code>10000</code>，下划线的作用是分隔数字，方便阅读，不加也行</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaffeineConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cache&lt;Long, Item&gt; <span class="hljs-title function_">itemCache</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .initialCapacity(<span class="hljs-number">100</span>)<br>                .maximumSize(<span class="hljs-number">10_000</span>)<br>                .build();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cache&lt;Long, ItemStock&gt; <span class="hljs-title function_">stockCache</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .initialCapacity(<span class="hljs-number">100</span>)<br>                .maximumSize(<span class="hljs-number">10_000</span>)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>查询api添加缓存</p>
<ol>
<li>它首先检查给定 <code>id</code> 对应的缓存项是否存在（即 <code>ItemStock</code> 是否在缓存中）。</li>
<li>如果缓存中存在该 <code>id</code> 对应的 <code>ItemStock</code>，则直接从缓存中获取并返回结果。</li>
<li>如果缓存中不存在该 <code>id</code> 对应的 <code>ItemStock</code>，则执行传递给 <code>get</code> 方法的第二个参数——一个函数式接口（<code>key -&gt; stockService.getById(key)</code>）。这个函数会被用来计算并返回需要缓存的值，即通过调用 <code>stockService.getById(key)</code> 查询数据库以获取 <code>ItemStock</code> 对象。</li>
<li>在从数据库获取到 <code>ItemStock</code> 后，Caffeine 会将其放入缓存，并将该对象作为结果返回。</li>
</ol>
<p>虽然代码片段中没有显式地进行“存入缓存”的操作，但在首次查询不存在于缓存中的 <code>id</code> 时，Caffeine 自动完成了从数据库加载数据并缓存这一过程。后续对该 <code>id</code> 的查询将会命中缓存，从而避免了对数据库的重复访问。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;item&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, Item&gt; itemCache;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, ItemStock&gt; stockCache;<br>    <span class="hljs-comment">// 注入Bean</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemService itemService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemStockService stockService;<br>    <span class="hljs-meta">@GetMapping(&quot;list&quot;)</span><br>    <span class="hljs-keyword">public</span> PageDTO <span class="hljs-title function_">queryItemPage</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@RequestParam(value = &quot;page&quot;, defaultValue = &quot;1&quot;)</span> Integer page,</span><br><span class="hljs-params">            <span class="hljs-meta">@RequestParam(value = &quot;size&quot;, defaultValue = &quot;5&quot;)</span> Integer size)</span> &#123;<br>        <span class="hljs-comment">// 分页查询商品</span><br>        Page&lt;Item&gt; result = itemService.query()<br>                .ne(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">3</span>)<br>                .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(page, size));<br>        <span class="hljs-comment">// 查询库存</span><br>        List&lt;Item&gt; list = result.getRecords().stream().peek(item -&gt; &#123;<br>            <span class="hljs-type">ItemStock</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> stockService.getById(item.getId());<br>            item.setStock(stock.getStock());<br>            item.setSold(stock.getSold());<br>        &#125;).collect(Collectors.toList());<br>        <span class="hljs-comment">// 封装返回</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageDTO</span>(result.getTotal(), list);<br>    &#125;<br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveItem</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Item item)</span> &#123;<br>        itemService.saveItem(item);<br>    &#125;<br>    <span class="hljs-meta">@PutMapping</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateItem</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Item item)</span> &#123;<br>        itemService.updateById(item);<br>    &#125;<br>    <span class="hljs-meta">@PutMapping(&quot;stock&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateStock</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ItemStock itemStock)</span> &#123;<br>        stockService.updateById(itemStock);<br>    &#125;<br>    <span class="hljs-meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        itemService.update().set(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">3</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>    &#125;<br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Item <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        <span class="hljs-comment">// 如果缓存存在，则直接返回，不存在则查数据库</span><br>        <span class="hljs-keyword">return</span> itemCache.get(id, key -&gt; itemService.query()<br>                .ne(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">3</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, key)<br>                .one()<br>        );<br>    &#125;<br>    <span class="hljs-meta">@GetMapping(&quot;/stock/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ItemStock <span class="hljs-title function_">findStockById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        <span class="hljs-comment">// 如果缓存存在，则直接返回，不存在则查数据库</span><br>        <span class="hljs-keyword">return</span> stockCache.get(id, key -&gt; stockService.getById(key));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>访问<code>http://localhost:8081/item/10001</code>，多次刷新，但日志只打印了一次<code>sql</code>，说明查的是缓存</p>
<p>同理访问<code>http://localhost:8081/item/stock/10001</code></p>
</blockquote>
</li>
</ul>
<h2 id="Lua语法入门"><a href="#Lua语法入门" class="headerlink" title="Lua语法入门"></a>Lua语法入门</h2><h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><p>1.在Linux虚拟机的任意目录下，新建一-个hello.lua文件</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">touch</span> hello.lua<br></code></pre></td></tr></table></figure>
<p>2.添加下面的内容</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello World!&quot;</span>)<br></code></pre></td></tr></table></figure>
<p>3.运行</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua">lua hello.lua<br></code></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>nil</td>
<td>这个最简单，只有值nil属于该类，表示一个无效值(在条件表达式中相当于false)。</td>
</tr>
<tr>
<td>boolean</td>
<td>包含两个值: false和true</td>
</tr>
<tr>
<td>number</td>
<td>表示双精度类型的实浮点数</td>
</tr>
<tr>
<td>string</td>
<td>字符串由一对双引号或单引号来表示</td>
</tr>
<tr>
<td>function</td>
<td>由C或Lua编写的函数</td>
</tr>
<tr>
<td>table</td>
<td>Lua中的表(table) 其实是一个”关联数组” (associative arrays)，数组的索引可以是数字、字符串或表类型。在Lua里，table的创建是通过”构造表达式”来完成，最简单构造表达式是{},用来创建一 个空表。</td>
</tr>
</tbody></table>
<blockquote>
<p>可以使用<code>type</code>关键字来判断变量的类型</p>
</blockquote>
<figure class="highlight isbl"><table><tr><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-title">type</span>(<span class="hljs-string">&quot;hello&quot;</span>))</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>声明变量</p>
<p><code>local</code>代表局部变量</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 声明字符串</span><br><span class="hljs-keyword">local</span> str = <span class="hljs-string">&#x27;hello&#x27;</span><br><span class="hljs-comment">-- 声明数字</span><br><span class="hljs-keyword">local</span> num = <span class="hljs-number">21</span><br><span class="hljs-comment">-- 声明布尔类型</span><br><span class="hljs-keyword">local</span> flag = <span class="hljs-literal">true</span><br><span class="hljs-comment">-- 声明数组 key为索引的table</span><br><span class="hljs-keyword">local</span> arr = &#123;<span class="hljs-string">&#x27;java&#x27;</span>,<span class="hljs-string">&#x27;python&#x27;</span>,<span class="hljs-string">&#x27;go&#x27;</span>&#125;<br><span class="hljs-comment">-- 声明table，类似于java中的map</span><br><span class="hljs-keyword">local</span> map=&#123; name = <span class="hljs-string">&#x27;jack&#x27;</span> , gender = <span class="hljs-string">&#x27;男&#x27;</span>&#125;<br><span class="hljs-comment">-- 访问数组，lua数组的角标从1开始</span><br><span class="hljs-built_in">print</span>(arr[<span class="hljs-number">1</span>])<br><span class="hljs-comment">-- 访问table</span><br><span class="hljs-built_in">print</span>(map[<span class="hljs-string">&#x27;name&#x27;</span>])<br><span class="hljs-built_in">print</span>(map.name)<br><span class="hljs-comment">-- 字符串拼接</span><br><span class="hljs-keyword">local</span> helloworld=<span class="hljs-string">&#x27;Hello &#x27;</span> .. <span class="hljs-string">&#x27;World!&#x27;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>遍历</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 遍历数组</span><br><span class="hljs-keyword">local</span> arr = &#123;<span class="hljs-string">&#x27;java&#x27;</span>,<span class="hljs-string">&#x27;python&#x27;</span>,<span class="hljs-string">&#x27;go&#x27;</span>&#125;<br><span class="hljs-comment">-- ipairs代表解析数组</span><br><span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">print</span>(key,value)<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 遍历map</span><br><span class="hljs-keyword">local</span> map=&#123; name = <span class="hljs-string">&#x27;jack&#x27;</span> , gender = <span class="hljs-string">&#x27;男&#x27;</span>&#125;<br><span class="hljs-comment">-- 遍历table</span><br><span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(map) <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">print</span>(key,value)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<p><strong>执行结果如下</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404252104807.png" alt="image-20240425210357720" data-caption="image-20240425210357720" loading="lazy"></p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><blockquote>
<p>定义函数的语法</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> 函数名<span class="hljs-params">(arg1,arg2...,arg3)</span></span><br>    <span class="hljs-comment">-- 函数体</span><br>    <span class="hljs-keyword">return</span> 返回值<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 例如，定义一个函数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printArr</span><span class="hljs-params">(arr)</span></span><br>    <span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">print</span>(key,value)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br>printArr(&#123;<span class="hljs-string">&#x27;java&#x27;</span>,<span class="hljs-string">&#x27;python&#x27;</span>,<span class="hljs-string">&#x27;go&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>
<h3 id="条件控制"><a href="#条件控制" class="headerlink" title="条件控制"></a>条件控制</h3><figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span>(布尔表达式)<br><span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- [为true时，执行的语句]</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-comment">-- [为false时，执行的语句]</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>逻辑操作符，<code>and</code>,<code>or</code>,<code>not</code><br>如、<code>A and B</code>、<code>A orB</code>、<code>not B</code></p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printArr</span><span class="hljs-params">(arr)</span></span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">not</span> arr) <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;参数不能为nil&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">print</span>(key,value)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">local</span> lang=&#123;<span class="hljs-string">&#x27;java&#x27;</span>,<span class="hljs-string">&#x27;python&#x27;</span>,<span class="hljs-string">&#x27;go&#x27;</span>&#125;<br>printArr(lang)<br>printArr(<span class="hljs-literal">nil</span>)<br></code></pre></td></tr></table></figure>
<h2 id="多级缓存-1"><a href="#多级缓存-1" class="headerlink" title="多级缓存"></a>多级缓存</h2><h3 id="OpenRestry"><a href="#OpenRestry" class="headerlink" title="OpenRestry"></a>OpenRestry</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://openresty.org/cn/download.html">官网</a><br>OpenResty是-个基于Nginx的高性能Web平台，用于方便地搭建能够处理超高并发、扩展性极高的动态Web应用、Web服务和动态网关。具备下列特点:</p>
</blockquote>
<ul>
<li>具备Nginx的完整功能</li>
<li>基于Lua语言进行扩展，集成了大量精良的Lua库、第三方模块</li>
<li>允许使用Lua自定义业务逻辑、自定义库<br>首先要安装OpenResty的<strong>依赖开发库</strong>，执行命令：<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">yum install -y pcre-devel openssl-devel gcc --skip-broken<br></code></pre></td></tr></table></figure>
安装<strong>OpenResty仓库</strong><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo<br></code></pre></td></tr></table></figure>
如果提示说命令不存在，则运行：<figure class="highlight cmake"><table><tr><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> -y yum-utils <br></code></pre></td></tr></table></figure>
然后再重复上面的命令<br><strong>安装OpenResty</strong><br>然后就可以像下面这样安装软件包，比如 <code>openresty</code>：<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">yum install -y openresty<br></code></pre></td></tr></table></figure>
<strong>安装opm工具</strong><br>opm是OpenResty的一个管理工具，可以帮助我们安装一个第三方的Lua模块。<br>如果你想安装命令行工具 <code>opm</code>，那么可以像下面这样安装 <code>openresty-opm</code> 包：<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">yum install -y openresty-opm<br></code></pre></td></tr></table></figure>
<strong>配置nginx</strong><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">vi /etc/profile<br></code></pre></td></tr></table></figure>
在最下面加入两行：<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> NGINX_HOME=/usr/local/openresty/nginx<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$&#123;NGINX_HOME&#125;</span>/sbin:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure>
NGINX_HOME：后面是OpenResty安装目录下的nginx的目录<br>然后让配置生效：<figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">source</span> <span class="hljs-regexp">/etc/</span>profile<br></code></pre></td></tr></table></figure>
所以运行方式与nginx基本一致：<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 启动nginx</span><br>nginx<br><span class="hljs-comment"># 重新加载配置</span><br>nginx -s reload<br><span class="hljs-comment"># 停止</span><br>nginx -s stop<br></code></pre></td></tr></table></figure>
nginx的默认配置文件注释太多，影响后续我们的编辑，这里将nginx.conf中的注释部分删除，保留有效部分。<br>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，内容如下：<figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><span class="hljs-attribute">error_log</span>  logs/<span class="hljs-literal">error</span>.log;<br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">8081</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;<br>        <span class="hljs-section">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
在Linux的控制台输入命令以启动nginx：<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">nginx<br></code></pre></td></tr></table></figure>
然后访问页面：<a href="http://192.168.56.10:8081，注意ip地址替换为你自己的虚拟机IP：">http://192.168.56.10:8081，注意ip地址替换为你自己的虚拟机IP：</a><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404252154083.png" alt="image-20240425215453990" data-caption="image-20240425215453990" loading="lazy"></li>
</ul>
<h4 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404271937233.png" alt="image-20240427193749125" data-caption="image-20240427193749125" loading="lazy"></p>
<blockquote>
<p>访问<code>http://localhost/item.html?id=10001</code>商品详情页，发送的请求是<code>http://localhost/api/item/10001</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404271939787.png" alt="image-20240427193945728" data-caption="image-20240427193945728" loading="lazy"><br>nginx在捕获到<code>/api</code>请求后，转给了虚拟机<code>8081</code>，而刚刚部署的<code>OpenRestry</code>在8081，这里<code>OpenRestry</code>需要做一些业务处理<br>步骤一:修改nginx.conf文件<br>1.在nginx.conf的http 下面，添加对OpenResty的Lua模块的加载:</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#加载lua模块</span><br><span class="hljs-attribute">lua_package_path</span> <span class="hljs-string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span>;<br><span class="hljs-comment">#加载c模块</span><br><span class="hljs-attribute">lua_package_cpath</span> <span class="hljs-string">&quot;/usr/local/openresty/lualib/?.so;;&quot;</span>;<br></code></pre></td></tr></table></figure>
<p>2.在nginx.conf的server 下面，添加对<code>/api/item</code>这个路径的监听:</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">location /api/<span class="hljs-built_in">item</span> &#123;<br>    <span class="hljs-comment">#响应类型，这里返回json</span><br>    default_type <span class="hljs-built_in">application</span>/json;<br>    <span class="hljs-comment">#响应数据由lua/item.lua这个文件来决定</span><br>    content_by_lua_file lua/<span class="hljs-built_in">item</span>.lua;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404271947581.png" alt="image-20240427194735493" data-caption="image-20240427194735493" loading="lazy"></p>
<blockquote>
<ol>
<li>在nginx目录下新建文件夹<code>lua</code></li>
<li>lua目录下新建文件<code>item.lua</code></li>
<li>编写如下内容</li>
</ol>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 返回一条假数据，这里的ngx.say()函数就是把数据写入Response中</span><br>ngx.say(<span class="hljs-string">&#x27;&#123;&quot;id&quot;:10001,&quot;name&quot;:&quot;普通行李箱&quot;&#125;&#x27;</span>)<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>重新加载配置</li>
</ol>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">nginx -s reload</span><br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404272006323.png" alt="image-20240427200628182" data-caption="image-20240427200628182" loading="lazy"><br>可以看到<strong>lua脚本</strong>已经生效了</p>
</blockquote>
<h4 id="请求参数"><a href="#请求参数" class="headerlink" title="请求参数"></a>请求参数</h4><p>OpenResty提供了各种API用来获取不同类型的请求参数:<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404272013371.png" alt="image-20240427201344237" data-caption="image-20240427201344237" loading="lazy"><br><strong>案例</strong><br>获取请求路径中的商品id信息，拼接到json结果中返回</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> <span class="hljs-regexp">~ /api/item/(\d+)</span> &#123;<br>    <span class="hljs-comment">#响应类型，这里返回json</span><br>    <span class="hljs-attribute">default_type</span> application/json;<br>    <span class="hljs-comment">#响应数据由lua/item.lua这个文件来决定</span><br>    <span class="hljs-attribute">content_by_lua_file</span> lua/item.lua;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404272021885.png" alt="image-20240427202103810" data-caption="image-20240427202103810" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404272021225.png" alt="image-20240427202117153" data-caption="image-20240427202117153" loading="lazy"></p>
<h4 id="封装http请求工具"><a href="#封装http请求工具" class="headerlink" title="封装http请求工具"></a>封装http请求工具</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404280759689.png" alt="image-20240428075935605" data-caption="image-20240428075935605" loading="lazy"><br><strong>案例</strong><br>这里要修改item.lua,满足下面的需求:</p>
<ol>
<li>获取请求参数中的id</li>
<li>根据id向Tomcat服务发送请求，查询商品信息</li>
<li>根据id向Tomcat服务发送请求，查询库存信息</li>
<li>组装商品信息、库存信息，序列化为JSON格式并返回<blockquote>
<p>nginx发送http请求</p>
<p><code>/path</code>是指具体的请求路径，如<code>/item/10001</code></p>
<p>返回响应的内容包括</p>
<ol>
<li>resp.status 响应状态码</li>
<li>resp.header 响应头，是一个table</li>
<li>resp.body 响应体，就是响应数据</li>
</ol>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> resp=ngx.location.capture(<span class="hljs-string">&#x27;/path&#x27;</span>,&#123;<br>  <span class="hljs-comment">-- 请求方式</span><br>  method=ngx.HTTP_GET,<br>  <span class="hljs-comment">-- get方式传参</span><br>  args=&#123;a=<span class="hljs-number">1</span>,b=<span class="hljs-number">2</span>&#125;,<br>  <span class="hljs-comment">-- post方式传参</span><br>  body=<span class="hljs-string">&quot;c=3&amp;d=4&quot;</span><br>&#125;)<br></code></pre></td></tr></table></figure>
注意:这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理。<br>但是我们希望这个请求发送到Tomcat服务器，所以还需要编写一个server来对这个路径做反向代理:<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf">location /item &#123;<br>  proxy_pass http://192.168.56.1:8081;<br>&#125;<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404280808615.png" alt="image-20240428080836536" data-caption="image-20240428080836536" loading="lazy"><blockquote>
<p>封装通用http请求<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404280816959.png" alt="image-20240428081628881" data-caption="image-20240428081628881" loading="lazy"></p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 封装函数，发送http请求</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_http</span><span class="hljs-params">(path,params)</span></span><br>    <span class="hljs-keyword">local</span> resp=ngx.location.capture(<span class="hljs-built_in">path</span>,&#123;<br>            method=ngx.HTTP_GET,<br>            args=params,<br>    &#125;)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>        <span class="hljs-comment">-- 记录错误信息，返回404</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR,<span class="hljs-string">&quot;http not found,path: &quot;</span>,<span class="hljs-built_in">path</span>,<span class="hljs-string">&quot;, args: &quot;</span>,args)<br>        ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">404</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> resp.body<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 导出方法</span><br><span class="hljs-keyword">local</span> _M=&#123;<br>    read_http=read_http<br>&#125;<br><span class="hljs-keyword">return</span> _M<br></code></pre></td></tr></table></figure>
再次请求即可<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292010118.png" alt="image-20240429201037008" data-caption="image-20240429201037008" loading="lazy"><blockquote>
<p>咱先理一下请求的过程</p>
</blockquote>
</li>
<li>首先nginx里的html发送ajax请求<code>http://localhost/api/item/10001</code></li>
<li>nginx反向代理给<code>192.168.56.10:8081</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292013794.png" alt="image-20240429201307731" data-caption="image-20240429201307731" loading="lazy"></li>
<li>而虚拟机的<code>openresty</code>由<code>item.lua</code>来处理这个请求<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292014207.png" alt="image-20240429201412119" data-caption="image-20240429201412119" loading="lazy"></li>
<li><code>item.lua</code>通过封装好的请求工具发送请求<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292018619.png" alt="image-20240429201806527" data-caption="image-20240429201806527" loading="lazy"></li>
<li>而<code>openresty</code>本身也具有nginx的功能，将请求反向代理到windows主机上<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292018327.png" alt="image-20240429201852232" data-caption="image-20240429201852232" loading="lazy"></li>
<li>后端接收到请求，响应数据<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292019049.png" alt="image-20240429201955918" data-caption="image-20240429201955918" loading="lazy"><blockquote>
<p>现在数据还不完整，还需要查询库存信息返回，此时只有商品信息</p>
<p>需要将json数据转换成lua中的table(也就是<code>DTO</code>)</p>
<p>OpenResty提供了一个<code>cjson</code>的模块用来处理JSON的序列化和反序列化。</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入cjson库</span><br><span class="hljs-keyword">local</span> cjson=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cjson&quot;</span>)<br><span class="hljs-comment">-- 序列化</span><br><span class="hljs-keyword">local</span> obj=&#123;<br>    name=<span class="hljs-string">&quot;jack&quot;</span>,<br>    age=<span class="hljs-number">21</span><br>&#125;<br><span class="hljs-keyword">local</span> json=cjson.encode(obj)<br><span class="hljs-comment">-- 反序列化</span><br><span class="hljs-keyword">local</span> json=<span class="hljs-string">&#x27;&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:21&#125;&#x27;</span><br><span class="hljs-keyword">local</span> obj=cjson.decode(json)<br><span class="hljs-built_in">print</span>(obj.name)<br></code></pre></td></tr></table></figure>
<blockquote>
<p>编写<code>item.lua</code></p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入cjson库</span><br><span class="hljs-keyword">local</span> cjson=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cjson&quot;</span>)<br><span class="hljs-comment">-- 导入请求工具common</span><br><span class="hljs-comment">-- 这里common.lua正好在lualib目录下，所以可以直接导入;如果不是，则需要写上路径</span><br><span class="hljs-keyword">local</span> common=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;common&quot;</span>)<br><span class="hljs-keyword">local</span> read_http=common.read_http<br><span class="hljs-comment">-- 获取路径参数</span><br><span class="hljs-keyword">local</span> id=ngx.var[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- 查询商品信息</span><br><span class="hljs-keyword">local</span> itemJson=read_http(<span class="hljs-string">&quot;/item/&quot;</span>..id,<span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- 查询库存信息</span><br><span class="hljs-keyword">local</span> stockJson=read_http(<span class="hljs-string">&quot;/item/stock/&quot;</span>..id,<span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- dto转换</span><br><span class="hljs-comment">-- json数据转换成lua中的table</span><br><span class="hljs-keyword">local</span> item=cjson.decode(itemJson)<br><span class="hljs-keyword">local</span> stock=cjson.decode(stockJson)<br><span class="hljs-comment">-- 组合数据</span><br>item.stock=stock.stock<br>item.sold=stock.sold<br><span class="hljs-comment">-- 返回结果</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure>
<blockquote>
<p>重启<code>OpenResty</code>，再次查看请求，库存信息已经出现</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">nginx -s reload<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404292030122.png" alt="image-20240429203042025" data-caption="image-20240429203042025" loading="lazy"></li>
</ol>
<h3 id="Tomcat集群的负载均衡"><a href="#Tomcat集群的负载均衡" class="headerlink" title="Tomcat集群的负载均衡"></a>Tomcat集群的负载均衡</h3><blockquote>
<p>既然要配置负载均衡，那请求就不能只指向一个ip了，需要配置集群<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300745207.png" alt="image-20240430074537126" data-caption="image-20240430074537126" loading="lazy"><br><strong>查询缓存过程:<strong>查询8081，如果<code>缓存</code>存在则直接返回，如果不存在，在查询数据库之后，存入<code>进程缓存</code>中，下次即可从进程缓存获取数据<br><code>但是</code>，</strong>进程缓存无法共享</strong>，就是<code>8081</code>的进程缓存无法与<code>8082</code>共享<br>我们希望查询商品id为<code>10001</code>在第一次查询之后永远都有缓存，该如何做？<br>我们必须要让<code>10001</code>的请求每次都查询同一台服务器，这样就可以让缓存一直生效<br>修改nginx负载均衡算法</p>
<p>对请求uri采用hash算法，使在请求相同的商品时能走到同一台服务器<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300752746.png" alt="image-20240430075210681" data-caption="image-20240430075210681" loading="lazy"><br><strong>配置集群</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300756714.png" alt="image-20240430075622620" data-caption="image-20240430075622620" loading="lazy"></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf">#user  nobody;<br>worker_processes  1;<br>error_log  logs/error.log;<br>events &#123;<br>    worker_connections  1024;<br>&#125;<br>http &#123;<br>    include       mime.types;<br>    default_type  application/octet-stream;<br>    sendfile        on;<br>    keepalive_timeout  65;<br>    # 加载lua模块<br>    lua_package_path &quot;/usr/local/openresty/lualib/?.lua;;&quot;;<br>    # 加载c模块<br>    lua_package_cpath &quot;/usr/local/openresty/lualib/?.so;;&quot;;<br>    upstream tomcat-cluster&#123;<br>        hash $request-uri;<br>        server 192.168.56.1:8081;<br>        server 192.168.56.1:8082;<br>    &#125;<br>    server &#123;<br>        listen       8081;<br>        server_name  localhost;<br>        location /item &#123;<br>          proxy_pass http://tomcat-cluster;<br>        &#125;<br>        location ~ /api/item/(\d+) &#123;<br>            #响应类型，这里返回json<br>            default_type application/json;<br>            #响应数据由lua/item.lua这个文件来决定<br>            content_by_lua_file lua/item.lua;<br>        &#125;<br>        location / &#123;<br>            root   html;<br>            index  index.html index.htm;<br>        &#125;<br>        error_page   500 502 503 504  /50x.html;<br>        location = /50x.html &#123;<br>            root   html;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>继续复制一台Springboot实例，并启动<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300757137.png" alt="image-20240430075741082" data-caption="image-20240430075741082" loading="lazy"><br>访问<code>http://localhost/item.html?id=10002</code>和<code>http://localhost/item.html?id=10001</code></p>
<p>负载均衡已实现，而在多次访问时，并没有mysql日志打印，说明是查询缓存得到的数据<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300800606.png" alt="image-20240430080001509" data-caption="image-20240430080001509" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300800644.png" alt="image-20240430080008547" data-caption="image-20240430080008547" loading="lazy"></p>
</blockquote>
<h3 id="添加Redis需求"><a href="#添加Redis需求" class="headerlink" title="添加Redis需求"></a>添加Redis需求</h3><blockquote>
<p>但是按照多级缓存的设想，并不是优先查询Tomcat，而是优先查询Redis，在Redis缓存未命中时，再去查询Tomcat</p>
</blockquote>
<h4 id="冷启动与缓存预热"><a href="#冷启动与缓存预热" class="headerlink" title="冷启动与缓存预热"></a>冷启动与缓存预热</h4><p>冷启动:服务刚刚启动时，Redis中并没有缓存，如果所有商品数据都在第一次查询 时添加缓存，可能会给数据库带来较大压力。<br>缓存预热:在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到Redis中。<br>我们数据量较少，可以在启动时将所有数据都放入缓存中。</p>
<blockquote>
<p>使用Docker安装Redis</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run --name redis -p 6379:6379 -d redis redis-server --appendonly <span class="hljs-built_in">yes</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>添加Redis依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>配置Redis地址</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>编写Redis初始化类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate template;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 初始化缓存</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>我的配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">itemservice</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.56.10:3307/heima?useSSL=false</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.heima.item.pojo</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">update-strategy:</span> <span class="hljs-string">not_null</span><br>      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">com.heima:</span> <span class="hljs-string">debug</span><br>  <span class="hljs-attr">pattern:</span><br>    <span class="hljs-attr">dateformat:</span> <span class="hljs-string">HH:mm:ss:SSS</span><br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.heima.item.pojo.Item;<br><span class="hljs-keyword">import</span> com.heima.item.pojo.ItemStock;<br><span class="hljs-keyword">import</span> com.heima.item.service.IItemService;<br><span class="hljs-keyword">import</span> com.heima.item.service.IItemStockService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.InitializingBean;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate template;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemService itemService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemStockService stockService;<br>    <span class="hljs-comment">// Spring自带的序列化工具</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">MAPPER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 初始化缓存</span><br>        <span class="hljs-comment">// 1.查询商品信息</span><br>        List&lt;Item&gt; itemList = itemService.list();<br>        <span class="hljs-comment">// 2.存入缓存</span><br>        <span class="hljs-keyword">for</span> (Item item : itemList) &#123;<br>            <span class="hljs-comment">// 将item序列化成json</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> MAPPER.writeValueAsString(item);<br>            <span class="hljs-comment">// 存入缓存</span><br>            template.opsForValue().set(<span class="hljs-string">&quot;item:id:&quot;</span>+item.getId(),json);<br>        &#125;<br>        <span class="hljs-comment">// 3.查询库存信息</span><br>        List&lt;ItemStock&gt; stockList = stockService.list();<br>        <span class="hljs-comment">// 2.存入缓存</span><br>        <span class="hljs-keyword">for</span> (ItemStock stock : stockList) &#123;<br>            <span class="hljs-comment">// 将item序列化成json</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> MAPPER.writeValueAsString(stock);<br>            <span class="hljs-comment">// 存入缓存</span><br>            template.opsForValue().set(<span class="hljs-string">&quot;item:stock:id:&quot;</span>+stock.getId(),json);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>访问<code>http://localhost/item.html?id=10004</code>界面，实现了缓存预热的功能<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202404300821701.png" alt="image-20240430082142624" data-caption="image-20240430082142624" loading="lazy"></p>
</blockquote>
<h4 id="查询Redis缓存"><a href="#查询Redis缓存" class="headerlink" title="查询Redis缓存"></a>查询Redis缓存</h4><blockquote>
<p><code>OpenResty</code>优先查询<code>Redis</code>，<code>Redis</code>缓存未命中，再查询<code>Tomcat</code><br><strong>OpenResty的Redis模块</strong><br>OpenResty提供了操作Redis的模块，我们只要引入该模块就能直接使用:<br><strong>引入Redis模块，并初始化Redis对象</strong></p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 引入redis模块</span><br><span class="hljs-keyword">local</span> redis = requirl(<span class="hljs-string">&quot;resty.redis&quot;</span>)<br><span class="hljs-comment">-- 初始化Redis对象</span><br><span class="hljs-keyword">local</span> red = redis:new( )<br><span class="hljs-comment">-- 设置Redis超时时间</span><br>red:set_timeouts(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>)<br></code></pre></td></tr></table></figure>
<p><strong>封装函数，用来释放Redis连接，其实是放入连接池</strong></p>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 关闭redi s连接的工具方法，其实是放入连接池</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close_redis</span><span class="hljs-params">(red)</span></span><br>    <span class="hljs-comment">-- 连接的空闲时间，单位是毫秒</span><br>    <span class="hljs-keyword">local</span> pool_max_idle_time = <span class="hljs-number">10000</span> <br>    <span class="hljs-comment">-- 连接池大小</span><br>    <span class="hljs-keyword">local</span> pool_size = <span class="hljs-number">100</span> <br>    <span class="hljs-keyword">local</span> ok,err = red:set_keepalive(pool_max_idle_time,pool_size)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR，<span class="hljs-string">&quot;放入Redis连接池失败: &quot;</span>,err)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<p><strong>封装函数，从Redis读数据并返回</strong></p>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 查询redis的方法ip和port是redi s地址，key是查询的key</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_redis</span><span class="hljs-params">(ip, port, key)</span></span><br>    <span class="hljs-comment">-- 获取一个连接</span><br>    <span class="hljs-keyword">local</span> ok，err = red:connect(ip,port)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR，<span class="hljs-string">&quot;连接redis失败: &quot;</span>,err)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- 查询redis</span><br>    <span class="hljs-keyword">local</span> resp, err = red:get(key)<br>    <span class="hljs-comment">-- 查询失败处理</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR，<span class="hljs-string">&quot;查询Redis失败: &quot;</span> ,err,<span class="hljs-string">&quot;, key = &quot;</span>，key)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- 查询成功，但是得到的数据为空</span><br>    <span class="hljs-keyword">if</span> resp == ngx.null <span class="hljs-keyword">then</span><br>      resp = <span class="hljs-literal">nil</span><br>      ngx.<span class="hljs-built_in">log</span>(ngx.ERR，<span class="hljs-string">&quot;查询Redis数据为空， key = &quot;</span>,key)<br>    <span class="hljs-keyword">end</span><br>    close_redis(red)<br>    <span class="hljs-keyword">return</span> resp<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>在<code>common.lua</code>下处理如下</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入redis</span><br><span class="hljs-keyword">local</span> redis=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;resty.redis&quot;</span>)<br><span class="hljs-comment">-- 初始化redis</span><br><span class="hljs-keyword">local</span> red=redis:new()<br>red:set_timeouts(<span class="hljs-number">1000</span>,<span class="hljs-number">1000</span>,<span class="hljs-number">1000</span>)<br><span class="hljs-comment">-- 关闭redis连接的工具方法，其实是放入连接池</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close_redis</span><span class="hljs-params">(red)</span></span><br>    <span class="hljs-keyword">local</span> pool_max_idle_time = <span class="hljs-number">10000</span> <span class="hljs-comment">-- 连接的空闲时间，单位是毫秒</span><br>    <span class="hljs-keyword">local</span> pool_size = <span class="hljs-number">100</span> <span class="hljs-comment">--连接池大小</span><br>    <span class="hljs-keyword">local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;放入redis连接池失败: &quot;</span>, err)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 查询redis的方法 ip和port是redis地址，key是查询的key</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_redis</span><span class="hljs-params">(ip, port, key)</span></span><br>    <span class="hljs-comment">-- 获取一个连接</span><br>    <span class="hljs-keyword">local</span> ok, err = red:connect(ip, port)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;连接redis失败 : &quot;</span>, err)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- 查询redis</span><br>    <span class="hljs-keyword">local</span> resp, err = red:get(key)<br>    <span class="hljs-comment">-- 查询失败处理</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;查询Redis失败: &quot;</span>, err, <span class="hljs-string">&quot;, key = &quot;</span> , key)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">--得到的数据为空处理</span><br>    <span class="hljs-keyword">if</span> resp == ngx.null <span class="hljs-keyword">then</span><br>        resp = <span class="hljs-literal">nil</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;查询Redis数据为空, key = &quot;</span>, key)<br>    <span class="hljs-keyword">end</span><br>    close_redis(red)<br>    <span class="hljs-keyword">return</span> resp<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 封装函数，发送http请求</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_http</span><span class="hljs-params">(path,params)</span></span><br>    <span class="hljs-keyword">local</span> resp=ngx.location.capture(<span class="hljs-built_in">path</span>,&#123;<br>            method=ngx.HTTP_GET,<br>            args=params,<br>    &#125;)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>        <span class="hljs-comment">-- 记录错误信息，返回404</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR,<span class="hljs-string">&quot;http not found,path: &quot;</span>,<span class="hljs-built_in">path</span>,<span class="hljs-string">&quot;, args: &quot;</span>,args)<br>        ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">404</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> resp.body<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 导出方法</span><br><span class="hljs-keyword">local</span> _M=&#123;<br>    read_http=read_http,<br>    read_redis=read_redis<br>&#125;<br><span class="hljs-keyword">return</span> _M<br></code></pre></td></tr></table></figure>
<blockquote>
<p>在<code>item.lua</code>下封装一个<code>read_data</code>函数，优先查询redis，redis未命中再查询tomcat</p>
<p>查询商品和库存，都调用<code>read_data</code>函数</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 封装函数，先查询redis，再查询http</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key, path, par ams)</span></span><br>    <span class="hljs-comment">-- 查询redis</span><br>    <span class="hljs-keyword">local</span> resp = read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">6379</span>,key)<br>    <span class="hljs-comment">-- 判断redis是否命中</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>        <span class="hljs-comment">-- Redis查询失败，查询http</span><br>        resp = read_http(<span class="hljs-built_in">path</span>, par ams)<br>  <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> resp<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p><code>item.lua</code></p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入cjson库</span><br><span class="hljs-keyword">local</span> cjson=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cjson&quot;</span>)<br><span class="hljs-comment">-- 导入请求工具common</span><br><span class="hljs-comment">-- 这里common.lua正好在lualib目录下，所以可以直接导入;如果不是，则需要写上路径</span><br><span class="hljs-keyword">local</span> common=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;common&quot;</span>)<br><span class="hljs-keyword">local</span> read_http=common.read_http<br><span class="hljs-keyword">local</span> read_redis=common.read_redis<br><span class="hljs-comment">-- 封装查询函数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key,path,params)</span></span><br>    <span class="hljs-comment">-- 查询redis</span><br>    <span class="hljs-keyword">local</span> resp=read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">6379</span>,key)<br>    <span class="hljs-comment">-- 判断查询结果</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>        <span class="hljs-comment">-- redis查询失败，尝试查询tomcat</span><br>        ngx.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;redis查询失败，尝试查询tomcat：&quot;</span>,key)<br>        resp=read_http(<span class="hljs-built_in">path</span>,params)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> resp<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 获取路径参数</span><br><span class="hljs-keyword">local</span> id=ngx.var[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- 查询商品信息</span><br><span class="hljs-keyword">local</span> itemJson=read_data(<span class="hljs-string">&quot;item:id:&quot;</span>..id , <span class="hljs-string">&quot;/item/&quot;</span>..id , <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- 查询库存信息</span><br><span class="hljs-keyword">local</span> stockJson=read_data(<span class="hljs-string">&quot;item:stock:id:&quot;</span>..id , <span class="hljs-string">&quot;/item/stock/&quot;</span>..id , <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- dto转换</span><br><span class="hljs-comment">-- json数据转换成lua中的table</span><br><span class="hljs-keyword">local</span> item=cjson.decode(itemJson)<br><span class="hljs-keyword">local</span> stock=cjson.decode(stockJson)<br><span class="hljs-comment">-- 组合数据</span><br>item.stock=stock.stock<br>item.sold=stock.sold<br><span class="hljs-comment">-- 返回结果</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure>
<p>更新Redis数据，重新查看网页，发现已经变成<code>22</code>寸了<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062026467.png" alt="image-20240506202615377" data-caption="image-20240506202615377" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062026232.png" alt="image-20240506202636120" data-caption="image-20240506202636120" loading="lazy"></p>
<h4 id="Nginx本地缓存"><a href="#Nginx本地缓存" class="headerlink" title="Nginx本地缓存"></a>Nginx本地缓存</h4><blockquote>
<p>优先查询<code>OpenResty本地缓存</code>，其次是Redis，最后是Tomcat</p>
<p>OpenResty为Nginx提供了<code>shard dict</code>的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。</p>
</blockquote>
<ul>
<li>开启共享字典，在nginx.conf的http下添加配置<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf"># 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m<br>lua_shared_dict item_cache 150m;<br></code></pre></td></tr></table></figure></li>
<li>操作共享字典<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 获取本地缓存对象</span><br><span class="hljs-keyword">local</span> item_cache=ngx.shared.item_cache<br><span class="hljs-comment">-- 存储，指定key、value、过期时间，单位s，默认为0代表永不过期</span><br>item_cache:set(<span class="hljs-string">&#x27;key&#x27;</span>,<span class="hljs-string">&#x27;value&#x27;</span>,<span class="hljs-number">1000</span>)<br><span class="hljs-comment">-- 读取</span><br><span class="hljs-keyword">local</span> val=item_cache:get(<span class="hljs-string">&#x27;key&#x27;</span>)<br></code></pre></td></tr></table></figure>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062044303.png" alt="image-20240506204425210" data-caption="image-20240506204425210" loading="lazy"><blockquote>
<p>修改<code>item.lua</code>，优先查询nginx本地缓存，其次是redis、tomcat、mysql</p>
<p>查询Redis、Tomcat成功后，将缓存信息写入本地缓存，并设置有效期</p>
<p>商品基本信息设置为有效期30min</p>
<p>库存信息设置为有效期1min</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入cjson库</span><br><span class="hljs-keyword">local</span> cjson=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cjson&quot;</span>)<br><span class="hljs-comment">-- 导入请求工具common</span><br><span class="hljs-comment">-- 这里common.lua正好在lualib目录下，所以可以直接导入;如果不是，则需要写上路径</span><br><span class="hljs-keyword">local</span> common=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;common&quot;</span>)<br><span class="hljs-keyword">local</span> read_http=common.read_http<br><span class="hljs-keyword">local</span> read_redis=common.read_redis<br><span class="hljs-keyword">local</span> item_cache=ngx.shared.item_cache<br><span class="hljs-comment">-- 封装查询函数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key,expire,path,params)</span></span><br>    <span class="hljs-comment">-- 查询本地缓存</span><br>    <span class="hljs-keyword">local</span> val=item_cache:get(key)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> val <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR,<span class="hljs-string">&quot;本地缓存查询失败，尝试查询redis，key:&quot;</span>,key)<br>        <span class="hljs-comment">-- 查询redis</span><br>        val=read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">6379</span>,key)<br>        <span class="hljs-comment">-- 判断查询结果</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> val <span class="hljs-keyword">then</span><br>            <span class="hljs-comment">-- redis查询失败，尝试查询tomcat</span><br>            ngx.<span class="hljs-built_in">log</span>(ngx.ERR,<span class="hljs-string">&quot;redis查询失败，尝试查询tomcat，key:&quot;</span>,key)<br>            val=read_http(<span class="hljs-built_in">path</span>,params)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- 查询成功，把数据写入本地缓存</span><br>    item_cache:set(key,val,expire)<br>    <span class="hljs-keyword">return</span> val<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 获取路径参数</span><br><span class="hljs-keyword">local</span> id=ngx.var[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- 查询商品信息</span><br><span class="hljs-keyword">local</span> itemJson=read_data(<span class="hljs-string">&quot;item:id:&quot;</span>..id,<span class="hljs-number">1800</span>,<span class="hljs-string">&quot;/item/&quot;</span>..id,<span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- 查询库存信息</span><br><span class="hljs-keyword">local</span> stockJson=read_data(<span class="hljs-string">&quot;item:stock:id:&quot;</span>..id,<span class="hljs-number">60</span>,<span class="hljs-string">&quot;/item/stock/&quot;</span>..id,<span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- dto转换</span><br><span class="hljs-comment">-- json数据转换成lua中的table</span><br><span class="hljs-keyword">local</span> item=cjson.decode(itemJson)<br><span class="hljs-keyword">local</span> stock=cjson.decode(stockJson)<br><span class="hljs-comment">-- 组合数据</span><br>item.stock=stock.stock<br>item.sold=stock.sold<br><span class="hljs-comment">-- 返回结果</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="缓存同步"><a href="#缓存同步" class="headerlink" title="缓存同步"></a>缓存同步</h2><p>缓存数据同步的常见方式有三种:</p>
<ul>
<li>设置有效期:给缓存设置有效期，到期后自动删除。再次查询时更新<ul>
<li>优势:简单、方便</li>
<li>缺点:时效性差，缓存过期之前可能不-致</li>
<li>场景:更新频率较低，时效性要求低的业务</li>
</ul>
</li>
<li>同步双写: 在修改数据库的同时，直接修改缓存<ul>
<li>优势:时效性强，缓存与数据库强一致</li>
<li>缺点:有代码侵入,耦合度高;</li>
<li>场景:对一致性、时效性要求较高的缓存数据</li>
</ul>
</li>
<li>异步通知:修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据<ul>
<li>优势:低耦合，可以同时通知多个缓存服务</li>
<li>缺点:时效性一般，可能存在中间不一致状态</li>
<li>场景:时效性要求-般，有多个服务需要同步<blockquote>
<p>基于MQ的异步通知<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062124605.png" alt="image-20240506212404397" data-caption="image-20240506212404397" loading="lazy"><br>基于Canal的异步通知<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062125223.png" alt="image-20240506212506025" data-caption="image-20240506212506025" loading="lazy"><br>Canal是基于mysql的主从同步来实现的，MySQL主从同步的原理如下:</p>
</blockquote>
</li>
</ul>
</li>
<li>MySQL master将数据变更写入二进制日志( binary log)，其中记录的数据叫做binary log events</li>
<li>MySQL slave将master的binary log events拷贝到它的中继日志(relay log)</li>
<li>MySQL slave重放relay log中事件,将数据变更反映它自己的数据<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062127347.png" alt="image-20240506212739255" data-caption="image-20240506212739255" loading="lazy"></li>
</ul>
<h3 id="初识Canal"><a href="#初识Canal" class="headerlink" title="初识Canal"></a>初识Canal</h3><p>Canal就是把自己伪装成MySQL的一个slave节 点,从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端，进而完成对其它数据库的同步。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405062128659.png" alt="image-20240506212852571" data-caption="image-20240506212852571" loading="lazy"></p>
<h3 id="开启MySQL主从"><a href="#开启MySQL主从" class="headerlink" title="开启MySQL主从"></a>开启MySQL主从</h3><blockquote>
<p>修改配置文件</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/tmp/my</span>sql<span class="hljs-regexp">/conf/my</span>.cnf<br></code></pre></td></tr></table></figure>
<p>添加内容</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">log-bin=<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/mysql/my</span>sql-bin<br>binlog-<span class="hljs-keyword">do</span>-db=heima<br></code></pre></td></tr></table></figure>
<p>重启mysql</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker restart mysql-demo<br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070800294.png" alt="image-20240507080007082" data-caption="image-20240507080007082" loading="lazy"></p>
<h3 id="设置用户权限"><a href="#设置用户权限" class="headerlink" title="设置用户权限"></a>设置用户权限</h3><p>接下来添加一个用于数据同步的用户，出于安全的考虑，这里仅提供对<code>heima</code>这个库的操作权限</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> canal@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;canal&#x27;</span>;<br><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, REPLICATION SLAVE, REPLICATION CLIENT,SUPER <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;canal&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;canal&#x27;</span>;<br>FLUSH PRIVILEGES;<br></code></pre></td></tr></table></figure>
<p>执行成功后，查看到该用户<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070803813.png" alt="image-20240507080342715" data-caption="image-20240507080342715" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070804039.png" alt="image-20240507080458864" data-caption="image-20240507080458864" loading="lazy"></p>
<blockquote>
<p>如果从库的<code>position</code>小于主库的<code>position</code>，则证明有数据需要同步</p>
</blockquote>
<h3 id="创建网络"><a href="#创建网络" class="headerlink" title="创建网络"></a>创建网络</h3><p>我们需要创建一个网络，将MySQL、Canal、MQ放到同一个Docker网络中：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker network create heima<br></code></pre></td></tr></table></figure>
<p>让mysql加入这个网络：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker network connect heima mysql-demo<br></code></pre></td></tr></table></figure>
<p>然后运行命令创建Canal容器：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker run -p 11111:11111 --name canal \<br>-e canal.destinations=heima \<br>-e canal.instance.master.address=mysql-demo:3306  \<br>-e canal.instance.dbUsername=canal  \<br>-e canal.instance.dbPassword=canal  \<br>-e canal.instance.connectionCharset=UTF-8 \<br>-e canal.instance.tsdb.enable=<span class="hljs-literal">true</span> \<br>-e canal.instance.gtidon=<span class="hljs-literal">false</span>  \<br>-e canal.instance.filter.regex=heima\\..* \<br>--network heima \<br>-d canal/canal-server:v1.1.5<br></code></pre></td></tr></table></figure>
<p>说明:</p>
<ul>
<li><code>-p 11111:11111</code>：这是canal的默认监听端口</li>
<li><code>-e canal.instance.master.address=mysql:3306</code>：数据库地址和端口，如果不知道mysql容器地址，可以通过<code>docker inspect 容器id</code>来查看</li>
<li><code>-e canal.instance.dbUsername=canal</code>：数据库用户名</li>
<li><code>-e canal.instance.dbPassword=canal</code> ：数据库密码</li>
<li><code>-e canal.instance.filter.regex=</code>：要监听的表名称<br>表名称监听支持的语法：<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown">mysql 数据解析关注的表，Perl正则表达式.<br>多个正则之间以逗号(,)分隔，转义符需要双斜杠(\\) <br>常见例子：<br><span class="hljs-bullet">1.</span>  所有表：.*   or  .<span class="hljs-emphasis">*\\..*</span><br><span class="hljs-bullet">2.</span>  canal schema下所有表： canal\\..*<br><span class="hljs-bullet">3.</span>  canal下的以canal打头的表：canal\\.canal.*<br><span class="hljs-bullet">4.</span>  canal schema下的一张表：canal.test1<br><span class="hljs-bullet">5.</span>  多个规则组合使用然后以逗号隔开：canal\\..<span class="hljs-emphasis">*,mysql.test1,mysql.test2 </span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>查看是否互联成功</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it canal /bin/bash<br><span class="hljs-comment"># 查看运行日志</span><br>more /home/admin/canal-server/logs/canal/canal.log<br>more /home/admin/canal-server/logs/heima/heima.log<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="监听Canal实现缓存同步"><a href="#监听Canal实现缓存同步" class="headerlink" title="监听Canal实现缓存同步"></a>监听Canal实现缓存同步</h3><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>top.javatool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>canal-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.1-RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>编写配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">canal:</span><br>  <span class="hljs-comment"># canal实例名称，要跟canal-server运行时设置的destination一致</span><br>  <span class="hljs-attr">destination:</span> <span class="hljs-string">heima</span><br>  <span class="hljs-comment"># canal地址</span><br>  <span class="hljs-attr">server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.10</span><span class="hljs-string">:11111</span><br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070826797.png" alt="image-20240507082657564" data-caption="image-20240507082657564" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.heima.item.pojo.Item;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> top.javatool.canal.client.annotation.CanalTable;<br><span class="hljs-keyword">import</span> top.javatool.canal.client.handler.EntryHandler;<br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@CanalTable(&quot;tb_item&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EntryHandler</span>&lt;Item&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Item item)</span> &#123;<br>        <span class="hljs-comment">// 新增数据到redis</span><br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Item before, Item after)</span> &#123;<br>        <span class="hljs-comment">// 更新redis数据</span><br>        <span class="hljs-comment">// 更新本地数据</span><br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Item item)</span> &#123;<br>        <span class="hljs-comment">// 删除redis数据</span><br>        <span class="hljs-comment">// 清理本地缓存</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>此时<code>Canal</code>还无法将表的字段映射到对应的<code>DTO</code>，需要添加<code>Canal</code>的注解进行指定<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/202405070829863.png" alt="image-20240507082940638" data-caption="image-20240507082940638" loading="lazy"></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;<br><span class="hljs-keyword">import</span> org.springframework.data.annotation.Transient;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;tb_item&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 商品id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 商品名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 商品标题</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String title;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 价格（分）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long price;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 商品图片</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String image;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分类名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String category;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 品牌名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String brand;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 规格</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String spec;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 商品状态 1-正常，2-下架</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer status;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br>    <span class="hljs-meta">@Transient</span><br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-keyword">private</span> Integer stock;<br>    <span class="hljs-meta">@Transient</span><br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-keyword">private</span> Integer sold;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate template;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemService itemService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemStockService stockService;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">MAPPER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 初始化缓存</span><br>        <span class="hljs-comment">// 1.查询商品信息</span><br>        List&lt;Item&gt; itemList = itemService.list();<br>        <span class="hljs-comment">// 2.存入缓存</span><br>        <span class="hljs-keyword">for</span> (Item item : itemList) &#123;<br>            <span class="hljs-comment">// 将item序列化成json</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> MAPPER.writeValueAsString(item);<br>            <span class="hljs-comment">// 存入缓存</span><br>            template.opsForValue().set(<span class="hljs-string">&quot;item:id:&quot;</span>+item.getId(),json);<br>        &#125;<br>        <span class="hljs-comment">// 3.查询库存信息</span><br>        List&lt;ItemStock&gt; stockList = stockService.list();<br>        <span class="hljs-comment">// 2.存入缓存</span><br>        <span class="hljs-keyword">for</span> (ItemStock stock : stockList) &#123;<br>            <span class="hljs-comment">// 将item序列化成json</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> MAPPER.writeValueAsString(stock);<br>            <span class="hljs-comment">// 存入缓存</span><br>            template.opsForValue().set(<span class="hljs-string">&quot;item:stock:id:&quot;</span>+stock.getId(),json);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存项目</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> item 项目</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveItem</span><span class="hljs-params">(Item item)</span>&#123;<br>        <span class="hljs-comment">// 将item序列化成json</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            json = MAPPER.writeValueAsString(item);<br>        &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        template.opsForValue().set(<span class="hljs-string">&quot;item:id:&quot;</span>+item.getId(),json);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按 ID 删除项目</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeItemById</span><span class="hljs-params">(Long id)</span>&#123;<br>        template.delete(<span class="hljs-string">&quot;item:id:&quot;</span>+id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Cache;<br><span class="hljs-keyword">import</span> com.heima.item.config.RedisHandler;<br><span class="hljs-keyword">import</span> com.heima.item.pojo.Item;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> top.javatool.canal.client.annotation.CanalTable;<br><span class="hljs-keyword">import</span> top.javatool.canal.client.handler.EntryHandler;<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@CanalTable(&quot;tb_item&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EntryHandler</span>&lt;Item&gt; &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisHandler redisHandler;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long,Item&gt; itemCache;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Item item)</span> &#123;<br>        <span class="hljs-comment">// 新增数据到JVM进程缓存</span><br>        log.info(<span class="hljs-string">&quot;新增数据到JVM进程缓存&quot;</span>);<br>        itemCache.put(item.getId(),item);<br>        <span class="hljs-comment">// 新增数据到redis</span><br>        log.info(<span class="hljs-string">&quot;新增数据到redis&quot;</span>);<br>        redisHandler.saveItem(item);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Item before, Item after)</span> &#123;<br>        <span class="hljs-comment">// 更新JVM进程缓存</span><br>        log.info(<span class="hljs-string">&quot;更新JVM进程缓存&quot;</span>);<br>        itemCache.put(after.getId(),after);<br>        <span class="hljs-comment">// 更新redis数据</span><br>        log.info(<span class="hljs-string">&quot;更新redis数据&quot;</span>);<br>        redisHandler.saveItem(after);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Item item)</span> &#123;<br>        <span class="hljs-comment">// 删除JVM进程缓存</span><br>        log.info(<span class="hljs-string">&quot;删除JVM进程缓存&quot;</span>);<br>        itemCache.invalidate(item.getId());<br>        <span class="hljs-comment">// 删除redis数据</span><br>        log.info(<span class="hljs-string">&quot;删除redis数据&quot;</span>);<br>        redisHandler.removeItemById(item.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>访问<code>http://localhost:8081/</code>进行后台管理，修改数据后，访问<code>http://localhost:8081/item/10001</code>和<code>redis</code>发现数据已经修改</p>
</blockquote>

    
  </article>

  
      

  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
</div>
  
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
    data-repo="nexmoe/nexmoe.com"
    data-repo-id="R_kgDOJI1XUA"
    data-category="General"
    data-category-id="DIC_kwDOJI1XUM4CU1nn"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>

      </div>
  
</div>
</div>
        <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="toc-number">1.</span> <span class="toc-text">多级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">传统缓存的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88"><span class="toc-number">1.2.</span> <span class="toc-text">多级缓存方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL"><span class="toc-number">1.3.1.</span> <span class="toc-text">MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.2.</span> <span class="toc-text">运行命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E7%BC%93%E5%AD%98"><span class="toc-number">1.4.</span> <span class="toc-text">本地进程缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E8%AF%AD%E6%B3%95%E5%85%A5%E9%97%A8"><span class="toc-number">1.5.</span> <span class="toc-text">Lua语法入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">1.5.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.2.</span> <span class="toc-text">函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">1.5.3.</span> <span class="toc-text">条件控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98-1"><span class="toc-number">1.6.</span> <span class="toc-text">多级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenRestry"><span class="toc-number">1.6.1.</span> <span class="toc-text">OpenRestry</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">入门</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">请求参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85http%E8%AF%B7%E6%B1%82%E5%B7%A5%E5%85%B7"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">封装http请求工具</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E9%9B%86%E7%BE%A4%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.6.2.</span> <span class="toc-text">Tomcat集群的负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0Redis%E9%9C%80%E6%B1%82"><span class="toc-number">1.6.3.</span> <span class="toc-text">添加Redis需求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%B7%E5%90%AF%E5%8A%A8%E4%B8%8E%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">冷启动与缓存预热</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2Redis%E7%BC%93%E5%AD%98"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">查询Redis缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">Nginx本地缓存</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%90%8C%E6%AD%A5"><span class="toc-number">1.7.</span> <span class="toc-text">缓存同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E8%AF%86Canal"><span class="toc-number">1.7.1.</span> <span class="toc-text">初识Canal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AFMySQL%E4%B8%BB%E4%BB%8E"><span class="toc-number">1.7.2.</span> <span class="toc-text">开启MySQL主从</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-number">1.7.3.</span> <span class="toc-text">设置用户权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C"><span class="toc-number">1.7.4.</span> <span class="toc-text">创建网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%ACCanal%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E5%90%8C%E6%AD%A5"><span class="toc-number">1.7.5.</span> <span class="toc-text">监听Canal实现缓存同步</span></a></li></ol></li></ol></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
    </div>
    <div id="nexmoe-search-space">
	<div class="search-container">
		<div class="search-header">
			<div class="search-input-container">
				<input
					class="search-input"
					type="text"
					placeholder="搜索"
					oninput="sinput();"
				/>
			</div>
			<a class="search-close" onclick="sclose();">×</a>
		</div>
		<div class="search-body"></div>
	</div>
</div>

    
    
</body>

</html>
