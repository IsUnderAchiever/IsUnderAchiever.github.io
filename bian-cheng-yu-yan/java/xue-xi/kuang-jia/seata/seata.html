<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>Seata - 折影轻梦</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="折影轻梦,Mixcm,轻惋,觅漫者,小舒同学,Xiaoshu,Nexmoe,产品,Meteor,探索者小舒,伴学OS1,Theme,Design,Product">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <meta name="description" content="Seata概念事务的ACID原则  原子性事务中的所有操作，要么全部成功,要么全部失败 一致性要保证数据库内部完整性约束、声明性约束 隔离性对同一资源操作的事务不能同时发生 持久性对数据库做的一切修改将永久保存,不管是否出现故障  案例微服务下单业务，在下单时会调用订单服务，创建订单并写入数据库。然后订单服务调用账户服务和库存服务:  账户服务负责扣减用户余额 库存服务负责扣减商品库存 我们希望创">
<meta property="og:type" content="article">
<meta property="og:title" content="Seata">
<meta property="og:url" content="https://isunderachiever.github.io/bian-cheng-yu-yan/java/xue-xi/kuang-jia/seata/seata.html">
<meta property="og:site_name" content="折影轻梦">
<meta property="og:description" content="Seata概念事务的ACID原则  原子性事务中的所有操作，要么全部成功,要么全部失败 一致性要保证数据库内部完整性约束、声明性约束 隔离性对同一资源操作的事务不能同时发生 持久性对数据库做的一切修改将永久保存,不管是否出现故障  案例微服务下单业务，在下单时会调用订单服务，创建订单并写入数据库。然后订单服务调用账户服务和库存服务:  账户服务负责扣减用户余额 库存服务负责扣减商品库存 我们希望创">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240410224007195.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240410224108029.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411202324161.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411214609610.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411220655902.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411220800785.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411221346303.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411221519897.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411221600202.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411221941042.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411222047176.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411222133028.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411222243057.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411223154817.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411223721605.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412070658420.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071007499.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071132954.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071236353.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071551150.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071916161.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071937524.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412072014359.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412072736505.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412073342542.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412073612996.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412073639729.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412073752159.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412075025182.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412075111494.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412075313338.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412080441953.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412080512334.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412081358601.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412081715928.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412210846377.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412211854987.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/QQ%E5%9B%BE%E7%89%8720240412212956.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413063600514.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413063809543.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413065417807.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413070301607.png">
<meta property="og:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413205630731.png">
<meta property="article:published_time" content="2024-04-16T00:31:00.000Z">
<meta property="article:modified_time" content="2024-06-01T14:32:53.515Z">
<meta property="article:author" content="折影轻梦">
<meta property="article:tag" content="Seata">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240410224007195.png">
    
<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1717340472209">
    
    <link rel="stylesheet" href="/css/style.css?v=1717340472209">

    
        
            <link rel="stylesheet" href="/custom.css?v=1717340472209">
        
    

    
<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>


    <script async src="/js/app.js?v=1717340472209"></script>
    
     

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4D4ZJ9G024"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());

  gtag("config", "G-4D4ZJ9G024");
</script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
    <div id="nexmoe-background">
        <div class="nexmoe-bg" 
            style="background-image: url(https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102206.jpg)"
        ></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="折影轻梦" class="mdui-btn mdui-btn-icon"><img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102017.jpg" alt="折影轻梦"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="折影轻梦">
            <img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102017.jpg" alt="折影轻梦" alt="折影轻梦">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>169</div>
        <div><span>标签</span>62</div>
        <div><span>分类</span>63</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/life.html" title="我的生活">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的生活
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
        
            
            <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        
            <form id="search_form">
                <label><input class="st-default-search-input" id="search_value" name="q" type="search" placeholder="搜索" style="
                    font-size: 15px !important;
                    height: 56px !important;
                    background-image: none;
                "></label>
            </form>
         
    </div>
</div>


	<script async src="/js/search.js?v=1717340472209"></script>



        
            
            <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="https://github.com/IsUnderAchiever/"
			target="_blank"
			mdui-tooltip="{content: 'QQ群'}"
			style="
				color: rgb(249, 174, 8);
				background-color: rgba(249, 174, 8, .1);
			"
		>
			<i
				class="nexmoefont icon-QQ"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://space.bilibili.com/477448861/"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		>
	</div>
</div>

        
            
            
            
            
            
            
    </aside>
    <div class="nexmoe-copyright">
        &copy; 2024 折影轻梦
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
    <div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover"> 
            <img src="https://raw.githubusercontent.com/IsUnderAchiever/blog-img/master/about/202309161102206.jpg" alt="Seata" loading="lazy">
            <h1>Seata</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2024年04月16日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/Seata/">Seata</a>
        
        
    </div>
    
    
    
    
    
</div>

    <h1 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h3 id="事务的ACID原则"><a href="#事务的ACID原则" class="headerlink" title="事务的ACID原则"></a>事务的ACID原则</h3><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240410224007195.png" alt="image-20240410224007195" data-caption="image-20240410224007195" loading="lazy"></p>
<ol>
<li>原子性<br>事务中的所有操作，要么全部成功,要么全部失败</li>
<li>一致性<br>要保证数据库内部完整性约束、声明性约束</li>
<li>隔离性<br>对同一资源操作的事务不能同时发生</li>
<li>持久性<br>对数据库做的一切修改将永久保存,不管是否出现故障</li>
</ol>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>微服务下单业务，在下单时会调用订单服务，创建订单并写入数据库。然后订单服务调用账户服务和库存服务:</p>
<ul>
<li>账户服务负责扣减用户余额</li>
<li>库存服务负责扣减商品库存<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240410224108029.png" alt="image-20240410224108029" data-caption="image-20240410224108029" loading="lazy"><blockquote>
<p>我们希望<code>创建订单</code>、<code>扣减余额</code>、<code>扣件商品库存</code>三个操作<code>同时成功或者失败</code><br><strong>这里新建三个数据库</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411202324161.png" alt="image-20240411202324161" data-caption="image-20240411202324161" loading="lazy"><br><strong>sentinel_account</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> account_tbl<br>(<br>    id      <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;账户编号&#x27;</span><br>        <span class="hljs-keyword">primary</span> key,<br>    user_id <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)               <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;用户编号&#x27;</span>,<br>    money   <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) unsigned <span class="hljs-keyword">default</span> <span class="hljs-number">0</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;余额&#x27;</span><br>)<br>    comment <span class="hljs-string">&#x27;账户表&#x27;</span> charset <span class="hljs-operator">=</span> utf8<br>                     row_format <span class="hljs-operator">=</span> COMPACT;<br>                     <br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> sentinel_account.account_tbl (id, user_id, money) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;user202103032042012&#x27;</span>, <span class="hljs-number">1000</span>);<br></code></pre></td></tr></table></figure>
<strong>sentinel_order</strong><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> order_tbl<br>(<br>    id             <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;订单编号&#x27;</span><br>        <span class="hljs-keyword">primary</span> key,<br>    user_id        <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;用户编号&#x27;</span>,<br>    commodity_code <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;商品编码&#x27;</span>,<br>    count          <span class="hljs-type">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;数量&#x27;</span>,<br>    money          <span class="hljs-type">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;金额&#x27;</span><br>)<br>    comment <span class="hljs-string">&#x27;订单表&#x27;</span> charset <span class="hljs-operator">=</span> utf8<br>                     row_format <span class="hljs-operator">=</span> COMPACT;<br></code></pre></td></tr></table></figure>
<strong>sentinel_storage</strong><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> storage_tbl<br>(<br>    id             <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;库存编号&#x27;</span><br>        <span class="hljs-keyword">primary</span> key,<br>    commodity_code <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)               <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;商品编码&#x27;</span>,<br>    count          <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) unsigned <span class="hljs-keyword">default</span> <span class="hljs-number">0</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;库存数量&#x27;</span>,<br>    <span class="hljs-keyword">constraint</span> commodity_code<br>        <span class="hljs-keyword">unique</span> (commodity_code)<br>)<br>    comment <span class="hljs-string">&#x27;库存表&#x27;</span> charset <span class="hljs-operator">=</span> utf8<br>                     row_format <span class="hljs-operator">=</span> COMPACT;<br>                     <br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> sentinel_storage.storage_tbl (id, commodity_code, count) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;100202003032041&#x27;</span>, <span class="hljs-number">10</span>);<br></code></pre></td></tr></table></figure>
<blockquote>
<p>基础项目的<a target="_blank" rel="noopener" href="https://gitee.com/tongstyle/seata-demo">链接</a><br><strong>调用<code>client</code>实现<code>扣余额</code>、<code>扣库存</code></strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411214609610.png" alt="image-20240411214609610" data-caption="image-20240411214609610" loading="lazy"><br>使用<code>ApiFox</code>测试订单创建请求<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411220655902.png" alt="image-20240411220655902" data-caption="image-20240411220655902" loading="lazy"><br>看看数据，发现该商品还剩下10个<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411220800785.png" alt="image-20240411220800785" data-caption="image-20240411220800785" loading="lazy"><br>我们直接买20个，正常来讲<code>库存不足</code>应该要<code>失败</code>，这次用户要跟账户表保持一致<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411221346303.png" alt="image-20240411221346303" data-caption="image-20240411221346303" loading="lazy"><br>报错<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411221519897.png" alt="image-20240411221519897" data-caption="image-20240411221519897" loading="lazy"><br>刷新之后发现，库存表数量没变<code>(扣减失败)</code>，但是账户表<code>金额</code>被扣了<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411221600202.png" alt="image-20240411221600202" data-caption="image-20240411221600202" loading="lazy"><br><strong>它们每个服务是独立的</strong>，各自提交自己的事务，所以并没有达成事务的一致<br><strong><code>总结：在分布式系统下，一个业务跨越多个服务或数据源，每个服务都是一个分支事务， 要保证所有分支事务最终状态一致,这样的事务就是分布式事务。</code></strong></p>
</blockquote>
</li>
</ul>
<h2 id="理论知识"><a href="#理论知识" class="headerlink" title="理论知识"></a>理论知识</h2><h3 id="CAP定理"><a href="#CAP定理" class="headerlink" title="CAP定理"></a>CAP定理</h3><p>1998年，加州大学的计算机科学家Eric Brewer提出，分布式系统有三个指标:</p>
<ol>
<li>Consistency (<code>一致性</code>)</li>
<li>Availability (<code>可用性</code>)</li>
<li>Partition tolerance (<code>分区容错性</code>)<br>Eric Brewer说，分布式系统无法<code>同时满足</code>这三个指标。这个结论就叫做<code>CAP定理</code>。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411221941042.png" alt="image-20240411221941042" data-caption="image-20240411221941042" loading="lazy"></li>
</ol>
<h4 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h4><p>Consistency (一致性) :用户访问分布式系统中的任意节点,得到的数据必须一致<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411222047176.png" alt="image-20240411222047176" data-caption="image-20240411222047176" loading="lazy"></p>
<h4 id="可用性"><a href="#可用性" class="headerlink" title="可用性"></a>可用性</h4><p>Availability (可用性) :用户访问集群中的任意健康节点,必须能得到响应，而不是超时或拒绝<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411222133028.png" alt="image-20240411222133028" data-caption="image-20240411222133028" loading="lazy"></p>
<h4 id="分区容错"><a href="#分区容错" class="headerlink" title="分区容错"></a>分区容错</h4><p>Partition (分区) :因为网络故障或其它原因导致分布式系统中的部分节点与其它节点失去连接，形成独立分区。<br>Tolerance (容错) :在集群出现分区时,整个系统也要持续对外提供服务<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411222243057.png" alt="image-20240411222243057" data-caption="image-20240411222243057" loading="lazy"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>分布式系统节点通过网络连接，一定会出现分区问题(P)，当分区出现时，系统的一致性(C)和可用性(A)就无法同时满足</p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>elasticsearch集群是CP还是AP?<br>ES集群出现分区时，故障节点会被剔除集群，数据分片会重新分配到其它节点，保证数据一致。因此是低可用性，高一致性，属于CP</p>
<h3 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><p>BASE理论是对CAP的一种解决思路,包含三个思想:<br><code>Basically Available</code>(<strong><code>基本可用</code></strong>) :分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。<br><code>SoftState</code> (<strong><code>软状态</code></strong>) :在一定时间内，允许出现中间状态，比如临时的不一致状态。<br><code>Eventually Consistent</code> (<strong><code>最终一致性</code></strong>) :虽然无法保证强-致性,但是在软状态结束后，最终达到数据一致。<br>而分布式事务最大的问题是各个子事务的一致性问题，因此可以<strong>借鉴CAP定理和BASE理论</strong>:<br><code>AP模式</code>:各子事务分别执行和提交,允许出现结果不一致,然后采用弥补措施<code>恢复数据</code>即可，实现<code>最终一致</code>。<br><code>CP模式</code>:各个子事务执行后互相等待，同时提交,同时回滚,达成<code>强一致</code>。但事务等待过程中,处于弱可用状态。因为会锁定资源导致无法访问</p>
<h4 id="分布式事务模型"><a href="#分布式事务模型" class="headerlink" title="分布式事务模型"></a>分布式事务模型</h4><p>解决分布式事务，各个子系统之间必须能感知到彼此的事务状态，才能保证状态一致，因此需要一个事务协调者来协调每一个事务的参与者(子系统事务)。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411223154817.png" alt="image-20240411223154817" data-caption="image-20240411223154817" loading="lazy"></p>
<blockquote>
<p>这里的子系统事务，称为分支事务;有关联的各个分支事务在一起称为全局事务</p>
</blockquote>
<h2 id="初识Seata"><a href="#初识Seata" class="headerlink" title="初识Seata"></a>初识Seata</h2><h3 id="Seata架构"><a href="#Seata架构" class="headerlink" title="Seata架构"></a>Seata架构</h3><p>Seata事务管理中有三个重要的角色:</p>
<ol>
<li>TC (Transaction Coordinator) -事务协调者:维护全局和分支事务的状态，协调全局事务提交或回滚。</li>
<li>TM (Transaction Manager) -事务管理器:定义全局事务的范围、开始全局事务、提交或回滚全局事务。</li>
<li>RM (Resource Manager) -资源管理器:管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240411223721605.png" alt="image-20240411223721605" data-caption="image-20240411223721605" loading="lazy"><br>Seata提供了四种不同的分布式事务解决方案:</li>
</ol>
<ul>
<li>XA模式:强一致性分阶段事务模式，牺牲了一定的可用性，无业务侵入</li>
<li>TCC模式:最终一致的分阶段事务模式，有业务侵入</li>
<li>AT模式:最终一致的分阶段事务模式，无业务侵入，也是Seata的默认模式</li>
<li>SAGA模式:长事务模式，有业务侵入</li>
</ul>
<h3 id="安装Seata"><a href="#安装Seata" class="headerlink" title="安装Seata"></a>安装Seata</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p>前往Github<a target="_blank" rel="noopener" href="https://github.com/apache/incubator-seata">下载</a>，这里选择<code>seata-server-1.7.0</code>的版本</p>
<h4 id="配置nacos为注册中心和配置中心"><a href="#配置nacos为注册中心和配置中心" class="headerlink" title="配置nacos为注册中心和配置中心"></a>配置nacos为注册中心和配置中心</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412070658420.png" alt="image-20240412070658420" data-caption="image-20240412070658420" loading="lazy"></p>
<blockquote>
<p><code>application.example.yml</code>的配置很全，我们copy需要的配置到<code>application.yml</code>即可<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071007499.png" alt="image-20240412071007499" data-caption="image-20240412071007499" loading="lazy"><br><strong>修改后的配置</strong></p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#  Copyright 1999-2019 Seata.io Group.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment">#  you may not use this file except in compliance with the License.</span><br><span class="hljs-comment">#  You may obtain a copy of the License at</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#  http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#  Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment">#  See the License for the specific language governing permissions and</span><br><span class="hljs-comment">#  limitations under the License.</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">7091</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">seata-server</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">classpath:logback-spring.xml</span><br>  <span class="hljs-attr">file:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">$&#123;user.home&#125;/logs/seata</span><br>  <span class="hljs-attr">extend:</span><br>    <span class="hljs-attr">logstash-appender:</span><br>      <span class="hljs-attr">destination:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:4560</span><br>    <span class="hljs-attr">kafka-appender:</span><br>      <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:9092</span><br>      <span class="hljs-attr">topic:</span> <span class="hljs-string">logback_to_logstash</span><br><span class="hljs-attr">console:</span><br>  <span class="hljs-attr">user:</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">seata</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">seata</span><br><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-comment"># support: nacos 、 consul 、 apollo 、 zk  、 etcd3</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">d2455f6d-ed00-41ba-9915-09021bc0df6c</span><br>      <span class="hljs-comment"># group: SEATA_GROUP</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">context-path:</span><br>      <span class="hljs-comment">##if use MSE Nacos with auth, mutex with username/password attribute</span><br>      <span class="hljs-comment">#access-key:</span><br>      <span class="hljs-comment">#secret-key:</span><br>      <span class="hljs-attr">data-id:</span> <span class="hljs-string">seataServer.properties</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-comment"># support: nacos 、 eureka 、 redis 、 zk  、 consul 、 etcd3 、 sofa</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">preferred-networks:</span> <span class="hljs-number">30.240</span><span class="hljs-string">.*</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>      <span class="hljs-comment"># group: SEATA_GROUP</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">d2455f6d-ed00-41ba-9915-09021bc0df6c</span><br>      <span class="hljs-attr">cluster:</span> <span class="hljs-string">default</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">context-path:</span><br>      <span class="hljs-comment">##if use MSE Nacos with auth, mutex with username/password attribute</span><br>      <span class="hljs-comment">#access-key:</span><br>      <span class="hljs-comment">#secret-key:</span><br>  <span class="hljs-attr">store:</span><br>    <span class="hljs-comment"># support: file 、 db 、 redis</span><br>    <span class="hljs-attr">mode:</span> <span class="hljs-string">db</span><br><span class="hljs-comment">#  server:</span><br><span class="hljs-comment">#    service-port: 8091 #If not configured, the default is &#x27;$&#123;server.port&#125; + 1000&#x27;</span><br>  <span class="hljs-attr">security:</span><br>    <span class="hljs-attr">secretKey:</span> <span class="hljs-string">SeataSecretKey0c382ef121d778043159209298fd40bf3850a017</span><br>    <span class="hljs-attr">tokenValidityInMilliseconds:</span> <span class="hljs-number">1800000</span><br>    <span class="hljs-attr">ignore:</span><br>      <span class="hljs-attr">urls:</span> <span class="hljs-string">/,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.jpeg,/**/*.ico,/api/v1/auth/login</span><br></code></pre></td></tr></table></figure>
<p><strong>在<code>nacos</code>中新增配置</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071132954.png" alt="image-20240412071132954" data-caption="image-20240412071132954" loading="lazy"></p>
<blockquote>
<p>配置文件可以查看<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071236353.png" alt="image-20240412071236353" data-caption="image-20240412071236353" loading="lazy"><br><strong>新增配置如下</strong><br>下面除了<code>db</code>外的配置都是默认的，写到nacos是为了方便后期修改，<code>db之外的配置</code>不写也没事</p>
<p>这里的<code>driverClassName</code>我用的是<code>com.mysql.cj.jdbc.Driver</code>，注意修改成自己的数据库名、账号、密码</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 数据存储方式，db代表数据库</span><br><span class="hljs-attr">store.mode</span>=<span class="hljs-string">db</span><br><span class="hljs-attr">store.db.datasource</span>=<span class="hljs-string">druid</span><br><span class="hljs-attr">store.db.dbType</span>=<span class="hljs-string">mysql</span><br><span class="hljs-attr">store.db.driverClassName</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-attr">store.db.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span><br><span class="hljs-attr">store.db.user</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">store.db.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-attr">store.db.minConn</span>=<span class="hljs-string">5</span><br><span class="hljs-attr">store.db.maxConn</span>=<span class="hljs-string">30</span><br><span class="hljs-attr">store.db.globalTable</span>=<span class="hljs-string">global_table</span><br><span class="hljs-attr">store.db.branchTable</span>=<span class="hljs-string">branch_table</span><br><span class="hljs-attr">store.db.queryLimit</span>=<span class="hljs-string">100</span><br><span class="hljs-attr">store.db.lockTable</span>=<span class="hljs-string">lock_table</span><br><span class="hljs-attr">store.db.maxWait</span>=<span class="hljs-string">5000</span><br><span class="hljs-comment"># 事务、日志等配置</span><br><span class="hljs-attr">server.recovery.committingRetryPeriod</span>=<span class="hljs-string">1000</span><br><span class="hljs-attr">server.recovery.asynCommittingRetryPeriod</span>=<span class="hljs-string">1000</span><br><span class="hljs-attr">server.recovery.rollbackingRetryPeriod</span>=<span class="hljs-string">1000</span><br><span class="hljs-attr">server.recovery.timeoutRetryPeriod</span>=<span class="hljs-string">1000</span><br><span class="hljs-attr">server.maxCommitRetryTimeout</span>=<span class="hljs-string">-1</span><br><span class="hljs-attr">server.maxRollbackRetryTimeout</span>=<span class="hljs-string">-1</span><br><span class="hljs-attr">server.rollbackRetryTimeoutUnlockEnable</span>=<span class="hljs-string">false</span><br><span class="hljs-attr">server.undo.logSaveDays</span>=<span class="hljs-string">7</span><br><span class="hljs-attr">server.undo.logDeletePeriod</span>=<span class="hljs-string">86400000</span><br><span class="hljs-comment"># 客户端与服务端传输方式</span><br><span class="hljs-attr">transport.serialization</span>=<span class="hljs-string">seata</span><br><span class="hljs-attr">transport.compressor</span>=<span class="hljs-string">none</span><br><span class="hljs-comment"># 关闭metrics功能，提高性能</span><br><span class="hljs-attr">metrics.enabled</span>=<span class="hljs-string">false</span><br><span class="hljs-attr">metrics.registryType</span>=<span class="hljs-string">compact</span><br><span class="hljs-attr">metrics.exporterList</span>=<span class="hljs-string">prometheus</span><br><span class="hljs-attr">metrics.exporterPrometheusPort</span>=<span class="hljs-string">9898</span><br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071551150.png" alt="image-20240412071551150" data-caption="image-20240412071551150" loading="lazy"></p>
<blockquote>
<p>db配置，注意这里新增一个<code>undo_log</code>表，该表的建表语句在sql中不存在</p>
<p><strong>完整sql如下</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span><br><span class="hljs-comment">-- the table to store GlobalSession data</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `global_table`<br>(<br>    `xid`                       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `transaction_id`            <span class="hljs-type">BIGINT</span>,<br>    `status`                    TINYINT      <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `application_id`            <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),<br>    `transaction_service_group` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),<br>    `transaction_name`          <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>),<br>    `timeout`                   <span class="hljs-type">INT</span>,<br>    `begin_time`                <span class="hljs-type">BIGINT</span>,<br>    `application_data`          <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">2000</span>),<br>    `gmt_create`                DATETIME,<br>    `gmt_modified`              DATETIME,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`xid`),<br>    KEY `idx_status_gmt_modified` (`status` , `gmt_modified`),<br>    KEY `idx_transaction_id` (`transaction_id`)<br>) ENGINE <span class="hljs-operator">=</span> InnoDB<br>  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4;<br><span class="hljs-comment">-- the table to store BranchSession data</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `branch_table`<br>(<br>    `branch_id`         <span class="hljs-type">BIGINT</span>       <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `xid`               <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `transaction_id`    <span class="hljs-type">BIGINT</span>,<br>    `resource_group_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),<br>    `resource_id`       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>),<br>    `branch_type`       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">8</span>),<br>    `status`            TINYINT,<br>    `client_id`         <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>),<br>    `application_data`  <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">2000</span>),<br>    `gmt_create`        DATETIME(<span class="hljs-number">6</span>),<br>    `gmt_modified`      DATETIME(<span class="hljs-number">6</span>),<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`branch_id`),<br>    KEY `idx_xid` (`xid`)<br>) ENGINE <span class="hljs-operator">=</span> InnoDB<br>  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4;<br><span class="hljs-comment">-- the table to store lock data</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `lock_table`<br>(<br>    `row_key`        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `xid`            <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>),<br>    `transaction_id` <span class="hljs-type">BIGINT</span>,<br>    `branch_id`      <span class="hljs-type">BIGINT</span>       <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `resource_id`    <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>),<br>    `table_name`     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),<br>    `pk`             <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">36</span>),<br>    `status`         TINYINT      <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;0:locked ,1:rollbacking&#x27;</span>,<br>    `gmt_create`     DATETIME,<br>    `gmt_modified`   DATETIME,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`row_key`),<br>    KEY `idx_status` (`status`),<br>    KEY `idx_branch_id` (`branch_id`),<br>    KEY `idx_xid` (`xid`)<br>) ENGINE <span class="hljs-operator">=</span> InnoDB<br>  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `distributed_lock`<br>(<br>    `lock_key`       <span class="hljs-type">CHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `lock_value`     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `expire`         <span class="hljs-type">BIGINT</span>,<br>    <span class="hljs-keyword">primary</span> key (`lock_key`)<br>) ENGINE <span class="hljs-operator">=</span> InnoDB<br>  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;AsyncCommitting&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;RetryCommitting&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;RetryRollbacking&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;TxTimeoutCheck&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment">-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `undo_log` (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `branch_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `xid` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `context` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `rollback_info` longblob <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `log_status` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `log_created` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `log_modified` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `ext` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>而且<code>业务数据库也需要增加该表</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071916161.png" alt="image-20240412071916161" data-caption="image-20240412071916161" loading="lazy"><br>双击<code>seata-server.bat</code>启动即可<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412071937524.png" alt="image-20240412071937524" data-caption="image-20240412071937524" loading="lazy"><br>服务已经注册到nacos中了<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412072014359.png" alt="image-20240412072014359" data-caption="image-20240412072014359" loading="lazy"><br>注意命名空间，我们springboot的demo是<code>public</code>的，所以需要将seata的命名空间改为<code>public</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412072736505.png" alt="image-20240412072736505" data-caption="image-20240412072736505" loading="lazy"></p>
</blockquote>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><blockquote>
<p>引入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>在<code>微服务</code>中新增如下配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>    <span class="hljs-attr">registry:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>        <span class="hljs-attr">nacos:</span><br>            <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>            <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span><br>            <span class="hljs-comment"># tc服务在nacos的注册名称</span><br>            <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>            <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>            <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-comment"># 事务组，根据这个获取tc服务的cluster名称</span><br>    <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">seata-demo</span><br>    <span class="hljs-attr">service:</span><br>        <span class="hljs-comment"># 事务组与TC服务cluster的映射关系</span><br>        <span class="hljs-attr">vgroup-mapping:</span><br>          <span class="hljs-attr">seata-demo:</span> <span class="hljs-string">SH</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>完整的配置如下</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8070</span><br><span class="hljs-attr">spring:</span><br>    <span class="hljs-attr">application:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">account-service</span><br>    <span class="hljs-attr">cloud:</span><br>        <span class="hljs-attr">nacos:</span><br>            <span class="hljs-attr">config:</span><br>                <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>            <span class="hljs-attr">discovery:</span><br>                <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>    <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">import:</span> <span class="hljs-string">nacos:nacos-config-example.properties?refresh=true</span><br>    <span class="hljs-attr">datasource:</span><br>        <span class="hljs-comment"># 数据库驱动：</span><br>        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-comment"># 数据库连接地址</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">defaultDataSource</span><br>        <span class="hljs-comment"># 数据库用户名&amp;密码：</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>        <span class="hljs-comment"># 数据源名称</span><br>        <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/sentinel_account?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8</span><br><span class="hljs-attr">mybatis-plus:</span><br>    <span class="hljs-attr">configuration:</span><br>        <span class="hljs-comment"># 配置mybatis-plus 打印sql日志</span><br>        <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br>        <span class="hljs-comment"># mybatis-plus下划线转驼峰配置，默认为true</span><br>        <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># xml文件路径</span><br>    <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:/mapper/**/*.xml</span><br>    <span class="hljs-comment"># 配置mybatis-plus 包路径</span><br>    <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.account.entity</span><br><span class="hljs-attr">seata:</span><br>    <span class="hljs-attr">registry:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>        <span class="hljs-attr">nacos:</span><br>            <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>            <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span><br>            <span class="hljs-comment"># tc服务在nacos的注册名称</span><br>            <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>            <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>            <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-comment"># 事务组，根据这个获取tc服务的cluster名称</span><br>    <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">seata-demo</span><br>    <span class="hljs-attr">service:</span><br>        <span class="hljs-comment"># 事务组与TC服务cluster的映射关系</span><br>        <span class="hljs-attr">vgroup-mapping:</span><br>          <span class="hljs-attr">seata-demo:</span> <span class="hljs-string">SH</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>如果需要锁定一个服务，我们需要确定以下四个配置</p>
<ol>
<li>命名空间</li>
<li>服务分组</li>
<li>服务名称</li>
<li>集群名称<br><strong>集群如下</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412073342542.png" alt="image-20240412073342542" data-caption="image-20240412073342542" loading="lazy"><br>再改一下<code>seata</code>的配置，配置<code>SH</code>集群<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412073612996.png" alt="image-20240412073612996" data-caption="image-20240412073612996" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412073639729.png" alt="image-20240412073639729" data-caption="image-20240412073639729" loading="lazy"><br>我们并没有在微服务的<code>application</code>文件中配置<code>cluster</code><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412073752159.png" alt="image-20240412073752159" data-caption="image-20240412073752159" loading="lazy"><br>并不能在<code>registry</code>下直接配置<code>cluster</code></li>
</ol>
<p>正确做法是配置<code>事务组</code>，将事务分组，比如<code>account</code>、<code>order</code>、<code>storage</code>将来会被同一个<code>tc</code>集群管理，所以需要将它们配置到同一个事务组下</p>
<p>再根据<code>事务组</code>获取到映射关系，最终找到<code>集群名称</code></p>
<p>这部分涉及到了<code>seata</code>的高可用，暂时不用过多深究<br><strong>启动服务</strong><br>启动微服务后，seata控命令窗口打印日志如下</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">RM register success,message:RegisterRMRequest&#123;<span class="hljs-attribute">resourceIds</span>=<span class="hljs-string">&#x27;jdbc:mysql://localhost:3306/sentinel_account&#x27;</span>, <span class="hljs-attribute">version</span>=<span class="hljs-string">&#x27;1.7.0-native-rc2&#x27;</span>, <span class="hljs-attribute">applicationId</span>=<span class="hljs-string">&#x27;account-service&#x27;</span>, <span class="hljs-attribute">transactionServiceGroup</span>=<span class="hljs-string">&#x27;seata-demo&#x27;</span>, <span class="hljs-attribute">extraData</span>=<span class="hljs-string">&#x27;null&#x27;</span>&#125;,channel:[id: 0xc06aa8c5, L:/192.168.56.1:8091 - R:/192.168.56.1:57929],client version:1.7.0-native-rc2<br></code></pre></td></tr></table></figure>
<h2 id="动手实践"><a href="#动手实践" class="headerlink" title="动手实践"></a>动手实践</h2><h3 id="XA模式"><a href="#XA模式" class="headerlink" title="XA模式"></a>XA模式</h3><h4 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h4><blockquote>
<p>XA规范是x&#x2F;Open组织定义的分布式事务处理(DTP, Distributed Transaction Processing)标准，XA规范描述了全局的TM与局部的RM之间的接口，几乎所有主流的数据库都对XA规范提供了支持。XA模式是一种强一致性、低可用性的模式<br><strong>正常情况</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412075025182.png" alt="image-20240412075025182" data-caption="image-20240412075025182" loading="lazy"><br><strong>异常情况</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412075111494.png" alt="image-20240412075111494" data-caption="image-20240412075111494" loading="lazy"></p>
</blockquote>
<h4 id="Seata中的XA模式"><a href="#Seata中的XA模式" class="headerlink" title="Seata中的XA模式"></a>Seata中的XA模式</h4><blockquote>
<p>seata的XA模式做了一些调整,但大体相似<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412075313338.png" alt="image-20240412075313338" data-caption="image-20240412075313338" loading="lazy"><br><strong>RM一阶段的工作</strong>:</p>
</blockquote>
<ol>
<li>注册分支事务到TC</li>
<li>执行分支业务sq|但不提交</li>
<li>报告执行状态到TC<br><strong>TC二阶段的工作</strong>:</li>
</ol>
<ul>
<li>TC检测各分支事务执行状态<br>​	a.如果都成功，通知所有RM提交事务<br>​	b.如果有失败，通知所有RM回滚事务<br><strong>RM二阶段的工作</strong>:<br>接收TC指令，提交或回滚事务</li>
</ul>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>XA模式的优点是什么?</p>
<ol>
<li>事务的强一致性,满足ACID原则。</li>
<li>常用数据库都支持，实现简单，并且没有代码侵入<br>XA模式的缺点是什么?</li>
<li>因为一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差</li>
<li>依赖关系型数据库实现事务(如redis就无法实现)</li>
</ol>
<h4 id="实现XA模式"><a href="#实现XA模式" class="headerlink" title="实现XA模式"></a>实现XA模式</h4><ol>
<li>修改<code>application.yml</code>文件，开启<code>XA</code>模式<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>    <span class="hljs-attr">registry:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>        <span class="hljs-attr">nacos:</span><br>            <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>            <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span><br>            <span class="hljs-comment"># tc服务在nacos的注册名称</span><br>            <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>            <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>            <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-comment"># 事务组，根据这个获取tc服务的cluster名称</span><br>    <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">seata-demo</span><br>    <span class="hljs-attr">service:</span><br>        <span class="hljs-comment"># 事务组与TC服务cluster的映射关系</span><br>        <span class="hljs-attr">vgroup-mapping:</span><br>            <span class="hljs-attr">seata-demo:</span> <span class="hljs-string">SH</span><br>  <span class="hljs-comment"># 开启XA模式</span><br>    <span class="hljs-attr">data-source-proxy-mode:</span> <span class="hljs-string">XA</span><br></code></pre></td></tr></table></figure></li>
<li>给发起全局事务的入口方法添加<code>@GlobalTransactional</code>注解<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AccountClient accountClient;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StorageClient storageClient;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderMapper orderMapper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderServiceImpl</span><span class="hljs-params">(AccountClient accountClient, StorageClient storageClient, OrderMapper orderMapper)</span> &#123;<br>        <span class="hljs-built_in">this</span>.accountClient = accountClient;<br>        <span class="hljs-built_in">this</span>.storageClient = storageClient;<br>        <span class="hljs-built_in">this</span>.orderMapper = orderMapper;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@GlobalTransactional</span><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">create</span><span class="hljs-params">(Order order)</span> &#123;<br>        <span class="hljs-comment">// 创建订单</span><br>        orderMapper.insert(order);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 扣用户余额</span><br>            accountClient.deduct(order.getUserId(), order.getMoney());<br>            <span class="hljs-comment">// 扣库存</span><br>            storageClient.deduct(order.getCommodityCode(), order.getCount());<br><br>        &#125; <span class="hljs-keyword">catch</span> (FeignException e) &#123;<br>            log.error(<span class="hljs-string">&quot;下单失败，原因:&#123;&#125;&quot;</span>, e.contentUTF8(), e);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e.contentUTF8(), e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> order.getId();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>重启服务并测试<br><strong>运行前的数据</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412080441953.png" alt="image-20240412080441953" data-caption="image-20240412080441953" loading="lazy"><br><strong>运行后的数据</strong><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412080512334.png" alt="image-20240412080512334" data-caption="image-20240412080512334" loading="lazy"><blockquote>
<p>可以看到实现了<code>全局事务</code></p>
</blockquote>
</li>
</ol>
<h3 id="AT模式"><a href="#AT模式" class="headerlink" title="AT模式"></a>AT模式</h3><h4 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h4><blockquote>
<p>AT模式同样是分阶段提交的事务模型，不过缺弥补了XA模型中资源锁定周期过长的缺陷。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412081358601.png" alt="image-20240412081358601" data-caption="image-20240412081358601" loading="lazy"><br>阶段一RM的工作:</p>
<ol>
<li>注册分支事务</li>
<li>记录<code>undo-log</code> (数据快照)</li>
<li>执行业务sql并提交</li>
<li>报告事务状态</li>
</ol>
<p>阶段二提交时RM的工作:<br>删除undo-log即可</p>
<p>阶段二回滚时RM的工作:<br>根据undo-log恢复数据到更新前<br><strong>案例如下</strong><br>一个分支业务的SQL是这样的: </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> tb account <span class="hljs-keyword">set</span> money <span class="hljs-operator">=</span> money<span class="hljs-operator">-</span> <span class="hljs-number">10</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412081715928.png" alt="image-20240412081715928" data-caption="image-20240412081715928" loading="lazy"></p>
<h4 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h4><p>简述AT模式与XA模式最大的区别是什么?</p>
<ul>
<li>XA模式一阶段不提交事务，锁定资源; AT模式一阶段直接提交，不锁定资源。</li>
<li>XA模式依赖数据库机制实现回滚; AT模式利用数据快照实现数据回滚。</li>
<li><code>XA模式强一致</code>; <code>AT模式最终一致</code></li>
</ul>
<h4 id="AT模式的脏写问题"><a href="#AT模式的脏写问题" class="headerlink" title="AT模式的脏写问题"></a>AT模式的脏写问题</h4><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412210846377.png" alt="image-20240412210846377" data-caption="image-20240412210846377" loading="lazy"></p>
<blockquote>
<p>事务1在提交事务之后，紧接着被事务2获取到了锁，而事务1的全局事务需要回滚，则此时事务1会将<code>money</code>恢复到100，但是影响到了事务2的操作</p>
<p>原因就是事务没有做到隔离，解决方式就是引入<code>全局锁</code>，标记对某行数据的拥有权，在事务提交前，其他事务无法修改<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240412211854987.png" alt="image-20240412211854987" data-caption="image-20240412211854987" loading="lazy"><br>事务1在提交事务后，释放DB锁；而DB锁马上被事务2获取到了，但全局事务锁在事务1手上，事务2拿不到</p>
<p>而DB锁在事务2手上，事务1拿不到，此时产生了死锁，但由于获取全局事务锁的过程有重试机制，任务超时会回滚并释放DB锁</p>
<p>这时事务1获取到了DB锁<br><strong>有一个问题，如果在事务1的<code>1.3~2.1</code>过程中，有一个不被<code>seata</code>管理的事务修改了值，也会产生脏写问题</strong><br><img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/QQ%E5%9B%BE%E7%89%8720240412212956.png"><br>在保存快照时，保存两份数据，一个是修改前的，一个是修改后的</p>
<p>当释放全局锁时，对比修改后的数据，如果不一致，说明在这段时间有其他事务修改了数据</p>
<p>这就没办法了，只能人工介入，这是比较极端的情况</p>
</blockquote>
<h4 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h4><p>AT模式的优点:</p>
<ol>
<li>一阶段完成直接提交事务,释放数据库资源，性能比较好</li>
<li>利用全局锁实现读写隔离</li>
<li>没有代码侵入,框架自动完成回滚和提交<br>AT模式的缺点:</li>
<li>两阶段之间属于软状态，属于最终一致</li>
<li>框架的快照功能会影响性能,但比XA模式要好很多</li>
</ol>
<h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol>
<li><p>新建两张表，其中lock_table导入到TC服务关联的数据库，undo_log表导入到微服务关联的数据库，这些操作在Seata配置阶段已经做过了</p>
</li>
<li><p>修改<code>application.yml</code>，将事务模式改为<code>AT</code>即可</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>    <span class="hljs-attr">registry:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>        <span class="hljs-attr">nacos:</span><br>            <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>            <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span><br>            <span class="hljs-comment"># tc服务在nacos的注册名称</span><br>            <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>            <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>            <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-comment"># 事务组，根据这个获取tc服务的cluster名称</span><br>    <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">seata-demo</span><br>    <span class="hljs-attr">service:</span><br>        <span class="hljs-comment"># 事务组与TC服务cluster的映射关系</span><br>        <span class="hljs-attr">vgroup-mapping:</span><br>            <span class="hljs-attr">seata-demo:</span> <span class="hljs-string">SH</span><br>    <span class="hljs-attr">data-source-proxy-mode:</span> <span class="hljs-string">AT</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>重启服务测试</p>
</li>
</ol>
<h3 id="TCC模式"><a href="#TCC模式" class="headerlink" title="TCC模式"></a>TCC模式</h3><h4 id="概念-3"><a href="#概念-3" class="headerlink" title="概念"></a>概念</h4><p>TCC模式与AT模式非常相似,每阶段都是独立事务，不同的是TCC通过人工编码来实现数据恢复，而非自动恢复(生成快照)。需要实现三个方法:</p>
<ol>
<li>Try: 资源的检测和预留;</li>
<li>Confirm: 完成资源操作业务;要求Try成功Confirm一定要能成功。</li>
<li>Cancel: 预留资源释放,可以理解为try的反向操作。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413063600514.png" alt="image-20240413063600514" data-caption="image-20240413063600514" loading="lazy"><br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413063809543.png" alt="image-20240413063809543" data-caption="image-20240413063809543" loading="lazy"></li>
</ol>
<h4 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h4><p>TCC模式的每个阶段是做什么的?</p>
<ol>
<li>Try:资源检查和预留</li>
<li>Confirm:业务执行和提交</li>
<li>Cancel:预留资源的释放<br>TCC的优点是什么?</li>
<li>一阶段完成直接提交事务,释放数据库资源,性能好</li>
<li>相比AT模型，无需生成快照，无需使用全局锁，性能最强</li>
<li>不依赖数据库事务，而是依赖补偿操作，可以用于非事务型数据库<br>TCC的缺点是什么?</li>
<li>有代码侵入，需要人为编写try、Confirm和Cancel接口，太麻烦</li>
<li>软状态，事务是最终一致</li>
<li>需要考虑Confirm和Cancel的失败情况，做好<code>幂等处理</code>。(失败后，seata会<code>重试</code>，需要考虑重复处理的情况)</li>
</ol>
<h4 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h4><p>需求如下:</p>
<ol>
<li>修改account-service,编写try、confirm、 cancel逻辑</li>
<li>try业务:添加冻结金额，扣减可用金额</li>
<li>confirm业务:删除冻结金额</li>
<li>cancel业务:删除冻结金额，恢复可用金额</li>
<li>保证confirm、cancel接口的<code>幂等性</code>（业务接口不会因为重复调用出现问题）</li>
<li>允许<code>空回滚</code></li>
<li>拒绝<code>业务悬挂</code><blockquote>
<p>有几个需要注意的点，<code>资源预留</code>是为了修改目标数据的值，但是新增订单是一个新增逻辑，这并<code>不适合TCC模式</code>，用<code>AT模式</code>就很好了</p>
<p>扣减余额和扣减库存可以使用TCC模式，在一个分布式事务当中既有<code>TCC模式</code>又有<code>AT模式</code>可以么？</p>
<p>答案是可以的</p>
</blockquote>
</li>
</ol>
<h5 id="空回滚问题"><a href="#空回滚问题" class="headerlink" title="空回滚问题"></a>空回滚问题</h5><p>当某分支事务的try阶段阻塞时，可能导致全局事务超时而触发二阶段的cancel操作。在未执行try操作时先执行了cancel操作，这时cancel不能做回滚,就是<code>空回滚</code>。这里并没有进行<code>资源预留</code>也无法进行<code>回滚</code>，但是这里也不能进行报错，否则<code>Seata</code>会认为<code>cancel</code>失败，应该返回正常结束。<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413065417807.png" alt="image-20240413065417807" data-caption="image-20240413065417807" loading="lazy"></p>
<h5 id="业务悬挂"><a href="#业务悬挂" class="headerlink" title="业务悬挂"></a>业务悬挂</h5><blockquote>
<p>此时阻塞的业务终于畅通了，但是这个事务已经提交了，后续既没有进行<code>confirm</code>也没有执行<code>cancel</code></p>
<p>对于已经空回滚的业务，如果以后继续执行try,就永远不可能confirm或cancel,这就是<code>业务悬挂</code>。应当阻止执行空回滚后的try操作，避免悬挂<br><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413070301607.png" alt="image-20240413070301607" data-caption="image-20240413070301607" loading="lazy"><br>为了避免<code>空回滚</code>，应该在<code>cancel</code>判断是否进行了<code>try</code></p>
<p>为了避免<code>业务悬挂</code>，应该在<code>try</code>判断是否进行了<code>cancel</code></p>
<p>这样就必须在数据库里记录当前状态，判断当前是在<code>try</code>？还是在<code>confirm</code>或者<code>cancel</code>？</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- auto-generated definition</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> accoutn_freeze_tbl_8<br>(<br>    xid          <span class="hljs-type">varchar</span>(<span class="hljs-number">188</span>)           <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;事务编号&#x27;</span><br>        <span class="hljs-keyword">primary</span> key,<br>    user_id      <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)           <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;用户编号`&#x27;</span>,<br>    freeze_money <span class="hljs-type">int</span> unsigned <span class="hljs-keyword">default</span> <span class="hljs-number">0</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;冻结金额&#x27;</span>,<br>    state        <span class="hljs-type">int</span>                    <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;事务状态(0:try、1:confirm、2:cancel)&#x27;</span><br>)<br>    comment <span class="hljs-string">&#x27;冻结金额表&#x27;</span>;<br></code></pre></td></tr></table></figure>
<h6 id="try业务"><a href="#try业务" class="headerlink" title="try业务"></a>try业务</h6><ol>
<li>记录冻结金额和事务状态到account_ freeze表</li>
<li>扣减account表可用金额</li>
</ol>
<h6 id="confirm业务"><a href="#confirm业务" class="headerlink" title="confirm业务"></a>confirm业务</h6><p>根据xid删除account_freeze表的冻结记录</p>
<h6 id="cancel业务"><a href="#cancel业务" class="headerlink" title="cancel业务"></a>cancel业务</h6><ol>
<li>修改account_ freeze表,冻结金额为0，state为2</li>
<li>修改account表，恢复可用金额</li>
</ol>
<h6 id="如何判断是否空回滚"><a href="#如何判断是否空回滚" class="headerlink" title="如何判断是否空回滚"></a>如何判断是否空回滚</h6><p>cancel业务中，根据xid查询account_freeze,如果为null则说明try还没做，需要空回滚</p>
<h6 id="如何避免是否业务悬挂"><a href="#如何避免是否业务悬挂" class="headerlink" title="如何避免是否业务悬挂"></a>如何避免是否业务悬挂</h6><p>try业务中，根据xid查询account_freeze如果已经存在则证明Cancel已经执行，拒绝执行try业务</p>
<h5 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h5><p>TCC的<code>Try</code>、<code>Confirm</code>、 <code>Cancel</code>方法都需要在接口中基于注解来声明，语法如下:</p>
<blockquote>
<p>name指定<code>try</code>方法、commitMethod指定<code>confirm</code>方法、rollbackMethod指定<code>cancel</code>方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountTCCService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 从用户账户中扣款</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId 用户 ID</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> money  钱</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TwoPhaseBusinessAction(name = &quot;deduct&quot;, commitMethod = &quot;confirm&quot;, rollbackMethod = &quot;cancel&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">(<span class="hljs-meta">@BusinessActionContextParameter(paramName = &quot;userId&quot;)</span> String userId,</span><br><span class="hljs-params">                <span class="hljs-meta">@BusinessActionContextParameter(paramName = &quot;money&quot;)</span> <span class="hljs-type">int</span> money)</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext context)</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext context)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;account_freeze_tbl&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountFreeze</span> &#123;<br>    <span class="hljs-meta">@TableId(type = IdType.INPUT)</span><br>    <span class="hljs-keyword">private</span> String xid;<br>    <span class="hljs-keyword">private</span> String userId;<br>    <span class="hljs-keyword">private</span> Integer freezeMoney;<br>    <span class="hljs-keyword">private</span> Integer state;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRY</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">CONFIRM</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCEL</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountFreezeMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;AccountFreeze&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountTCCServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccountTCCService</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AccountMapper accountMapper;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AccountFreezeMapper accountFreezeMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AccountTCCServiceImpl</span><span class="hljs-params">(AccountMapper accountMapper, AccountFreezeMapper accountFreezeMapper)</span> &#123;<br>        <span class="hljs-built_in">this</span>.accountMapper = accountMapper;<br>        <span class="hljs-built_in">this</span>.accountFreezeMapper = accountFreezeMapper;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 扣除金额</span><br><span class="hljs-comment">     * TCC try方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId 用户 ID</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> money  钱</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">(String userId, <span class="hljs-type">int</span> money)</span> &#123;<br>        <span class="hljs-comment">// 获取事务id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> RootContext.getXID();<br>        <span class="hljs-comment">// 数据库字段设置为unsigned int，所以不能为负数</span><br>        <span class="hljs-comment">// 1.扣减金额</span><br>        accountMapper.deduct(userId,money);<br>        <span class="hljs-comment">// 2.记录冻结金额、事务状态</span><br>        <span class="hljs-type">AccountFreeze</span> <span class="hljs-variable">accountFreeze</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountFreeze</span>();<br>        accountFreeze.setUserId(userId);<br>        accountFreeze.setFreezeMoney(money);<br>        accountFreeze.setState(AccountFreeze.State.TRY);<br>        accountFreeze.setXid(xid);<br>        accountFreezeMapper.insert(accountFreeze);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 确认</span><br><span class="hljs-comment">     * TCC confirm方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> context 上下文</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext context)</span> &#123;<br>        <span class="hljs-comment">// 获取事务id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> context.getXid();<br>        <span class="hljs-comment">// 删除了一条数据</span><br>        <span class="hljs-keyword">return</span> accountFreezeMapper.deleteById(xid)==<span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取消</span><br><span class="hljs-comment">     * TCC cancel方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> context 上下文</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext context)</span> &#123;<br>        <span class="hljs-comment">// 查询冻结记录</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> context.getXid();<br>        <span class="hljs-type">AccountFreeze</span> <span class="hljs-variable">accountFreeze</span> <span class="hljs-operator">=</span> accountFreezeMapper.selectById(xid);<br>        <span class="hljs-comment">// 1.恢复可用余额</span><br>        accountMapper.refund(accountFreeze.getUserId(),accountFreeze.getFreezeMoney());<br>        <span class="hljs-comment">// 2.将冻结金额清零，状态设置为CANCEL</span><br>        accountFreeze.setFreezeMoney(<span class="hljs-number">0</span>);<br>        accountFreeze.setState(AccountFreeze.State.CANCEL);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> accountFreezeMapper.updateById(accountFreeze);<br>        <span class="hljs-keyword">return</span> count==<span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>以上是基本内容</p>
<p>接下来增加对于<code>空回滚</code>和<code>业务悬挂</code>的判断</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountTCCServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccountTCCService</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AccountMapper accountMapper;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AccountFreezeMapper accountFreezeMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AccountTCCServiceImpl</span><span class="hljs-params">(AccountMapper accountMapper, AccountFreezeMapper accountFreezeMapper)</span> &#123;<br>        <span class="hljs-built_in">this</span>.accountMapper = accountMapper;<br>        <span class="hljs-built_in">this</span>.accountFreezeMapper = accountFreezeMapper;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 扣除金额</span><br><span class="hljs-comment">     * TCC try方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId 用户 ID</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> money  钱</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">(String userId, <span class="hljs-type">int</span> money)</span> &#123;<br>        <span class="hljs-comment">// 获取事务id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> RootContext.getXID();<br>        <span class="hljs-comment">// 判断业务悬挂</span><br>        <span class="hljs-type">AccountFreeze</span> <span class="hljs-variable">selectedById</span> <span class="hljs-operator">=</span> accountFreezeMapper.selectById(xid);)<br>        <span class="hljs-keyword">if</span>(selectedById!=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">// cancel已经执行过</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 数据库字段设置为unsigned int，所以不能为负数</span><br>        <span class="hljs-comment">// 1.扣减金额</span><br>        accountMapper.deduct(userId,money);<br>        <span class="hljs-comment">// 2.记录冻结金额、事务状态</span><br>        <span class="hljs-type">AccountFreeze</span> <span class="hljs-variable">accountFreeze</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountFreeze</span>();<br>        accountFreeze.setUserId(userId);<br>        accountFreeze.setFreezeMoney(money);<br>        accountFreeze.setState(AccountFreeze.State.TRY);<br>        accountFreeze.setXid(xid);<br>        accountFreezeMapper.insert(accountFreeze);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 确认</span><br><span class="hljs-comment">     * TCC confirm方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> context 上下文</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext context)</span> &#123;<br>        <span class="hljs-comment">// 获取事务id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> context.getXid();<br>        <span class="hljs-comment">// 删除了一条数据，删除数据本来就是幂等性的</span><br>        <span class="hljs-keyword">return</span> accountFreezeMapper.deleteById(xid)==<span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取消</span><br><span class="hljs-comment">     * TCC cancel方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> context 上下文</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext context)</span> &#123;<br>        <span class="hljs-comment">// 查询冻结记录</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> context.getXid();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> context.getActionContext(<span class="hljs-string">&quot;userId&quot;</span>).toString();<br>        <span class="hljs-type">AccountFreeze</span> <span class="hljs-variable">accountFreeze</span> <span class="hljs-operator">=</span> accountFreezeMapper.selectById(xid);<br>        <span class="hljs-comment">// 空回滚的判断</span><br>        <span class="hljs-keyword">if</span>(accountFreeze==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">// 记录空回滚的数据</span><br>            accountFreeze.setUserId(userId);<br>            accountFreeze.setFreezeMoney(<span class="hljs-number">0</span>);<br>            accountFreeze.setState(AccountFreeze.State.CANCEL);<br>            accountFreeze.setXid(xid);<br>            accountFreezeMapper.insert(accountFreeze);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// 幂等性判断</span><br>        <span class="hljs-keyword">if</span>(accountFreeze.getState()==AccountFreeze.State.CANCEL)&#123;<br>            <span class="hljs-comment">// 已经执行过cancel方法了，无需重复执行</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// 1.恢复可用余额</span><br>        accountMapper.refund(accountFreeze.getUserId(),accountFreeze.getFreezeMoney());<br>        <span class="hljs-comment">// 2.将冻结金额清零，状态设置为CANCEL</span><br>        accountFreeze.setFreezeMoney(<span class="hljs-number">0</span>);<br>        accountFreeze.setState(AccountFreeze.State.CANCEL);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> accountFreezeMapper.updateById(accountFreeze);<br>        <span class="hljs-keyword">return</span> count==<span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Saga模式"><a href="#Saga模式" class="headerlink" title="Saga模式"></a>Saga模式</h3><p>Saga模式是SEATA提供的长事务解决方案。也分为两个阶段:</p>
<ol>
<li>一阶段:直接提交本地事务</li>
<li>二阶段:成功则什么都不做;失败则通过编写补偿业务来回滚<br>Saga模式的缺点是没有隔离性<br>Saga模式优点:</li>
<li>事务参与者可以基于事件驱动实现异步调用，吞吐高</li>
<li>一阶段直接提交事务，无锁，性能好</li>
<li>不用编写TCC中的三个阶段，实现简单<br>缺点:</li>
<li>软状态持续时间不确定，时效性差</li>
<li>没有锁，没有事务隔离，会有脏写</li>
</ol>
<h3 id="模式对比"><a href="#模式对比" class="headerlink" title="模式对比"></a>模式对比</h3><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo01/image-20240413205630731.png" alt="image-20240413205630731" data-caption="image-20240413205630731" loading="lazy"></p>

    
  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>折影轻梦<br>
        <strong>本文链接：</strong><a href="https://isunderachiever.github.io/bian-cheng-yu-yan/java/xue-xi/kuang-jia/seata/seata.html" title="https:&#x2F;&#x2F;isunderachiever.github.io&#x2F;bian-cheng-yu-yan&#x2F;java&#x2F;xue-xi&#x2F;kuang-jia&#x2F;seata&#x2F;seata.html" target="_blank" rel="noopener">https:&#x2F;&#x2F;isunderachiever.github.io&#x2F;bian-cheng-yu-yan&#x2F;java&#x2F;xue-xi&#x2F;kuang-jia&#x2F;seata&#x2F;seata.html</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Seata/" rel="tag">Seata</a>
    
</div>
  
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
    data-repo="nexmoe/nexmoe.com"
    data-repo-id="R_kgDOJI1XUA"
    data-category="General"
    data-category-id="DIC_kwDOJI1XUM4CU1nn"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>

      </div>
  
</div>
</div>
        <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Seata"><span class="toc-number">1.</span> <span class="toc-text">Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84ACID%E5%8E%9F%E5%88%99"><span class="toc-number">1.1.1.</span> <span class="toc-text">事务的ACID原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86"><span class="toc-number">1.2.</span> <span class="toc-text">理论知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP%E5%AE%9A%E7%90%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">CAP定理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">可用性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">分区容错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">思考</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BASE%E7%90%86%E8%AE%BA"><span class="toc-number">1.2.2.</span> <span class="toc-text">BASE理论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">分布式事务模型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E8%AF%86Seata"><span class="toc-number">1.3.</span> <span class="toc-text">初识Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Seata%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.1.</span> <span class="toc-text">Seata架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Seata"><span class="toc-number">1.3.2.</span> <span class="toc-text">安装Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnacos%E4%B8%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">配置nacos为注册中心和配置中心</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">基本使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.4.</span> <span class="toc-text">动手实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XA%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.</span> <span class="toc-text">XA模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Seata%E4%B8%AD%E7%9A%84XA%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">Seata中的XA模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0XA%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">实现XA模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AT%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.</span> <span class="toc-text">AT模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AT%E6%A8%A1%E5%BC%8F%E7%9A%84%E8%84%8F%E5%86%99%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">AT模式的脏写问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCC%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.3.</span> <span class="toc-text">TCC模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A9%BA%E5%9B%9E%E6%BB%9A%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.3.3.1.</span> <span class="toc-text">空回滚问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%82%AC%E6%8C%82"><span class="toc-number">1.4.3.3.2.</span> <span class="toc-text">业务悬挂</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#try%E4%B8%9A%E5%8A%A1"><span class="toc-number">1.4.3.3.2.1.</span> <span class="toc-text">try业务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#confirm%E4%B8%9A%E5%8A%A1"><span class="toc-number">1.4.3.3.2.2.</span> <span class="toc-text">confirm业务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#cancel%E4%B8%9A%E5%8A%A1"><span class="toc-number">1.4.3.3.2.3.</span> <span class="toc-text">cancel业务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E7%A9%BA%E5%9B%9E%E6%BB%9A"><span class="toc-number">1.4.3.3.2.4.</span> <span class="toc-text">如何判断是否空回滚</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E6%98%AF%E5%90%A6%E4%B8%9A%E5%8A%A1%E6%82%AC%E6%8C%82"><span class="toc-number">1.4.3.3.2.5.</span> <span class="toc-text">如何避免是否业务悬挂</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.3.3.3.</span> <span class="toc-text">代码实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Saga%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.4.</span> <span class="toc-text">Saga模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">1.4.5.</span> <span class="toc-text">模式对比</span></a></li></ol></li></ol></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
    </div>
    <div id="nexmoe-search-space">
	<div class="search-container">
		<div class="search-header">
			<div class="search-input-container">
				<input
					class="search-input"
					type="text"
					placeholder="搜索"
					oninput="sinput();"
				/>
			</div>
			<a class="search-close" onclick="sclose();">×</a>
		</div>
		<div class="search-body"></div>
	</div>
</div>

    
    
</body>

</html>
