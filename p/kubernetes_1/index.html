<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Kubernetes_1">
<title>Kubernetes_1</title>

<link rel='canonical' href='https://IsUnderAchiever.github.io/p/kubernetes_1/'>

<link rel="stylesheet" href="/scss/style.min.b85f3de2f132c41bcf65396d29447bd98774c1cff192b74d7f75bc7b72545eb8.css"><meta property='og:title' content="Kubernetes_1">
<meta property='og:description' content="Kubernetes_1">
<meta property='og:url' content='https://IsUnderAchiever.github.io/p/kubernetes_1/'>
<meta property='og:site_name' content='深海火锅店'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-12-24T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-12-24T00:00:00&#43;00:00'/><meta property='og:image' content='https://IsUnderAchiever.github.io/p/kubernetes_1/202412242125601.png' />
<meta name="twitter:title" content="Kubernetes_1">
<meta name="twitter:description" content="Kubernetes_1"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://IsUnderAchiever.github.io/p/kubernetes_1/202412242125601.png' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/header_hu16240087013746809388.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">😁</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">深海火锅店</a></h1>
            <h2 class="site-description">记录我的成长史</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/477448861'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1734756297204" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4471" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M685.21 117.15c6.63-9.41 21.12-11.52 30.21-4.47 9.06 6.34 11.49 19.96 5.35 29.12-35.44 51.91-70.81 103.88-106.31 155.76-0.63 1.02-1.16 2.09-1.7 3.16 86.41 0.03 172.82 0.01 259.22 0.02 10.3-0.39 19.61 8.97 19.11 19.28 0.08 172.65 0.18 345.31 0.23 517.97 0.29 9.97-8.32 19.2-18.33 19.35-21.78 0.24-43.56-0.17-65.32 0.19-1.96 17.65-9.87 34.97-23.27 46.85-12.92 12-31.5 17.75-48.9 14.36-28.92-5.43-48.64-33.26-51.72-61.39-109.19 0.08-218.38 0.08-327.57 0-2.33 18.48-10.77 36.55-25.23 48.6-15.66 13.62-39.03 17.75-58.17 9.42-23.11-9.58-37.95-33.47-40.48-57.84-27.1-0.36-54.23 0.06-81.33-0.21-9.8-0.41-18.09-9.49-17.73-19.28 0.06-170.34 0.08-340.69 0.12-511.04 0.1-4.55-0.51-9.27 1.09-13.64 2.49-7.28 9.81-12.67 17.54-12.61 91.71-0.09 183.42 0.12 275.13-0.11-50.14-27.95-100.88-54.9-151.14-82.66-10.46-5.79-13.59-20.94-6.66-30.59 5.82-9.13 18.87-12.17 28.25-6.87 69.04 37.58 138.06 75.18 207.1 112.76 3.52 1.62 5.91 4.67 8.61 7.31 15.47 0.33 30.96 0.05 46.45 0.15 41.94-61.11 83.59-122.43 125.45-183.59M169.87 336.87c-0.09 161.25 0.16 322.48 0.35 483.72 228.11-0.17 456.22-0.07 684.33-0.05-0.02-161.22 0.22-322.46 0.07-483.68-228.25 0.01-456.5-0.02-684.75 0.01M271 857.38c2.22 11.33 10.44 23.52 23 24.07 12.45-0.26 21.53-12.56 22.95-24.07-15.32 0.05-30.64 0.02-45.95 0m452.05 0c1.42 11.5 10.51 23.79 22.95 24.07 12.54-0.55 20.85-12.71 22.99-24.06-15.31 0.01-30.63 0.04-45.94-0.01z" fill="#454545" p-id="4472"></path><path d="M221.28 374.37c3.83-0.94 7.81-0.61 11.72-0.65 188.33 0.01 376.65-0.01 564.98 0.01 10.85-0.43 20.67 9.41 20.08 20.27 0.14 123.33-0.02 246.66 0.16 369.99 0.13 8.3-5.4 16.35-13.29 19-4.14 1.52-8.61 1.18-12.93 1.19-188.67-0.04-377.35 0.06-566.02-0.04-12.39 0.23-21.58-12.32-19.69-24.15 0.06-122.01 0.04-244.03 0.11-366.04-0.24-8.92 6.15-17.52 14.88-19.58M243 410.18c-0.38 112.4 0.15 224.81 0.11 337.21 179.44 0.13 358.89 0.09 538.34 0.02 0.01-112.43 0.4-224.89-0.09-337.3-179.45 0.14-358.91-0.01-538.36 0.07z" fill="#454545" p-id="4473"></path><path d="M600.4 471.55c5.06-1.37 10.69-0.78 15.28 1.8 35.65 21.33 71.26 42.72 106.91 64.07 4.92 2.83 10.29 5.72 13.05 10.95 4.45 7.6 3.2 17.98-3.01 24.24-6.32 7.05-17.67 8.31-25.62 3.34-37.26-22.4-74.56-44.75-111.83-67.13-6.4-3.83-10.36-11.35-9.78-18.79 0.31-8.57 6.75-16.33 15-18.48zM405.42 481.48c8.67-1.08 17.67 4.03 21.1 12.09 4.57 9.77-0.18 22.57-10.12 26.85-33.02 15.3-66.04 30.58-99.07 45.84-9.66 4.53-22.34-0.1-26.68-9.87-4.95-9.45-0.72-22.17 8.73-26.97 30.72-14.34 61.56-28.44 92.31-42.72 4.46-1.98 8.79-4.61 13.73-5.22zM407.29 596.31c8.9-3.09 19.57 1.06 24.09 9.31 4.37 7.1 1.79 15.88 4.5 23.51 3.44 13.44 14.3 26.79 29.14 27.09 13.98 0.07 24.84-11.84 28.91-24.34 2.31-6.05 2.52-12.54 2.96-18.9 1.17-11.04 12.56-19.47 23.46-17.43 9.81 1.3 17.53 10.53 17.35 20.37-0.08 15.28 7.21 32.12 21.92 38.44 8.4 3.65 18.6 1.7 25.5-4.2 10.37-8.44 15.16-22.11 15.17-35.21 0.14-10.37 9.36-19.53 19.73-19.62 10.15-0.64 19.85 7.53 21.03 17.62 2.16 35.45-20.4 73.22-55.9 82.28-24.72 6.92-51.53-3.48-68.08-22.38-10.45 11.74-24.48 20.62-40.07 23.39-17.51 3.32-36.18-1.22-50.48-11.76-21.88-15.69-33.94-42.91-33.43-69.55 0.28-8.35 6.19-16.17 14.2-18.62z" fill="#454545" p-id="4474"></path></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/IsUnderAchiever'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://IsUnderAchiever.github.io/en/" >English</option>
                                
                                    <option value="https://IsUnderAchiever.github.io/" selected>中文</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#核心概念">核心概念</a>
      <ol>
        <li><a href="#什么是-kubernetes">什么是 Kubernetes</a></li>
        <li><a href="#为什么需要-kubernetes">为什么需要 Kubernetes</a>
          <ol>
            <li><a href="#应用部署的三大阶段">应用部署的三大阶段</a></li>
            <li><a href="#k8s-的特点">k8s 的特点</a></li>
          </ol>
        </li>
        <li><a href="#企业级容器调度平台">企业级容器调度平台</a></li>
        <li><a href="#集群架构与组件">集群架构与组件</a>
          <ol>
            <li><a href="#相关组件">相关组件</a></li>
            <li><a href="#分层架构">分层架构</a></li>
          </ol>
        </li>
        <li><a href="#核心概念与专业术语">核心概念与专业术语</a>
          <ol>
            <li><a href="#服务的分类">服务的分类</a></li>
            <li><a href="#资源和对象">资源和对象</a></li>
            <li><a href="#对象规约和状态">对象规约和状态</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#k8s-实战进阶">K8S 实战进阶</a>
      <ol>
        <li><a href="#搭建-kubernetes-集群">搭建 Kubernetes 集群</a>
          <ol>
            <li><a href="#搭建方案">搭建方案</a></li>
            <li><a href="#命令行工具-kubectl">命令行工具 kubectl</a></li>
            <li><a href="#资源类型与别名">资源类型与别名</a></li>
            <li><a href="#格式化输出">格式化输出</a></li>
            <li><a href="#api-概述">API 概述</a></li>
          </ol>
        </li>
        <li><a href="#深入-pod">深入 Pod</a>
          <ol>
            <li><a href="#pod-配置文件">Pod 配置文件</a></li>
            <li><a href="#探针">探针</a></li>
            <li><a href="#生命周期">生命周期</a></li>
          </ol>
        </li>
        <li><a href="#资源调度">资源调度</a>
          <ol>
            <li><a href="#label-和-selector">Label 和 Selector</a></li>
            <li><a href="#deployment">Deployment</a></li>
            <li><a href="#statefulset-1">StatefulSet</a></li>
            <li><a href="#daemonset">DaemonSet</a></li>
            <li><a href="#hpa-自动扩缩容">HPA 自动扩/缩容</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
    <div class="article-image">
        <a href="/p/kubernetes_1/">
            <img src="/p/kubernetes_1/202412242125601_hu6944413584555012341.png" srcset="/p/kubernetes_1/202412242125601_hu6944413584555012341.png 800w, /p/kubernetes_1/202412242125601_hu13128054618936277471.png 1600w"  width="800"
                height="388" loading="lazy" alt="Featured image of post Kubernetes_1" />
            
        </a>
    </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/kubernetes_1/" >
                Kubernetes_1
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/kubernetes_1/">Kubernetes_1</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Kubernetes_1
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-12-24</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 63 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


    <section class="article-content">
    
    
    <h1 id="kubernetes_1">Kubernetes_1
</h1><h2 id="核心概念">核心概念
</h2><h3 id="什么是-kubernetes">什么是 Kubernetes
</h3><p><strong>Kubernetes</strong> 是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的应用简单并且高效（powerful），Kubernetes 提供了应用部署，规划，更新，维护的一种机制。</p>
<p><strong>Kubernetes</strong> 这个名字源于希腊语，意为“舵手”或“飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符的关系。 Google 在 2014 年开源了 Kubernetes 项目。 Kubernetes 建立在 <a class="link" href="https://research.google/pubs/pub43438"  target="_blank" rel="noopener" >Google 大规模运行生产工作负载十几年经验</a>的基础上， 结合了社区中最优秀的想法和实践。</p>
<h3 id="为什么需要-kubernetes">为什么需要 Kubernetes
</h3><h4 id="应用部署的三大阶段">应用部署的三大阶段
</h4><ol>
<li>传统部署
<ul>
<li>程序员/运维工程师手动操作部署应用，直接将应用部署在目标机器上，由于资源不隔离，容易出现资源争抢、依赖冲突等各方面问题。</li>
</ul>
</li>
<li>虚拟化部署
<ul>
<li>利用 OpenStask / VMware 等虚拟化技术，将一台目标机器虚拟化为多个虚拟机器，按照需求将应用部署到不同的虚拟机中，对虚拟机进行动态的水平扩容等管理操作。</li>
<li>相对传统部署自动化、资源隔离的能力提升了，带来的问题是虚拟化的逻辑过重，导致效率不高，且耗费资源较多。</li>
</ul>
</li>
<li>容器化部署
<ul>
<li>可以理解为轻量级的虚拟化，完美弥补虚拟化技术过重的问题，且由于直接共享主机硬件资源，只是通过系统提供的命名空间等技术实现资源隔离，损耗更小，且效率更高。</li>
</ul>
</li>
</ol>
<h4 id="k8s-的特点">k8s 的特点
</h4><ol>
<li>自我修复</li>
<li>弹性伸缩</li>
<li>自动部署和回滚</li>
<li>服务发现和负载均衡</li>
<li>机密和配置管理</li>
<li>存储编排</li>
<li>批处理</li>
</ol>
<h3 id="企业级容器调度平台">企业级容器调度平台
</h3><ol>
<li>Apache Mesos
<ol>
<li>基本概念
<ul>
<li>Mesos 是一个分布式调度系统内核，早于 Docker 产生，Mesos 作为资源管理器，从 DC/OS (数据中心操作系统)的角度提供资源视图。主/从结构工作模式，主节点分配任务，并用从节点上的 Executor 负责执行，通过 Zookeeper 给主节点提供服务注册、服务发现功能。通过 Framework Marathon 提供容器调度的能力。</li>
</ul>
</li>
<li>优势
<ul>
<li>经过时间的检验，作为资源管理器的 Apache Mesos 在容器之前就已经出现很久了，支持运行容器化化和非容器化的工作负载。可以支持应用程序的健康检查，开放的架构。支持多个框架和多个调度器，通过不同的 Framework 可以运行 Hadoop/Spark/MPI 等多种不同的任务。</li>
<li>支持超大型规模的节点管理，模拟测试支持超过 5w+ 节点，在大规模上拥有较大优势。</li>
</ul>
</li>
</ol>
</li>
<li>Docker Swarm
<ol>
<li>基本概念
<ul>
<li>Docker Swarm 是一个由 Docker 开发的调度框架。由 Docker 自身开发的好处之一就是标准 Docker API 的使用，Swarm 由多个代理（Agent）组成，把这些代理称之为节点（Node）。这些节点就是主机，这些主机在启动 Docker Daemon 的时候就会打开相应的端口，以此支持 Docker 远程 API。这些机器会根据 Swarm 调度器分配给它们的任务，拉取和运行不同的镜像。</li>
</ul>
</li>
<li>优势
<ul>
<li>从 Docker1.12 版本开始，Swarm 随 Docker 一起默认安装发布。由于随 Docker 引擎一起发布，无需额外安装，配置简单。支持服务注册、服务发现，内置 Overlay Network 以及 Load Balancer。与 Docker CLI 非常类似的操作命令，对熟悉 Docker 的人非常容易上手学习。</li>
<li>入门门槛、学习成本较低，使用更便捷，适用于中小型系统。</li>
</ul>
</li>
</ol>
</li>
<li>Google Kubernetes
<ol>
<li>基本概念
<ul>
<li>Kubernetes 是基于 Google 在过去十五年来大量生产环境中运行工作负载的经验。Kubernetes 的实现参考了 Google 内部的资源调度框架，但并不是 Borg 的内部容器编排系统的开源，而是借鉴 Google 从运行 Borg 获得的经验教训，形成了 Kubernetes 项目。</li>
<li>它使用 Label 和 Pod 的概念来将容器划分为逻辑单元。Pods 是同地协作（co-located）容器的集合，这些容器被共同部署和调度，形成了一个服务，这是 Kubernetes 和其他两个框架的主要区别。相比于基于相似度的容器调度方式（就像 Swarm 和 Mesos），这个方法简化了对集群的管理。</li>
</ul>
</li>
<li>优势
<ul>
<li>最流行等容器编排解决方案框架，基于 Google 庞大的生态圈及社区产生的产品。通过 Pods 这一抽象的概念，解决 Container 之间的依赖于通信问题。Pods，Services，Deployments 是独立部署的部分，可以通过 Selector 提供更多的灵活性。内置服务注册表和负载平衡。</li>
<li>适用度更广，功能更强大，相较于 Mesos 来说节点规模较小，</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 id="集群架构与组件">集群架构与组件
</h3><h4 id="相关组件">相关组件
</h4><h5 id="控制面板组件master">控制面板组件（Master）
</h5><p>
<div class="post-img-view">
	<a data-fancybox="gallery" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412242119647.png">
		<img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412242119647.png" alt="k8s1.drawio"  />
	</a>
</div>
</p>
<p><strong>其中标色的地方需要重点注意</strong></p>
<blockquote>
<h6 id="kube-api-server">kube-api-server
</h6></blockquote>
<p>API 服务器是 Kubernetes <a class="link" href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-control-plane"  target="_blank" rel="noopener" >控制平面</a>的组件， 该组件负责公开了 Kubernetes API，负责处理接受请求的工作。 API 服务器是 Kubernetes 控制平面的前端。</p>
<p>Kubernetes API 服务器的主要实现是 <a class="link" href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/"  target="_blank" rel="noopener" >kube-apiserver</a>。 kube-apiserver 设计上考虑了水平扩缩，也就是说，它可通过部署多个实例来进行扩缩。 你可以运行 kube-apiserver 的多个实例，并在这些实例之间平衡流量。</p>
<blockquote>
<h6 id="kube-controller-manager">kube-controller-manager
</h6></blockquote>
<p><a class="link" href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-controller-manager/"  target="_blank" rel="noopener" >kube-controller-manager</a> 是<a class="link" href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-control-plane"  target="_blank" rel="noopener" >控制平面</a>的组件， 负责运行<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/architecture/controller/"  target="_blank" rel="noopener" >控制器</a>进程。</p>
<p>从逻辑上讲， 每个<a class="link" href="https://kubernetes.io/zh-cn/docs/concepts/architecture/controller/"  target="_blank" rel="noopener" >控制器</a>都是一个单独的进程， 但是为了降低复杂性，它们都被编译到同一个可执行文件，并在同一个进程中运行。</p>
<p>这些控制器包括：</p>
<ul>
<li>节点控制器（Node Controller）：负责在节点出现故障时进行通知和响应</li>
<li>任务控制器（Job Controller）：监测代表一次性任务的 Job 对象，然后创建 Pods 来运行这些任务直至完成</li>
<li>端点分片控制器（EndpointSlice controller）：填充端点分片（EndpointSlice）对象（以提供 Service 和 Pod 之间的链接）。</li>
<li>服务账号控制器（ServiceAccount controller）：为新的命名空间创建默认的服务账号（ServiceAccount）。</li>
</ul>
<blockquote>
<h6 id="cloud-controller-manager">cloud-controller-manager
</h6></blockquote>
<p>嵌入了特定于云平台的控制逻辑。 云控制器管理器（Cloud Controller Manager）允许你将你的集群连接到云提供商的 API 之上， 并将与该云平台交互的组件同与你的集群交互的组件分离开来。</p>
<p>cloud-controller-manager 仅运行特定于云平台的控制器。 因此如果你在自己的环境中运行 Kubernetes，或者在本地计算机中运行学习环境， 所部署的集群不需要有云控制器管理器。</p>
<p>与 kube-controller-manager 类似，cloud-controller-manager 将若干逻辑上独立的控制回路组合到同一个可执行文件中， 供你以同一进程的方式运行。 你可以对其执行水平扩容（运行不止一个副本）以提升性能或者增强容错能力。</p>
<blockquote>
<h6 id="kube-scheduler">kube-scheduler
</h6></blockquote>
<p>scheduler 负责资源的调度，按照预定的调度策略将 Pod 调度到相应的机器上；</p>
<blockquote>
<h6 id="etcd">etcd
</h6></blockquote>
<p>一致且高度可用的键值存储，用作 Kubernetes 的所有集群数据的后台数据库。</p>
<p>如果你的 Kubernetes 集群使用 etcd 作为其后台数据库， 请确保你针对这些数据有一份 <a class="link" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster"  target="_blank" rel="noopener" >备份</a>计划。</p>
<p>你可以在官方<a class="link" href="https://etcd.io/docs/"  target="_blank" rel="noopener" >文档</a>中找到有关 etcd 的深入知识。</p>
<p>早期数据存放在内存，现在已经是持久化存储的了。</p>
<h5 id="节点组件">节点组件
</h5><blockquote>
<h6 id="kubelet">kubelet
</h6></blockquote>
<p>kubelet 负责维护容器的生命周期，同时也负责 Volume（CVI）和网络（CNI）的管理；</p>
<blockquote>
<h6 id="kube-proxy">kube-proxy
</h6></blockquote>
<p>kube-proxy 负责为 Service 提供 cluster 内部的服务发现和负载均衡；kube-proxy 负责为 Service 提供 cluster 内部的服务发现和负载均衡；</p>
<blockquote>
<h6 id="container-runtime">container runtime
</h6></blockquote>
<p>Container runtime 负责镜像管理以及 Pod 和容器的真正运行（CRI）；
Kubernetes 支持许多容器运行环境，例如 <a class="link" href="https://containerd.io/docs/"  target="_blank" rel="noopener" >containerd</a>、 <a class="link" href="https://cri-o.io/#what-is-cri-o"  target="_blank" rel="noopener" >CRI-O</a> 以及 <a class="link" href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md"  target="_blank" rel="noopener" >Kubernetes CRI (容器运行环境接口)</a> 的其他任何实现。</p>
<h5 id="附加组件">附加组件
</h5><blockquote>
<h6 id="kube-dns">kube-dns
</h6></blockquote>
<p>kube-dns 负责为整个集群提供 DNS 服务</p>
<blockquote>
<h6 id="ingress-controller">Ingress Controller
</h6></blockquote>
<p>Ingress Controller 为服务提供外网入口</p>
<blockquote>
<h6 id="prometheus">Prometheus
</h6></blockquote>
<p>Prometheus 提供资源监控</p>
<blockquote>
<h6 id="dashboard">Dashboard
</h6></blockquote>
<p>Dashboard 提供 GUI</p>
<blockquote>
<h6 id="federation">Federation
</h6></blockquote>
<p>Federation 提供跨可用区的集群</p>
<blockquote>
<h6 id="fluentd-elasticsearch">Fluentd-elasticsearch
</h6></blockquote>
<p>Fluentd-elasticsearch 提供集群日志采集、存储与查询</p>
<h4 id="分层架构">分层架构
</h4><ol>
<li>生态系统
<ul>
<li>在接口层之上的庞大容器集群管理调度的生态系统，可以划分为两个范畴：
<ul>
<li>Kubernetes 外部：日志、监控、配置管理、CI、CD、Workflow、FaaS、OTS 应用、ChatOps 等</li>
<li>Kubernetes 内部：CRI、CNI、CVI、镜像仓库、Cloud Provider、集群自身的配置和管理等</li>
</ul>
</li>
</ul>
</li>
<li>接口层
<ul>
<li>kubectl 命令行工具、客户端 SDK 以及集群联邦</li>
</ul>
</li>
<li>管理层
<ul>
<li>系统度量（如基础设施、容器和网络的度量），自动化（如自动扩展、动态 Provision 等）以及策略管理（RBAC、Quota、PSP、NetworkPolicy 等）</li>
</ul>
</li>
<li>应用层
<ul>
<li>部署（无状态应用、有状态应用、批处理任务、集群应用等）和路由（服务发现、DNS 解析等）</li>
</ul>
</li>
<li>核心层
<ul>
<li>Kubernetes 最核心的功能，对外提供 API 构建高层的应用，对内提供插件式应用执行环境</li>
</ul>
</li>
</ol>
<h3 id="核心概念与专业术语">核心概念与专业术语
</h3><h4 id="服务的分类">服务的分类
</h4><h5 id="无状态">无状态
</h5><blockquote>
<p>需要在服务运行环境下存储数据的服务，我们称之为<code>无状态应用</code></p>
</blockquote>
<p>代表应用</p>
<ol>
<li>Nginx</li>
<li>Apache</li>
</ol>
<p>优点：对客户端透明，无依赖关系，可以高效实现扩容、迁移</p>
<p>缺点：不能存储数据，需要额外的数据服务支撑</p>
<h5 id="有状态">有状态
</h5><p>代表应用</p>
<ol>
<li>MySQL</li>
<li>Redis</li>
</ol>
<p>优点：可以独立存储数据，实现数据管理
缺点：集群环境下需要实现主从、数据同步、备份、水平扩容复杂</p>
<h4 id="资源和对象">资源和对象
</h4><p>Kubernetes 中的所有内容都被抽象为“资源”，如 Pod、Service、Node 等都是资源。“对象”就是“资源”的实例，是持久化的实体。如某个具体的 Pod、某个具体的 Node。Kubernetes 使用这些实体去表示整个集群的状态。</p>
<p>对象的创建、删除、修改都是通过 “Kubernetes API”，也就是 “Api Server” 组件提供的 API 接口，这些是 RESTful 风格的 Api，与 k8s 的“万物皆对象”理念相符。命令行工具 “kubectl”，实际上也是调用 kubernetes api。</p>
<p>K8s 中的资源类别有很多种，kubectl 可以通过配置文件来创建这些 “对象”，配置文件更像是描述对象“属性”的文件，配置文件格式可以是 “JSON” 或 “YAML”，常用 “YAML”。</p>
<h5 id="元数据型"><code>元数据型</code>
</h5><ol>
<li>Horizontal Pod Autoscaler（HPA）
<ul>
<li>Pod 自动扩容：可以根据 CPU 使用率或自定义指标（metrics）自动对 Pod 进行扩/缩容。
<ul>
<li>控制管理器每隔 30s（可以通过–horizontal-pod-autoscaler-sync-period 修改）查询 metrics 的资源使用情况</li>
<li>支持三种 metrics 类型
<ul>
<li>预定义 metrics（比如 Pod 的 CPU）以利用率的方式计算</li>
<li>自定义的 Pod metrics，以原始值（raw value）的方式计算</li>
<li>自定义的 object metrics</li>
</ul>
</li>
<li>支持两种 metrics 查询方式：Heapster 和自定义的 REST API</li>
<li>支持多 metrics</li>
</ul>
</li>
</ul>
</li>
<li>PodTemplate
<ul>
<li>Pod Template 是关于 Pod 的定义，但是被包含在其他的 Kubernetes 对象中（例如 Deployment、StatefulSet、DaemonSet 等控制器）。控制器通过 Pod Template 信息来创建 Pod。</li>
</ul>
</li>
<li>LimitRange
<ul>
<li>可以对集群内 Request 和 Limits 的配置做一个全局的统一的限制，相当于批量设置了某一个范围内（某个命名空间）的 Pod 的资源使用限制。</li>
</ul>
</li>
</ol>
<h5 id="集群级"><code>集群级</code>
</h5><ol>
<li>
<p>Namespace</p>
<ul>
<li>
<p>Kubernetes 支持多个虚拟集群，它们底层依赖于同一个物理集群，这些虚拟集群被称为命名空间。</p>
<p>作用是用于实现多团队/环境的资源隔离。</p>
<p>命名空间 namespace 是 k8s 集群级别的资源，可以给不同的用户、租户、环境或项目创建对应的命名空间。</p>
<p>默认 namespace：</p>
<ul>
<li>kube-system 主要用于运行系统级资源，存放 k8s 自身的组件</li>
<li>kube-public 此命名空间是自动创建的，并且可供所有用户（包括未经过身份验证的用户）读取。此命名空间主要用于集群使用，关联的一些资源在集群中是可见的并且可以公开读取。此命名空间的公共方面知识一个约定，但不是非要这么要求。</li>
<li>default 未指定名称空间的资源就是 default，即你在创建 pod 时如果没有指定 namespace，则会默认使用 default</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Node</p>
<ul>
<li>不像其他的资源（如 Pod 和 Namespace），Node 本质上不是 Kubernetes 来创建的，Kubernetes 只是管理 Node 上的资源。虽然可以通过 Manifest 创建一个 Node 对象（如下 json 所示），但 Kubernetes 也只是去检查是否真的是有这么一个 Node，如果检查失败，也不会往上调度 Pod。</li>
</ul>
</li>
<li>
<p>ClusterRole</p>
<ul>
<li>ClusterRole 是一组权限的集合，但与 Role 不同的是，ClusterRole 可以在包括所有 Namespace 和集群级别的资源或非资源类型进行鉴权。</li>
</ul>
</li>
<li>
<p>ClusterRoleBinding</p>
<ul>
<li>ClusterRoleBinding：将 Subject 绑定到 ClusterRole，ClusterRoleBinding 将使规则在所有命名空间中生效。</li>
</ul>
</li>
</ol>
<h5 id="命名空间级"><code>命名空间级</code>
</h5><h6 id="工作负载型">工作负载型
</h6><p><strong>Pod</strong>
Pod（容器组）是 Kubernetes 中最小的可部署单元。一个 Pod（容器组）包含了一个应用程序容器（某些情况下是多个容器）、存储资源、一个唯一的网络 IP 地址、以及一些确定容器该如何运行的选项。Pod 容器组代表了 Kubernetes 中一个独立的应用程序运行实例，该实例可能由单个容器或者几个紧耦合在一起的容器组成。</p>
<p>Docker 是 Kubernetes Pod 中使用最广泛的容器引擎；Kubernetes Pod 同时也支持其他类型的容器引擎。</p>
<p>Kubernetes 集群中的 Pod 存在如下两种使用途径：</p>
<ul>
<li>一个 Pod 中只运行一个容器。&ldquo;one-container-per-pod&rdquo; 是 Kubernetes 中最常见的使用方式。此时，您可以认为 Pod 容器组是该容器的 wrapper，Kubernetes 通过 Pod 管理容器，而不是直接管理容器。</li>
<li>一个 Pod 中运行多个需要互相协作的容器。您可以将多个紧密耦合、共享资源且始终在一起运行的容器编排在同一个 Pod 中</li>
</ul>
<blockquote>
<p>副本（replicas）</p>
</blockquote>
<p>先引入“副本”的概念——一个 Pod 可以被复制成多份，每一份可被称之为一个“副本”，这些“副本”除了一些描述性的信息（Pod 的名字、uid 等）不一样以外，其它信息都是一样的，譬如 Pod 内部的容器、容器数量、容器里面运行的应用等的这些信息都是一样的，这些副本提供同样的功能。</p>
<p>Pod 的***“控制器”***通常包含一个名为 “replicas” 的属性。“replicas”属性则指定了特定 Pod 的副本的数量，当当前集群中该 Pod 的数量与该属性指定的值不一致时，k8s 会采取一些策略去使得当前状态满足配置的要求。</p>
<blockquote>
<p>控制器</p>
</blockquote>
<p>当 Pod 被创建出来，Pod 会被调度到集群中的节点上运行，Pod 会在该节点上一直保持运行状态，直到进程终止、Pod 对象被删除、Pod 因节点资源不足而被驱逐或者节点失效为止。Pod 并不会自愈，当节点失效，或者调度 Pod 的这一操作失败了，Pod 就该被删除。如此，单单用 Pod 来部署应用，是不稳定不安全的。</p>
<p>Kubernetes 使用更高级的资源对象 <strong>*“控制器”*</strong> 来实现对 Pod 的管理。控制器可以为您创建和管理多个 Pod，管理副本和上线，并在集群范围内提供自修复能力。 例如，如果一个节点失败，控制器可以在不同的节点上调度一样的替身来自动替换 Pod。</p>
<p><strong>适用无状态服务</strong></p>
<ul>
<li>
<p><code>ReplicationController（RC）</code></p>
<ul>
<li>Replication Controller 简称 RC，RC 是 Kubernetes 系统中的核心概念之一，简单来说，RC 可以保证在任意时间运行 Pod 的副本数量，能够保证 Pod 总是可用的。如果实际 Pod 数量比指定的多那就结束掉多余的，如果实际数量比指定的少就新启动一些 Pod，当 Pod 失败、被删除或者挂掉后，RC 都会去自动创建新的 Pod 来保证副本数量，所以即使只有一个 Pod，我们也应该使用 RC 来管理我们的 Pod。可以说，通过 ReplicationController，Kubernetes 实现了 Pod 的高可用性。</li>
</ul>
</li>
<li>
<p>ReplicaSet（RS）</p>
<ul>
<li>
<p>RC （ReplicationController ）主要的作用就是用来确保容器应用的副本数始终保持在用户定义的副本数 。即如果有容器异常退出，会自动创建新的 Pod 来替代；而如果异常多出来的容器也会自动回收（已经成为过去时），在 v1.11 版本废弃。</p>
<p><strong>Kubernetes 官方建议使用 RS（ReplicaSet ） 替代 RC （ReplicationController ） 进行部署，RS 跟 RC 没有本质的不同，只是名字不一样，并且 RS 支持集合式的 selector。</strong></p>
<p><code>Label 和 Selector</code></p>
<p>label （标签）是附加到 Kubernetes 对象（比如 Pods）上的键值对，用于区分对象（比如 Pod、Service）。 label 旨在用于指定对用户有意义且相关的对象的标识属性，但不直接对核心系统有语义含义。 label 可以用于组织和选择对象的子集。label 可以在创建时附加到对象，随后可以随时添加和修改。可以像 namespace 一样，使用 label 来获取某类对象，但 label 可以与 selector 一起配合使用，用表达式对条件加以限制，实现更精确、更灵活的资源查找。</p>
<p>label 与 selector 配合，可以实现对象的“关联”，“Pod 控制器” 与 Pod 是相关联的 —— “Pod 控制器”依赖于 Pod，可以给 Pod 设置 label，然后给“控制器”设置对应的 selector，这就实现了对象的关联。</p>
</li>
</ul>
</li>
<li>
<p>Deployment</p>
<ul>
<li>
<p>Deployment 为 Pod 和 Replica Set 提供声明式更新。</p>
<p>你只需要在 Deployment 中描述你想要的目标状态是什么，Deployment controller 就会帮你将 Pod 和 Replica Set 的实际状态改变到你的目标状态。你可以定义一个全新的 Deployment，也可以创建一个新的替换旧的 Deployment。</p>
<ol>
<li>创建 Replica Set / Pod</li>
<li>滚动升级/回滚</li>
<li>平滑扩容和缩容</li>
<li>暂停与恢复 Deployment</li>
</ol>
</li>
</ul>
</li>
</ul>
<p><strong>适用有状态服务</strong></p>
<p><code>StatefulSet</code></p>
<p>StatefulSet 中每个 Pod 的 DNS 格式为 statefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.local</p>
<ul>
<li>serviceName 为 Headless Service 的名字</li>
<li>0..N-1 为 Pod 所在的序号，从 0 开始到 N-1</li>
<li>statefulSetName 为 StatefulSet 的名字</li>
<li>namespace 为服务所在的 namespace，Headless Servic 和 StatefulSet 必须在相同的 namespace</li>
<li>.cluster.local 为 Cluster Domain</li>
</ul>
<p>主要特点</p>
<ol>
<li>稳定的持久化存储
<ul>
<li>即 Pod 重新调度后还是能访问到相同的持久化数据，基于 PVC 来实现</li>
</ul>
</li>
<li>稳定的网络标志
<ul>
<li>稳定的网络标志，即 Pod 重新调度后其 PodName 和 HostName 不变，基于 Headless Service（即没有 Cluster IP 的 Service）来实现</li>
</ul>
</li>
<li>有序部署，有序扩展
<ul>
<li>有序部署，有序扩展，即 Pod 是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行（即从 0 到 N-1，在下一个 Pod 运行之前所有之前的 Pod 必须都是 Running 和 Ready 状态），基于 init containers 来实现</li>
</ul>
</li>
<li>有序收缩，有序删除
<ul>
<li>有序收缩，有序删除（即从 N-1 到 0）</li>
</ul>
</li>
</ol>
<p>组成</p>
<ol>
<li>
<p>Headless Service</p>
<ul>
<li>
<p>用于定义网络标志（DNS domain）</p>
<p>Domain Name Server：域名服务
将域名与 ip 绑定映射关系</p>
<p>服务名 =&gt; 访问路径（域名） =&gt; ip</p>
</li>
</ul>
</li>
<li>
<p>volumeClaimTemplate</p>
<ul>
<li>用于创建 PersistentVolumes</li>
</ul>
</li>
</ol>
<p>注意事项</p>
<ol>
<li>kubernetes v1.5 版本以上才支持</li>
<li>所有 Pod 的 Volume 必须使用 PersistentVolume 或者是管理员事先创建好</li>
<li>为了保证数据安全，删除 StatefulSet 时不会删除 Volume</li>
<li>StatefulSet 需要一个 Headless Service 来定义 DNS domain，需要在 StatefulSet 之前创建好</li>
</ol>
<p><strong>守护进程</strong></p>
<p><code>DaemonSet</code></p>
<p>DaemonSet 保证在每个 Node 上都运行一个容器副本，常用来部署一些集群的日志、监控或者其他系统管理应用。典型的应用包括：</p>
<ul>
<li>日志收集，比如 fluentd，logstash 等</li>
<li>系统监控，比如 Prometheus Node Exporter，collectd，New Relic agent，Ganglia gmond 等</li>
<li>系统程序，比如 kube-proxy, kube-dns, glusterd, ceph 等</li>
</ul>
<p><strong>任务/定时任务</strong></p>
<ol>
<li>Job</li>
<li>CronJob</li>
</ol>
<h6 id="服务发现">服务发现
</h6><p><code>Service</code></p>
<p>“Service” 简写 “svc”。Pod 不能直接提供给外网访问，而是应该使用 service。Service 就是把 Pod 暴露出来提供服务，Service 才是真正的“服务”，它的中文名就叫“服务”。</p>
<p>可以说 Service 是一个应用服务的抽象，定义了 Pod 逻辑集合和访问这个 Pod 集合的策略。Service 代理 Pod 集合，对外表现为一个访问入口，访问该入口的请求将经过负载均衡，转发到后端 Pod 中的容器。</p>
<p><code>Ingress</code></p>
<p>Ingress 可以提供外网访问 Service 的能力。可以把某个请求地址映射、路由到特定的 service。</p>
<p>ingress 需要配合 ingress controller 一起使用才能发挥作用，ingress 只是相当于路由规则的集合而已，真正实现路由功能的，是 Ingress Controller，ingress controller 和其它 k8s 组件一样，也是在 Pod 中运行。</p>
<h6 id="存储">存储
</h6><p><code>Volume</code></p>
<p>数据卷，共享 Pod 中容器使用的数据。用来放持久化的数据，比如数据库数据。</p>
<p><code>CSI</code></p>
<p>Container Storage Interface 是由来自 Kubernetes、Mesos、Docker 等社区成员联合制定的一个行业标准接口规范，旨在将任意存储系统暴露给容器化应用程序。</p>
<p>CSI 规范定义了存储提供商实现 CSI 兼容的 Volume Plugin 的最小操作集和部署建议。CSI 规范的主要焦点是声明 Volume Plugin 必须实现的接口。</p>
<h6 id="特殊类型配置">特殊类型配置
</h6><p><code>ConfigMap</code></p>
<p>用来放配置，与 Secret 是类似的，只是 ConfigMap 放的是明文的数据，Secret 是密文存放。</p>
<p><code>Secret</code></p>
<p>Secret 解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec 中。Secret 可以以 Volume 或者环境变量的方式使用。</p>
<p><strong>Secret 有三种类型：</strong></p>
<ul>
<li>Service Account：用来访问 Kubernetes API，由 Kubernetes 自动创建，并且会自动挂载到 Pod 的 /run/secrets/kubernetes.io/serviceaccount 目录中；</li>
<li>Opaque：base64 编码格式的 Secret，用来存储密码、密钥等；</li>
<li>kubernetes.io/dockerconfigjson：用来存储私有 docker registry 的认证信息。</li>
</ul>
<p><code>DownwardAPI</code></p>
<p>downwardAPI 这个模式和其他模式不一样的地方在于它不是为了存放容器的数据也不是用来进行容器和宿主机的数据交换的，而是让 pod 里的容器能够直接获取到这个 pod 对象本身的一些信息。</p>
<p>downwardAPI 提供了两种方式用于将 pod 的信息注入到容器内部：</p>
<p>环境变量：用于单个变量，可以将 pod 信息和容器信息直接注入容器内部</p>
<p>volume 挂载：将 pod 信息生成为文件，直接挂载到容器内部中去</p>
<h6 id="其他">其他
</h6><p><code>Role</code></p>
<p>Role 是一组权限的集合，例如 Role 可以包含列出 Pod 权限及列出 Deployment 权限，Role 用于给某个 Namespace 中的资源进行鉴权。</p>
<p><code>RoleBinding</code></p>
<p>RoleBinding ：将 Subject 绑定到 Role，RoleBinding 使规则在命名空间内生效。</p>
<h4 id="对象规约和状态">对象规约和状态
</h4><p>对象是用来完成一些任务的，是持久的，是有目的性的，因此 kubernetes 创建一个对象后，将持续地工作以确保对象存在。当然，kubernetes 并不只是维持对象的存在这么简单，kubernetes 还管理着对象的方方面面。每个 Kubernetes 对象包含两个嵌套的对象字段，它们负责管理对象的配置，他们分别是 “spec” 和 “status” 。</p>
<h5 id="规约spec">规约（Spec）
</h5><p>“spec” 是 “规约”、“规格” 的意思，spec 是必需的，它描述了对象的期望状态（Desired State）—— 希望对象所具有的特征。当创建 Kubernetes 对象时，必须提供对象的规约，用来描述该对象的期望状态，以及关于对象的一些基本信息（例如名称）。</p>
<h5 id="状态status">状态（Status）
</h5><p>表示对象的实际状态，该属性由 k8s 自己维护，k8s 会通过一系列的<code>控制器</code>对<code>对应对象</code>进行管理，让对象尽可能的让实际状态与期望状态重合。</p>
<h2 id="k8s-实战进阶">K8S 实战进阶
</h2><h3 id="搭建-kubernetes-集群">搭建 Kubernetes 集群
</h3><h4 id="搭建方案">搭建方案
</h4><ol>
<li>
<p>minikube</p>
<ul>
<li>
<p><a class="link" href="https://minikube.sigs.k8s.io/"  target="_blank" rel="noopener" >minikube</a> 是一个工具， 能让你在本地运行 Kubernetes。 minikube 在你的个人计算机（包括 Windows、macOS 和 Linux PC）上运行一个一体化（all-in-one）或多节点的本地 Kubernetes 集群，以便你来尝试 Kubernetes 或者开展每天的开发工作。</p>
<p><a class="link" href="https://minikube.sigs.k8s.io/docs/start/"  target="_blank" rel="noopener" >官方安装文档</a></p>
</li>
</ul>
</li>
<li>
<p><strong><code>kubeadm</code></strong></p>
<ul>
<li>
<p>服务器要求</p>
<ol>
<li>3 台服务器（虚拟机）
<ul>
<li>k8s-master：192.168.133.130</li>
<li>k8s-node1：192.168.133.131</li>
<li>k8s-node2：192.168.133.132</li>
</ul>
</li>
<li>最低配置：2 核、2G 内存、20G 硬盘</li>
<li>最好能联网，不能联网的话需要有提供对应镜像的私有仓库</li>
</ol>
</li>
<li>
<p>软件环境</p>
<ol>
<li>操作系统：CentOS 7</li>
<li>Docker：20+</li>
<li>k8s：1.23.6</li>
</ol>
</li>
<li>
<p>安装步骤</p>
<blockquote>
<p>环境配置这里选择<code>20.10.7</code>版本的 Docker，因为 kubernetes 在<code>1.24</code>之后的版本不再支持<code>Docker</code>，所以这里选择安装<code>1.23.6</code>版本的<code>kubernetes</code></p>
</blockquote>
<p>这里准备三个虚拟机，一个作为<code>master</code>节点，另外两个分别是<code>node1</code>和<code>node2</code></p>
<p>以<code>kubeadm</code>的方式进行安装<code>kubernetes</code></p>
<blockquote>
<p><a class="link" href="https://blog.csdn.net/LONG_Yi_1994/article/details/127139637"  target="_blank" rel="noopener" >卸载 k8s 教程</a></p>
</blockquote>
<p>下面开始安装<code>k8s</code></p>
<p>在三台虚拟机上都需要执行</p>
<ol>
<li>
<p>初始操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 关闭防火墙</span>
</span></span><span class="line"><span class="cl">systemctl stop firewalld
</span></span><span class="line"><span class="cl">systemctl disable firewalld
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 关闭selinux</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config  <span class="c1"># 永久</span>
</span></span><span class="line"><span class="cl">setenforce <span class="m">0</span>  <span class="c1"># 临时</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 关闭swap</span>
</span></span><span class="line"><span class="cl">swapoff -a  <span class="c1"># 临时</span>
</span></span><span class="line"><span class="cl">sed -ri <span class="s1">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab    <span class="c1"># 永久</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 关闭完swap后，一定要重启一下虚拟机！！！</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 根据规划设置主机名</span>
</span></span><span class="line"><span class="cl">hostnamectl set-hostname &lt;hostname&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在master添加hosts</span>
</span></span><span class="line"><span class="cl">cat &gt;&gt; /etc/hosts <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">192.168.133.131 k8s-master
</span></span></span><span class="line"><span class="cl"><span class="s">192.168.133.132 k8s-node1
</span></span></span><span class="line"><span class="cl"><span class="s">192.168.133.133 k8s-node2
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将桥接的IPv4流量传递到iptables的链</span>
</span></span><span class="line"><span class="cl">cat &gt; /etc/sysctl.d/k8s.conf <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sysctl --system  <span class="c1"># 生效</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 时间同步</span>
</span></span><span class="line"><span class="cl">yum install ntpdate -y
</span></span><span class="line"><span class="cl">ntpdate time.windows.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看当前时间</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果发现时间不正确，先重启一下虚拟机</span>
</span></span><span class="line"><span class="cl">date
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>安装<code>Docker</code>过程跳过</p>
</blockquote>
</li>
<li>
<p>安装基础软件（所有节点）</p>
<ol>
<li>
<p>安装 Docker</p>
</li>
<li>
<p>添加阿里云 yum 源</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat &gt; /etc/yum.repos.d/kubernetes.repo <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="cl"><span class="s">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span class="line"><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s">repo_gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>安装 kubeadm、kubelet、kubectl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yum install -y kubelet-1.23.6 kubeadm-1.23.6 kubectl-1.23.6
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> kubelet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">systemctl status kubelet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置关闭 Docker 的 cgroups，修改 /etc/docker/daemon.json，加入以下内容</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;exec-opts&#34;</span>: <span class="o">[</span><span class="s2">&#34;native.cgroupdriver=systemd&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启 docker</span>
</span></span><span class="line"><span class="cl">systemctl daemon-reload
</span></span><span class="line"><span class="cl">systemctl restart docker
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
<li>
<p>部署 Kubernetes Master</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在 Master 节点下执行</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubeadm init <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      --apiserver-advertise-address<span class="o">=</span>192.168.133.131 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      --image-repository registry.aliyuncs.com/google_containers <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      --kubernetes-version v1.23.6 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      --service-cidr<span class="o">=</span>10.96.0.0/12 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      --pod-network-cidr<span class="o">=</span>10.244.0.0/16
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装成功后，复制如下配置并执行</span>
</span></span><span class="line"><span class="cl">mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">kubectl get nodes
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行之后看到如下信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">Your</span> <span class="n">Kubernetes</span> <span class="n">control</span><span class="o">-</span><span class="n">plane</span> <span class="n">has</span> <span class="n">initialized</span> <span class="n">successfully</span><span class="o">!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">To</span> <span class="n">start</span> <span class="n">using</span> <span class="n">your</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">as</span> <span class="n">a</span> <span class="n">regular</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">$</span><span class="n">HOME</span><span class="o">/.</span><span class="n">kube</span>
</span></span><span class="line"><span class="cl">  <span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span> <span class="o">$</span><span class="n">HOME</span><span class="o">/.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
</span></span><span class="line"><span class="cl">  <span class="n">sudo</span> <span class="n">chown</span> <span class="o">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">u</span><span class="p">):</span><span class="o">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">g</span><span class="p">)</span> <span class="o">$</span><span class="n">HOME</span><span class="o">/.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Alternatively</span><span class="p">,</span> <span class="k">if</span> <span class="n">you</span> <span class="n">are</span> <span class="n">the</span> <span class="n">root</span> <span class="n">user</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">run</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">export</span> <span class="n">KUBECONFIG</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">You</span> <span class="n">should</span> <span class="n">now</span> <span class="n">deploy</span> <span class="n">a</span> <span class="n">pod</span> <span class="n">network</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cluster</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Run</span> <span class="s2">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> <span class="n">with</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">options</span> <span class="n">listed</span> <span class="n">at</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">concepts</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">administration</span><span class="o">/</span><span class="n">addons</span><span class="o">/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Then</span> <span class="n">you</span> <span class="n">can</span> <span class="n">join</span> <span class="n">any</span> <span class="n">number</span> <span class="n">of</span> <span class="n">worker</span> <span class="n">nodes</span> <span class="n">by</span> <span class="n">running</span> <span class="n">the</span> <span class="n">following</span> <span class="n">on</span> <span class="n">each</span> <span class="n">as</span> <span class="n">root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">kubeadm</span> <span class="n">join</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">42.131</span><span class="p">:</span><span class="mi">6443</span> <span class="o">--</span><span class="n">token</span> <span class="n">g9tav3</span><span class="o">.</span><span class="n">xcm2xeniyr5oyib7</span> \
</span></span><span class="line"><span class="cl">	<span class="o">--</span><span class="n">discovery</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="nb">hash</span> <span class="n">sha256</span><span class="p">:</span><span class="mi">0</span><span class="n">a77d2c43287e745286bc98863e34ed678f5c9c9ee44a5c179d375755648852a</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>加入 Kubernetes Node</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 分别在 k8s-node1 和 k8s-node2 执行</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 下方命令可以在 k8s master 控制台初始化成功后复制 join 命令</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubeadm join 192.168.133.131:6443 --token j1wr0y.ej27ox9h3psu96jw --discovery-token-ca-cert-hash sha256:a751ecab11ba054ec4cb70d807de589ae6688324672f02fa4dc62560728d51d4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果初始化的 token 不小心清空了，可以通过如下命令获取或者重新申请</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果 token 已经过期，就重新申请</span>
</span></span><span class="line"><span class="cl">kubeadm token create
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># token 没有过期可以通过如下命令获取</span>
</span></span><span class="line"><span class="cl">kubeadm token list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取 --discovery-token-ca-cert-hash 值，得到值后需要在前面拼接上 sha256:</span>
</span></span><span class="line"><span class="cl">openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt <span class="p">|</span> openssl rsa -pubin -outform der 2&gt;/dev/null <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>openssl dgst -sha256 -hex <span class="p">|</span> sed <span class="s1">&#39;s/^.* //&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除旧的 kubelet 证书文件</span>
</span></span><span class="line"><span class="cl">rm -f  /opt/kubernetes/ssl/kubelet*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 kubelet kubeconfig 文件</span>
</span></span><span class="line"><span class="cl">rm -f /opt/kubernetes/cfg/kubelet.kubeconfig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启 kubelet 服务，让 master 重新颁发客户端证书</span>
</span></span><span class="line"><span class="cl">systemctl restart kubelet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重新join</span>
</span></span><span class="line"><span class="cl">kubeadm join 192.168.133.131:6443 --token f9gwk1.8xastiqq3p9khlzm --discovery-token-ca-cert-hash sha256:7c10606bed070f0eb4ab19399de70744fca7a3e1be7324c9102cb53ba0ac9be6
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到子节点打印如下内容，代表已经加入<code>k8s</code>集群环境了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">This node has joined the cluster:
</span></span><span class="line"><span class="cl">* Certificate signing request was sent to apiserver and a response was received.
</span></span><span class="line"><span class="cl">* The Kubelet was informed of the new secure connection details.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Run &#39;kubectl get nodes&#39; on the control-plane to see this node join the cluster
</span></span></code></pre></td></tr></table>
</div>
</div><p>我注意到 kubeadm init 时报过两个，<code>[WARNING SystemVerification]: this Docker version is not on the list of validated versions: 26.1.4. Latest validated version: 20.10</code></p>
<p>原因是 docker 版本问题，后来安装<code>20.10.7</code>版本的 docker 之后，该警告消除掉了</p>
<p>第二个警告是<code>[WARNING Swap]: swap is enabled; production deployments should disable swap unless testing the NodeSwap feature gate of the kubelet</code></p>
<p>执行以下命令即可<code>swapoff -a</code></p>
</li>
<li>
<p>部署 CNI 网络插件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在 master 节点上执行</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /opt/k8s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 下载 calico 配置文件，可能会网络超时</span>
</span></span><span class="line"><span class="cl">curl https://docs.projectcalico.org/manifests/calico.yaml -O
</span></span><span class="line"><span class="cl">wget https://docs.projectcalico.org/manifests/calico.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改 calico.yaml 文件中的 CALICO_IPV4POOL_CIDR 配置，修改为与初始化的 cidr 相同(10.244.0.0/16)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改 IP_AUTODETECTION_METHOD 下的网卡名称</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/&#34;autodetect&#34;/&#34;autodetect&#34;\n            - name: IP_AUTODETECTION_METHOD\n               value: &#34;interface=ens33&#34;/g&#39;</span> calico.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看需要下载的镜像</span>
</span></span><span class="line"><span class="cl">grep image calico.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除镜像 docker.io/ 前缀，避免下载过慢导致失败</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s#docker.io/##g&#39;</span> calico.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看删除前缀的操作是否成功</span>
</span></span><span class="line"><span class="cl">grep image calico.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 构建应用</span>
</span></span><span class="line"><span class="cl">kubectl apply -f calico.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除应用</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubectl delete -f calico.yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看构建结果(Pending在执行中，需要等待变成Running)</span>
</span></span><span class="line"><span class="cl">kubectl get po -n kube-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pending状况</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 格式:kubectl describe po &lt;name&gt; -n kube-system</span>
</span></span><span class="line"><span class="cl">kubectl describe po calico-node-sc9g6 -n kube-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">docker images <span class="p">|</span> grep calico/cni
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>如果拉取镜像超时，可以通过配置<code>/etc/docker/daemon.json</code>文件</p>
</blockquote>
<p>我在安装过程中遇到的问题如下</p>
<p>搭建 k8s 集群时一直 NotReady，我遇到的原因是镜像拉取失败 calico/cni:v3.25.0、calico/node:v3.25.0，配置/etc/docker/daemon.json 文件如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;registry-mirrors&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;https://hub.uuuadc.top&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;https://docker.anyhub.us.kg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;https://dockerhub.jobcher.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;https://dockerhub.icu&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;https://docker.ckyl.me&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;https://docker.awsl9527.cn&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;exec-opts&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;native.cgroupdriver=systemd&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;log-driver&#34;</span><span class="p">:</span> <span class="s2">&#34;json-file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;log-opts&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;max-size&#34;</span><span class="p">:</span> <span class="s2">&#34;100m&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;storage-driver&#34;</span><span class="p">:</span> <span class="s2">&#34;overlay2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>继续使用如下命令更新配置，再重新 pull 一遍即可</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo systemctl daemon-reload
</span></span><span class="line"><span class="cl">sudo systemctl restart docker
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>测试 kubernetes 集群</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 创建部署</span>
</span></span><span class="line"><span class="cl">kubectl create deployment nginx --image<span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 暴露端口</span>
</span></span><span class="line"><span class="cl">kubectl expose deployment nginx --port<span class="o">=</span><span class="m">80</span> --type<span class="o">=</span>NodePort
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 pod 以及服务信息</span>
</span></span><span class="line"><span class="cl">kubectl get pod,svc
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
</li>
<li>
<p>二进制安装</p>
<ul>
<li>利用 k8s 官方 github 仓库下载二进制包安装，安装过程较复杂，但相对较为稳定，推荐生产环境使用。</li>
</ul>
</li>
<li>
<p>命令行工具</p>
</li>
</ol>
<h4 id="命令行工具-kubectl">命令行工具 kubectl
</h4><p>Kubernetes 提供 kubectl 是使用 Kubernetes API 与 Kubernetes 集群的<a class="link" href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-control-plane"  target="_blank" rel="noopener" >控制面</a>进行通信的命令行工具。</p>
<p>这个工具叫做 kubectl。
<a class="link" href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands"  target="_blank" rel="noopener" >更多命令</a></p>
<p><a class="link" href="https://kubernetes.io/zh-cn/docs/reference/kubectl/generated/kubectl/"  target="_blank" rel="noopener" >kubectl 命令</a></p>
<h5 id="在任意节点使用-kubectl">在任意节点使用 kubectl
</h5><h6 id="将-master-节点中-etckubernetesadminconf-拷贝到需要运行的服务器的-etckubernetes-目录中">将 master 节点中 /etc/kubernetes/admin.conf 拷贝到需要运行的服务器的 /etc/kubernetes 目录中
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">scp /etc/kubernetes/admin.conf root@k8s-node1:/etc/kubernetes
</span></span><span class="line"><span class="cl">scp /etc/kubernetes/admin.conf root@k8s-node2:/etc/kubernetes
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="在对应的服务器上配置环境变量">在对应的服务器上配置环境变量
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;export KUBECONFIG=/etc/kubernetes/admin.conf&#34;</span> &gt;&gt; ~/.bash_profile
</span></span><span class="line"><span class="cl"><span class="nb">source</span> ~/.bash_profile
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>在子节点上执行<code>kubectl</code>命令查看是否成功</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pod,svc
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="资源操作">资源操作
</h5><h6 id="创建对象">创建对象
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create -f ./my-manifest.yaml           <span class="c1"># 创建资源</span>
</span></span><span class="line"><span class="cl">kubectl create -f ./my1.yaml -f ./my2.yaml     <span class="c1"># 使用多个文件创建资源</span>
</span></span><span class="line"><span class="cl">kubectl create -f ./dir                        <span class="c1"># 使用目录下的所有清单文件来创建资源</span>
</span></span><span class="line"><span class="cl">kubectl create -f https://git.io/vPieo         <span class="c1"># 使用 url 来创建资源</span>
</span></span><span class="line"><span class="cl">kubectl run nginx --image<span class="o">=</span>nginx                <span class="c1"># 启动一个 nginx 实例</span>
</span></span><span class="line"><span class="cl">kubectl explain pods,svc                       <span class="c1"># 获取 pod 和 svc 的文档</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 从 stdin 输入中创建多个 YAML 对象</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Pod
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: busybox-sleep
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  containers:
</span></span></span><span class="line"><span class="cl"><span class="s">  - name: busybox
</span></span></span><span class="line"><span class="cl"><span class="s">    image: busybox
</span></span></span><span class="line"><span class="cl"><span class="s">    args:
</span></span></span><span class="line"><span class="cl"><span class="s">    - sleep
</span></span></span><span class="line"><span class="cl"><span class="s">    - &#34;1000000&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Pod
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: busybox-sleep-less
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  containers:
</span></span></span><span class="line"><span class="cl"><span class="s">  - name: busybox
</span></span></span><span class="line"><span class="cl"><span class="s">    image: busybox
</span></span></span><span class="line"><span class="cl"><span class="s">    args:
</span></span></span><span class="line"><span class="cl"><span class="s">    - sleep
</span></span></span><span class="line"><span class="cl"><span class="s">    - &#34;1000&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建包含几个 key 的 Secret</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Secret
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: mysecret
</span></span></span><span class="line"><span class="cl"><span class="s">type: Opaque
</span></span></span><span class="line"><span class="cl"><span class="s">data:
</span></span></span><span class="line"><span class="cl"><span class="s">  password: $(echo &#34;s33msi4&#34; | base64)
</span></span></span><span class="line"><span class="cl"><span class="s">  username: $(echo &#34;jane&#34; | base64)
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>nginx-demo.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod相关的元数据，用于描述Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-demo</span><span class="w"> </span><span class="c"># Pod的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义Pod的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">myFirstApp</span><span class="w"> </span><span class="c"># 以下全部都是自定义标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望Pod根据这里的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于Pod中容器的描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 指定镜像的拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时，执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 指定工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 容器内暴露的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于什么协议进行通讯的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 1000m等于一个cpu核心，最少使用0.1个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多使用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制cpu最多使用0.2个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制内存最多使用256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 配置重启策略</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>可使用如下命令创建 pod</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create -f nginx-demo.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="显示和查找资源">显示和查找资源
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Get commands with basic output</span>
</span></span><span class="line"><span class="cl">$ kubectl get services                          <span class="c1"># 列出所有 namespace 中的所有 service</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods --all-namespaces             <span class="c1"># 列出所有 namespace 中的所有 pod</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods -o wide                      <span class="c1"># 列出所有 pod 并显示详细信息</span>
</span></span><span class="line"><span class="cl">$ kubectl get deployment my-dep                 <span class="c1"># 列出指定 deployment</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods --include-uninitialized      <span class="c1"># 列出该 namespace 中的所有 pod 包括未初始化的</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用详细输出来描述命令</span>
</span></span><span class="line"><span class="cl">$ kubectl describe nodes my-node
</span></span><span class="line"><span class="cl">$ kubectl describe pods my-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get services --sort-by<span class="o">=</span>.metadata.name <span class="c1"># List Services Sorted by Name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 根据重启次数排序列出 pod</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods --sort-by<span class="o">=</span><span class="s1">&#39;.status.containerStatuses[0].restartCount&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取所有具有 app=cassandra 的 pod 中的 version 标签</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods --selector<span class="o">=</span><span class="nv">app</span><span class="o">=</span>cassandra rc -o <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[*].metadata.labels.version}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取所有节点的 ExternalIP</span>
</span></span><span class="line"><span class="cl">$ kubectl get nodes -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[*].status.addresses[?(@.type==&#34;ExternalIP&#34;)].address}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 列出属于某个 PC 的 Pod 的名字</span>
</span></span><span class="line"><span class="cl"><span class="c1"># “jq”命令用于转换复杂的 jsonpath，参考 https://stedolan.github.io/jq/</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">sel</span><span class="o">=</span><span class="si">${</span><span class="k">$(</span>kubectl get rc my-rc --output<span class="o">=</span>json <span class="p">|</span> jq -j <span class="s1">&#39;.spec.selector | to_entries | .[] | &#34;\(.key)=\(.value),&#34;&#39;</span><span class="k">)</span><span class="p">%?</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="k">$(</span>kubectl get pods --selector<span class="o">=</span><span class="nv">$sel</span> --output<span class="o">=</span><span class="nv">jsonpath</span><span class="o">={</span>.items..metadata.name<span class="o">}</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看哪些节点已就绪</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">JSONPATH</span><span class="o">=</span><span class="s1">&#39;{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> <span class="o">&amp;&amp;</span> kubectl get nodes -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$JSONPATH</span><span class="s2">&#34;</span> <span class="p">|</span> grep <span class="s2">&#34;Ready=True&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 列出当前 Pod 中使用的 Secret</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods -o json <span class="p">|</span> jq <span class="s1">&#39;.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name&#39;</span> <span class="p">|</span> grep -v null <span class="p">|</span> sort <span class="p">|</span> uniq
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="更新资源">更新资源
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl rolling-update frontend-v1 -f frontend-v2.json           <span class="c1"># 滚动更新 pod frontend-v1</span>
</span></span><span class="line"><span class="cl">$ kubectl rolling-update frontend-v1 frontend-v2 --image<span class="o">=</span>image:v2  <span class="c1"># 更新资源名称并更新镜像</span>
</span></span><span class="line"><span class="cl">$ kubectl rolling-update frontend --image<span class="o">=</span>image:v2                 <span class="c1"># 更新 frontend pod 中的镜像</span>
</span></span><span class="line"><span class="cl">$ kubectl rolling-update frontend-v1 frontend-v2 --rollback        <span class="c1"># 退出已存在的进行中的滚动更新</span>
</span></span><span class="line"><span class="cl">$ cat pod.json <span class="p">|</span> kubectl replace -f -                              <span class="c1"># 基于 stdin 输入的 JSON 替换 pod</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 强制替换，删除后重新创建资源。会导致服务中断。</span>
</span></span><span class="line"><span class="cl">$ kubectl replace --force -f ./pod.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为 nginx RC 创建服务，启用本地 80 端口连接到容器上的 8000 端口</span>
</span></span><span class="line"><span class="cl">$ kubectl expose rc nginx --port<span class="o">=</span><span class="m">80</span> --target-port<span class="o">=</span><span class="m">8000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 更新单容器 pod 的镜像版本（tag）到 v4</span>
</span></span><span class="line"><span class="cl">$ kubectl get pod mypod -o yaml <span class="p">|</span> sed <span class="s1">&#39;s/\(image: myimage\):.*$/\1:v4/&#39;</span> <span class="p">|</span> kubectl replace -f -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl label pods my-pod new-label<span class="o">=</span>awesome                      <span class="c1"># 添加标签</span>
</span></span><span class="line"><span class="cl">$ kubectl annotate pods my-pod icon-url<span class="o">=</span>http://goo.gl/XXBTWq       <span class="c1"># 添加注解</span>
</span></span><span class="line"><span class="cl">$ kubectl autoscale deployment foo --min<span class="o">=</span><span class="m">2</span> --max<span class="o">=</span><span class="m">10</span>                <span class="c1"># 自动扩展 deployment “foo”</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="修补资源">修补资源
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl patch node k8s-node-1 -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;unschedulable&#34;:true}}&#39;</span> <span class="c1"># 部分更新节点</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 更新容器镜像； spec.containers[*].name 是必须的，因为这是合并的关键字</span>
</span></span><span class="line"><span class="cl">$ kubectl patch pod valid-pod -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;kubernetes-serve-hostname&#34;,&#34;image&#34;:&#34;new image&#34;}]}}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用具有位置数组的 json 补丁更新容器镜像</span>
</span></span><span class="line"><span class="cl">$ kubectl patch pod valid-pod --type<span class="o">=</span><span class="s1">&#39;json&#39;</span> -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/containers/0/image&#34;, &#34;value&#34;:&#34;new image&#34;}]&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用具有位置数组的 json 补丁禁用 deployment 的 livenessProbe</span>
</span></span><span class="line"><span class="cl">$ kubectl patch deployment valid-deployment  --type json   -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/livenessProbe&#34;}]&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="编辑资源">编辑资源
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl edit svc/docker-registry                      <span class="c1"># 编辑名为 docker-registry 的 service</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">KUBE_EDITOR</span><span class="o">=</span><span class="s2">&#34;nano&#34;</span> kubectl edit svc/docker-registry   <span class="c1"># 使用其它编辑器</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="scale-资源">scale 资源
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl scale --replicas<span class="o">=</span><span class="m">3</span> rs/foo                                 <span class="c1"># Scale a replicaset named &#39;foo&#39; to 3</span>
</span></span><span class="line"><span class="cl">$ kubectl scale --replicas<span class="o">=</span><span class="m">3</span> -f foo.yaml                            <span class="c1"># Scale a resource specified in &#34;foo.yaml&#34; to 3</span>
</span></span><span class="line"><span class="cl">$ kubectl scale --current-replicas<span class="o">=</span><span class="m">2</span> --replicas<span class="o">=</span><span class="m">3</span> deployment/mysql  <span class="c1"># If the deployment named mysql&#39;s current size is 2, scale mysql to 3</span>
</span></span><span class="line"><span class="cl">$ kubectl scale --replicas<span class="o">=</span><span class="m">5</span> rc/foo rc/bar rc/baz                   <span class="c1"># Scale multiple replication controllers</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="删除资源">删除资源
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl delete -f ./pod.json                                              <span class="c1"># 删除 pod.json 文件中定义的类型和名称的 pod</span>
</span></span><span class="line"><span class="cl">$ kubectl delete pod,service baz foo                                        <span class="c1"># 删除名为“baz”的 pod 和名为“foo”的 service</span>
</span></span><span class="line"><span class="cl">$ kubectl delete pods,services -l <span class="nv">name</span><span class="o">=</span>myLabel                              <span class="c1"># 删除具有 name=myLabel 标签的 pod 和 serivce</span>
</span></span><span class="line"><span class="cl">$ kubectl delete pods,services -l <span class="nv">name</span><span class="o">=</span>myLabel --include-uninitialized      <span class="c1"># 删除具有 name=myLabel 标签的 pod 和 service，包括尚未初始化的</span>
</span></span><span class="line"><span class="cl">$ kubectl -n my-ns delete po,svc --all                                      <span class="c1"># 删除 my-ns namespace 下的所有 pod 和 serivce，包括尚未初始化的</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="pod-与集群">Pod 与集群
</h5><h6 id="与运行的-pod-交互">与运行的 Pod 交互
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl logs my-pod                                 <span class="c1"># dump 输出 pod 的日志（stdout）</span>
</span></span><span class="line"><span class="cl">$ kubectl logs my-pod -c my-container                 <span class="c1"># dump 输出 pod 中容器的日志（stdout，pod 中有多个容器的情况下使用）</span>
</span></span><span class="line"><span class="cl">$ kubectl logs -f my-pod                              <span class="c1"># 流式输出 pod 的日志（stdout）</span>
</span></span><span class="line"><span class="cl">$ kubectl logs -f my-pod -c my-container              <span class="c1"># 流式输出 pod 中容器的日志（stdout，pod 中有多个容器的情况下使用）</span>
</span></span><span class="line"><span class="cl">$ kubectl run -i --tty busybox --image<span class="o">=</span>busybox -- sh  <span class="c1"># 交互式 shell 的方式运行 pod</span>
</span></span><span class="line"><span class="cl">$ kubectl attach my-pod -i                            <span class="c1"># 连接到运行中的容器</span>
</span></span><span class="line"><span class="cl">$ kubectl port-forward my-pod 5000:6000               <span class="c1"># 转发 pod 中的 6000 端口到本地的 5000 端口</span>
</span></span><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> my-pod -- ls /                         <span class="c1"># 在已存在的容器中执行命令（只有一个容器的情况下）</span>
</span></span><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> my-pod -c my-container -- ls /         <span class="c1"># 在已存在的容器中执行命令（pod 中有多个容器的情况下）</span>
</span></span><span class="line"><span class="cl">$ kubectl top pod POD_NAME --containers               <span class="c1"># 显示指定 pod 和容器的指标度量</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="与节点和集群交互">与节点和集群交互
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl cordon my-node                                                <span class="c1"># 标记 my-node 不可调度</span>
</span></span><span class="line"><span class="cl">$ kubectl drain my-node                                                 <span class="c1"># 清空 my-node 以待维护</span>
</span></span><span class="line"><span class="cl">$ kubectl uncordon my-node                                              <span class="c1"># 标记 my-node 可调度</span>
</span></span><span class="line"><span class="cl">$ kubectl top node my-node                                              <span class="c1"># 显示 my-node 的指标度量</span>
</span></span><span class="line"><span class="cl">$ kubectl cluster-info                                                  <span class="c1"># 显示 master 和服务的地址</span>
</span></span><span class="line"><span class="cl">$ kubectl cluster-info dump                                             <span class="c1"># 将当前集群状态输出到 stdout</span>
</span></span><span class="line"><span class="cl">$ kubectl cluster-info dump --output-directory<span class="o">=</span>/path/to/cluster-state   <span class="c1"># 将当前集群状态输出到 /path/to/cluster-state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果该键和影响的污点（taint）已存在，则使用指定的值替换</span>
</span></span><span class="line"><span class="cl">$ kubectl taint nodes foo <span class="nv">dedicated</span><span class="o">=</span>special-user:NoSchedule
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="资源类型与别名">资源类型与别名
</h4><h5 id="pods">pods
</h5><blockquote>
<p>po</p>
</blockquote>
<p>Pod 的设计理念是支持多个容器在一个 Pod 中共享网络地址和文件系统，可以通过进程间通信和文件共享这种简单高效的方式组合完成服务。Pod 对多容器的支持是 K8 最基础的设计理念。比如你运行一个操作系统发行版的软件仓库，一个 Nginx 容器用来发布软件，另一个容器专门用来从源仓库做同步，这两个容器的镜像不太可能是一个团队开发的，但是他们一块儿工作才能提供一个微服务；这种情况下，不同的团队各自开发构建自己的容器镜像，在部署的时候组合成一个微服务对外提供服务。</p>
<p>Kubernetes（k8s）中的 Pod 与 Docker Compose 有相似之处</p>
<h5 id="replication-controller">Replication Controller
</h5><blockquote>
<p>rc（副本控制器）</p>
</blockquote>
<p>RC 是 Kubernetes 集群中最早的保证 Pod 高可用的 API 对象。通过监控运行中的 Pod 来保证集群中运行指定数目的 Pod 副本。指定的数目可以是多个也可以是 1 个；少于指定数目，RC 就会启动运行新的 Pod 副本；多于指定数目，RC 就会杀死多余的 Pod 副本。即使在指定数目为 1 的情况下，通过 RC 运行 Pod 也比直接运行 Pod 更明智，因为 RC 也可以发挥它高可用的能力，保证永远有 1 个 Pod 在运行。RC 是 Kubernetes 较早期的技术概念，只适用于长期伺服型的业务类型，比如控制小机器人提供高可用的 Web 服务。</p>
<p>Replica Set</p>
<blockquote>
<p>rs（副本集）</p>
</blockquote>
<p>RS 是新一代 RC，提供同样的高可用能力，区别主要在于 <code>RS</code> 后来居上，能支持更多种类的匹配模式。副本集对象一般不单独使用，而是作为 Deployment 的理想状态参数使用。</p>
<h5 id="deployments">deployments
</h5><blockquote>
<p>deploy</p>
</blockquote>
<p>部署表示用户对 Kubernetes 集群的一次更新操作。部署是一个比 RS 应用模式更广的 API 对象，可以是创建一个新的服务，更新一个新的服务，也可以是滚动升级一个服务。滚动升级一个服务，实际是创建一个新的 RS，然后逐渐将新 RS 中副本数增加到理想状态，将旧 RS 中的副本数减小到 0 的复合操作；这样一个复合操作用一个 RS 是不太好描述的，所以用一个更通用的 Deployment 来描述。以 Kubernetes 的发展方向，未来对所有长期伺服型的的业务的管理，都会通过 Deployment 来管理。</p>
<h5 id="statefulset">statefulset
</h5><blockquote>
<p>sts（有状态服务集）</p>
</blockquote>
<p>RC 和 RS 主要是控制提供无状态服务的，其所控制的 Pod 的名字是随机设置的，一个 Pod 出故障了就被丢弃掉，在另一个地方重启一个新的 Pod，名字变了。名字和启动在哪儿都不重要，重要的只是 Pod 总数；而 StatefulSet 是用来控制有状态服务，StatefulSet 中的每个 Pod 的名字都是事先确定的，不能更改。</p>
<p>对于 RC 和 RS 中的 Pod，一般不挂载存储或者挂载共享存储，保存的是所有 Pod 共享的状态；对于 StatefulSet 中的 Pod，每个 Pod 挂载自己独立的存储，如果一个 Pod 出现故障，从其他节点启动一个同样名字的 Pod，要挂载上原来 Pod 的存储继续以它的状态提供服务。</p>
<p>适合于 StatefulSet 的业务包括数据库服务 MySQL 和 PostgreSQL，集群化管理服务 ZooKeeper、etcd 等有状态服务。StatefulSet 的另一种典型应用场景是作为一种比普通容器更稳定可靠的模拟虚拟机的机制。传统的虚拟机正是一种有状态的宠物，运维人员需要不断地维护它，容器刚开始流行时，我们用容器来模拟虚拟机使用，所有状态都保存在容器里，而这已被证明是非常不安全、不可靠的。使用 StatefulSet，Pod 仍然可以通过漂移到不同节点提供高可用，而存储也可以通过外挂的存储来提供高可靠性，StatefulSet 做的只是将确定的 Pod 与确定的存储关联起来保证状态的连续性。</p>
<h5 id="volume">volume
</h5><p>Kubernetes 集群中的存储卷跟 Docker 的存储卷有些类似，只不过 Docker 的存储卷作用范围为一个容器，而 Kubernetes 的存储卷的生命周期和作用范围是一个 Pod。每个 Pod 中声明的存储卷由 Pod 中的所有容器共享。Kubernetes 支持非常多的存储卷类型，特别的，支持多种公有云平台的存储，包括 AWS，Google 和 Azure 云；支持多种分布式存储包括 GlusterFS 和 Ceph；也支持较容易使用的主机本地目录 emptyDir, hostPath 和 NFS。Kubernetes 还支持使用 Persistent Volume Claim 即 PVC 这种逻辑存储，使用这种存储，使得存储的使用者可以忽略后台的实际存储技术（例如 AWS，Google 或 GlusterFS 和 Ceph），而将有关存储实际技术的配置交给存储管理员通过 Persistent Volume 来配置。</p>
<h5 id="services">services
</h5><blockquote>
<p>svc</p>
</blockquote>
<h5 id="namespace">namespace
</h5><blockquote>
<p>ns</p>
</blockquote>
<p>命名空间为 Kubernetes 集群提供虚拟的隔离作用，Kubernetes 集群初始有两个命名空间，分别是默认命名空间 default 和系统命名空间 kube-system，除此以外，管理员可以可以创建新的命名空间满足需要。</p>
<h5 id="nodes">nodes
</h5><blockquote>
<p>no</p>
</blockquote>
<h4 id="格式化输出">格式化输出
</h4><h5 id="输出-json-格式">输出 json 格式
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-o json
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="仅打印资源名称">仅打印资源名称
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-o name
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="以纯文本格式输出所有信息">以纯文本格式输出所有信息
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-o wide
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="输出-yaml-格式">输出 yaml 格式
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-o yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="api-概述">API 概述
</h4><p>官网文档：https://kubernetes.io/zh-cn/docs/reference/using-api/</p>
<p>REST API 是 Kubernetes 系统的重要部分，组件之间的所有操作和通信均由 API Server 处理的 REST AP I 调用，大多数情况下， API 定义和实现都符合标准的 HTTP REST 格式，可以通过 <a class="link" href="http://docs.kubernetes.org.cn/61.html"  target="_blank" rel="noopener" >kubectl</a> 命令管理工具或其他命令行工具来执行。</p>
<h5 id="类型">类型
</h5><h6 id="alpha">Alpha
</h6><ul>
<li>包含 alpha 名称的版本（例如 v1alpha1）。</li>
<li>该软件可能包含错误。启用一个功能可能会导致 bug。默认情况下，功能可能会被禁用。</li>
<li>随时可能会丢弃对该功能的支持，恕不另行通知。</li>
<li>API 可能在以后的软件版本中以不兼容的方式更改，恕不另行通知。</li>
<li>该软件建议仅在短期测试集群中使用，因为错误的风险增加和缺乏长期支持。</li>
</ul>
<h6 id="beta">Beta
</h6><ul>
<li>包含 <strong>beta</strong> 名称的版本（例如 <strong>v2beta3</strong>）。</li>
<li>该软件经过很好的测试。启用功能被认为是安全的。默认情况下功能是开启的。</li>
<li>细节可能会改变，但功能在后续版本不会被删除</li>
<li>对象的模式或语义在随后的 beta 版本或 Stable 版本中可能以不兼容的方式发生变化。如果这种情况发生时，官方会提供迁移操作指南。这可能需要删除、编辑和重新创建 API 对象。</li>
<li>该版本在后续可能会更改一些不兼容地方，所以建议用于非关键业务，如果你有多个可以独立升级的集群，你也可以放宽此限制。</li>
<li><strong>大家使用过的 Beta 版本后，可以多给社区反馈，如果此版本在后续更新后将不会有太大变化。</strong></li>
</ul>
<h6 id="stable">Stable
</h6><ul>
<li>该版本名称命名方式：<strong>vX</strong> 这里 <strong>X</strong> 是一个整数。</li>
<li>Stable 版本的功能特性，将出现在后续发布的软件版本中。</li>
</ul>
<h5 id="访问控制">访问控制
</h5><h6 id="认证">认证
</h6><h6 id="授权">授权
</h6><h5 id="废弃-api-说明">废弃 api 说明
</h5><p><a class="link" href="https://kubernetes.io/zh-cn/docs/reference/using-api/deprecation-guide/"  target="_blank" rel="noopener" >相关文档</a></p>
<h3 id="深入-pod">深入 Pod
</h3><h4 id="pod-配置文件">Pod 配置文件
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api 文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型，也可以配置为像Deployment、StatefulSet这一类的对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod 相关的元数据，用于描述 Pod 的数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-demo</span><span class="w"> </span><span class="c"># Pod 的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义 Pod 的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w"> </span><span class="c"># 自定义 label 标签，名字为 type，值为 app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="m">1.0.0</span><span class="w"> </span><span class="c"># 自定义 label 标签，描述 Pod 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间的配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望 Pod 按照这里面的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于 Pod 中的容器描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 镜像拉取策略，指定如果本地有就用本地的，如果没有就拉取远程的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 定义容器启动后的工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 描述容器内要暴露什么端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于哪种协议通信的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量的值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reousrces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 限制 cpu 最少使用 0.1 个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用 128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多可以用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制 cpu 最多使用 0.2 个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制 最多使用 256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 重启策略，只有失败的情况才会重启</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>执行以下命令进行创建</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># -f 指定创建模板</span>
</span></span><span class="line"><span class="cl">kubectl create -f nginx-demo.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pods状态，发现已经在运行了</span>
</span></span><span class="line"><span class="cl">kubectl get po
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看更加详细的信息，如端口号</span>
</span></span><span class="line"><span class="cl">kubectl get po -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME         READY   STATUS    RESTARTS   AGE     IP               NODE        NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">nginx-demo   1/1     Running   <span class="m">0</span>          2m26s   10.244.169.131   k8s-node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以看到这个时候的ip(10.244.169.131)和节点(node2)</span>
</span></span><span class="line"><span class="cl">route -n
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.42.2    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> ens33
</span></span><span class="line"><span class="cl">10.244.36.64    192.168.42.132  255.255.255.192 UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> tunl0
</span></span><span class="line"><span class="cl">10.244.169.128  192.168.42.133  255.255.255.192 UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> tunl0
</span></span><span class="line"><span class="cl">10.244.235.192  0.0.0.0         255.255.255.192 U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> *
</span></span><span class="line"><span class="cl">172.17.0.0      0.0.0.0         255.255.0.0     U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> docker0
</span></span><span class="line"><span class="cl">192.168.42.0    0.0.0.0         255.255.255.0   U     <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> ens33
</span></span><span class="line"><span class="cl">192.168.122.0   0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> virbr0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以看到确实被路由到了node2节点上，这个功能是由于我们之前安装了`CNI 网络插件`实现的</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip(10.244.169.131)通过node2节点进行转发，此时再进入node2节点下查看路由信息，就可以找到当前的网关了</span>
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         192.168.42.2    0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> ens33
</span></span><span class="line"><span class="cl">10.244.36.64    192.168.42.132  255.255.255.192 UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> tunl0
</span></span><span class="line"><span class="cl">10.244.169.128  0.0.0.0         255.255.255.192 U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> *
</span></span><span class="line"><span class="cl">10.244.169.130  0.0.0.0         255.255.255.255 UH    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> cali11b82779865
</span></span><span class="line"><span class="cl">10.244.169.131  0.0.0.0         255.255.255.255 UH    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> cali7543b7f115c
</span></span><span class="line"><span class="cl">10.244.235.192  192.168.42.131  255.255.255.192 UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> tunl0
</span></span><span class="line"><span class="cl">172.17.0.0      0.0.0.0         255.255.0.0     U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> docker0
</span></span><span class="line"><span class="cl">192.168.42.0    0.0.0.0         255.255.255.0   U     <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> ens33
</span></span><span class="line"><span class="cl">192.168.122.0   0.0.0.0         255.255.255.0   U     <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> virbr0
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="探针">探针
</h4><blockquote>
<p>在实际运行中可能会由于各种原因导致服务挂掉，比如内存溢出</p>
<p>但是 pod 怎么监听到容器挂掉了呢？是通过<code>探针</code>来监控容器实现</p>
<p>需要关注下配置的<code>重启策略(restartPolicy)</code>，当容器挂掉之后，kubelet 会根据配置的重启策略进行重启</p>
</blockquote>
<p>容器内应用的监测机制，根据不同的探针来判断容器应用当前的状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 删除nginx-demo pod</span>
</span></span><span class="line"><span class="cl">kubectl delete po nginx-demo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改yaml，新增探针配置</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="startupprobe">StartupProbe
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod相关的元数据，用于描述Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-demo</span><span class="w"> </span><span class="c"># Pod的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义Pod的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">myFirstApp</span><span class="w"> </span><span class="c"># 以下全部都是自定义标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望Pod根据这里的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于Pod中容器的描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 指定镜像的拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 应用启动探针配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">httpGet</span><span class="p">:</span><span class="w"> </span><span class="c"># 探测方式，基于http请求探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/api/path</span><span class="w"> </span><span class="c"># http请求路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># http请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 失败重试多少次后，真正失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 多少次成功后，真正成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 请求的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时，执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 指定工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 容器内暴露的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于什么协议进行通讯的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 1000m等于一个cpu核心，最少使用0.1个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多使用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制cpu最多使用0.2个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制内存最多使用256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 配置重启策略</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 创建po</span>
</span></span><span class="line"><span class="cl">kubectl create -f nginx-demo.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看po状态</span>
</span></span><span class="line"><span class="cl">kubectl get po
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看详细信息</span>
</span></span><span class="line"><span class="cl">kubectl describe po nginx-demo
</span></span><span class="line"><span class="cl"><span class="c1"># 发现有如下日志</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Warning  Unhealthy  6s (x7 over 66s)   kubelet            Startup probe failed: HTTP probe failed with statuscode: 404</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 因为nginx并没有/api/path请求路径，所以报404</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 现在更改为/index.html后重新构建po</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 发现构建成功</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  Normal  Started    7s    kubelet            Started container nginx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置文件修改成如下，不再使用http，使用tcpSocket的协议</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 只要成功建立tcp连接，我们就认为pod构建成功</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 编辑pods</span>
</span></span><span class="line"><span class="cl">kubectl edit po nginx-demo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除pods</span>
</span></span><span class="line"><span class="cl">kubectl delete po nginx-demo
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod相关的元数据，用于描述Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-demo</span><span class="w"> </span><span class="c"># Pod的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义Pod的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">myFirstApp</span><span class="w"> </span><span class="c"># 以下全部都是自定义标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望Pod根据这里的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于Pod中容器的描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 指定镜像的拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 应用启动探针配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># httpGet: # 探测方式，基于http请求探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   path: /index.html # http请求路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80 # http请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tcpSocket</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 失败重试多少次后，真正失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 多少次成功后，真正成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 请求的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时，执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 指定工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 容器内暴露的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于什么协议进行通讯的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 1000m等于一个cpu核心，最少使用0.1个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多使用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制cpu最多使用0.2个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制内存最多使用256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 配置重启策略</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>
<div class="post-img-view">
	<a data-fancybox="gallery" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412242119133.png">
		<img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412242119133.png" alt="image-20240624202529600"  />
	</a>
</div>
</p>
<blockquote>
<p>修改成 exec 的形式</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod相关的元数据，用于描述Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-demo</span><span class="w"> </span><span class="c"># Pod的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义Pod的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">myFirstApp</span><span class="w"> </span><span class="c"># 以下全部都是自定义标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望Pod根据这里的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于Pod中容器的描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 指定镜像的拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 应用启动探针配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># httpGet: # 探测方式，基于http请求探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   path: /index.html # http请求路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80 # http请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># tcpSocket:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;sleep 5;echo &#39;successful&#39; &gt; /inited;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 失败重试多少次后，真正失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 多少次成功后，真正成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 请求的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时，执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 指定工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 容器内暴露的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于什么协议进行通讯的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 1000m等于一个cpu核心，最少使用0.1个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多使用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制cpu最多使用0.2个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制内存最多使用256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 配置重启策略</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看发现重试过4次，说明失败了</span>
</span></span><span class="line"><span class="cl">kubectl get po
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 寻找失败原因</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 发现是命令有问题，实际执行的命令sh c sleep 5;echo &#39;successful&#39; &gt; /inited;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 期待执行的命令sh -c sleep 5;echo &#39;successful&#39; &gt; /inited;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 修改代码 【- c】 -&gt; 【- -c】</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提示Startup probe failed: command &#34;sh -c sleep 5;echo &#39;successful&#39; &gt; /inited;&#34; timed out</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 因为睡眠5s，而配置的超时时间也是5s，我们继续讲睡眠时间改短点</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -it表示交互模式</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -c指定容器为nginx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --后面的命令是执行的shell指令</span>
</span></span><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it nginx-demo -c nginx -- cat /inited
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>复制一个<code>nginx-liveness-demo.yaml</code>文件</p>
</blockquote>
<h5 id="livenessprobe">LivenessProbe
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod相关的元数据，用于描述Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-liveness-demo</span><span class="w"> </span><span class="c"># Pod的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义Pod的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">myFirstApp</span><span class="w"> </span><span class="c"># 以下全部都是自定义标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望Pod根据这里的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于Pod中容器的描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 指定镜像的拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 应用启动探针配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># httpGet: # 探测方式，基于http请求探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   path: /index.html # http请求路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80 # http请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># tcpSocket:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;sleep 2;echo &#39;successful&#39; &gt; /inited;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 失败重试多少次后，真正失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 多少次成功后，真正成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 请求的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 应用存活探针配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">httpGet</span><span class="p">:</span><span class="w"> </span><span class="c"># 探测方式，基于http请求探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/index1.html</span><span class="w"> </span><span class="c"># http请求路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># http请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># tcpSocket:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># exec:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   command:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - -c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - &#34;sleep 2;echo &#39;successful&#39; &gt; /inited;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 失败重试多少次后，真正失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 多少次成功后，真正成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 请求的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时，执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 指定工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 容器内暴露的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于什么协议进行通讯的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 1000m等于一个cpu核心，最少使用0.1个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多使用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制cpu最多使用0.2个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制内存最多使用256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 配置重启策略</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 请求/index1.html失败，在重试5次后，依然无法启动</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  Warning  Unhealthy  17s (x9 over 117s)   kubelet            Liveness probe failed: HTTP probe failed with statuscode: 404</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  Normal   Killing    17s (x3 over 97s)    kubelet            Container nginx failed liveness probe, will be restarted</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;success&#39;</span> &gt; index1.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 拷贝到文件内部</span>
</span></span><span class="line"><span class="cl">kubectl cp index1.html nginx-liveness-demo:/usr/share/nginx/html
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>当三种探针同时存在时，必定先运行<code>startup</code>，之后才是<code>LivenessProbe</code>和<code>ReadinessProbe</code></p>
</blockquote>
<h5 id="readinessprobe">ReadinessProbe
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod相关的元数据，用于描述Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-liveness-demo</span><span class="w"> </span><span class="c"># Pod的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义Pod的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">myFirstApp</span><span class="w"> </span><span class="c"># 以下全部都是自定义标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望Pod根据这里的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于Pod中容器的描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 指定镜像的拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 应用启动探针配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># httpGet: # 探测方式，基于http请求探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   path: /index.html # http请求路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80 # http请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># tcpSocket:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;sleep 2;echo &#39;successful&#39; &gt; /inited;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 失败重试多少次后，真正失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 多少次成功后，真正成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 请求的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 应用存活探针配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">httpGet</span><span class="p">:</span><span class="w"> </span><span class="c"># 探测方式，基于http请求探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/index.html</span><span class="w"> </span><span class="c"># http请求路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># http请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># tcpSocket:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># exec:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   command:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - -c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - &#34;sleep 2;echo &#39;successful&#39; &gt; /inited;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 失败重试多少次后，真正失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 多少次成功后，真正成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 请求的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 应用存活探针配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">httpGet</span><span class="p">:</span><span class="w"> </span><span class="c"># 探测方式，基于http请求探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/index1.html</span><span class="w"> </span><span class="c"># http请求路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># http请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># tcpSocket:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   port: 80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># exec:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   command:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - -c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#   - &#34;sleep 2;echo &#39;successful&#39; &gt; /inited;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 失败重试多少次后，真正失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 多少次成功后，真正成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 请求的超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时，执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 指定工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 容器内暴露的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于什么协议进行通讯的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 1000m等于一个cpu核心，最少使用0.1个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多使用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制cpu最多使用0.2个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制内存最多使用256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 配置重启策略</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 404</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  Warning  Unhealthy  1s    kubelet            Readiness probe failed: HTTP probe failed with statuscode: 404</span>
</span></span><span class="line"><span class="cl">kubectl cp index1.html nginx-liveness-demo:/usr/share/nginx/html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># node状态转为ready</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
<div class="post-img-view">
	<a data-fancybox="gallery" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412242119552.png">
		<img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412242119552.png" alt="image-20240624205645684"  />
	</a>
</div>
</p>
<h5 id="类型-1">类型
</h5><ol>
<li>
<p>StartupProbe</p>
<p>k8s 1.16 版本新增的探针，用于判断应用程序是否已经启动了。</p>
<p>当配置了 startupProbe 后，会先禁用其他探针，直到 startupProbe 成功后，其他探针才会继续。</p>
<p>作用：由于有时候不能准确预估应用一定是多长时间启动成功，因此配置另外两种方式不方便配置初始化时长来检测，而配置了 statupProbe 后，只有在应用启动成功了，才会执行另外两种探针，可以更加方便的结合使用另外两种探针使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">startupProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/api/startup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>LivenessProbe</p>
<p>用于探测容器中的应用是否运行，如果探测失败，kubelet 会根据配置的重启策略进行重启，若没有配置，默认就认为容器启动成功，不会执行重启策略。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/health</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ReadinessProbe</p>
<p>用于探测容器内的程序是否健康，它的返回值如果返回 success，那么就认为该容器已经完全启动，并且该容器是可以接收外部流量的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 错误次数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8181</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h5 id="探测方式">探测方式
</h5><ol>
<li>
<p>ExecAction</p>
<p>在容器内部执行一个命令，如果返回值为 0，则任务容器时健康的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">\- cat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">\- /health</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>TCPSocketAction</p>
<p>通过 tcp 连接监测容器内端口是否开放，如果开放则证明该容器健康</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tcpSocket</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>HTTPGetAction</p>
<p>生产环境用的较多的方式，发送 HTTP 请求到容器内的应用程序，如果接口返回的状态码在 200~400 之间，则认为容器健康。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/health</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">httpHeaders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">\- name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h5 id="参数配置">参数配置
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="c"># 初始化时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 监测间隔时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 检查 1 次成功就表示成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 监测失败 2 次就表示失败</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="生命周期">生命周期
</h4><p>
<div class="post-img-view">
	<a data-fancybox="gallery" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222125032.png">
		<img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222125032.png" alt="image-20241215130746124"  />
	</a>
</div>
</p>
<blockquote>
<p>修改 nginx-demo.yaml</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod相关的元数据，用于描述Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-demo</span><span class="w"> </span><span class="c"># Pod的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义Pod的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">myFirstApp</span><span class="w"> </span><span class="c"># 以下全部都是自定义标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望Pod根据这里的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于Pod中容器的描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 指定镜像的拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w"> </span><span class="c"># 生命周期的配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">postStart</span><span class="p">:</span><span class="w"> </span><span class="c"># 生命周期启动阶段做的事情，但是不一定在容器command之前运行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="s2">&#34;echo &#39;this is postStart&#39; &gt; /usr/share/nginx/html/lifecycle.html&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="s2">&#34;sleep 50;echo &#39;this is preStop&#39; &gt;&gt; /usr/share/nginx/html/lifecycle.html&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时，执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 指定工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 容器内暴露的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于什么协议进行通讯的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 1000m等于一个cpu核心，最少使用0.1个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多使用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制cpu最多使用0.2个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制内存最多使用256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 配置重启策略</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 注意preStop处的命令，有一个sleep 50</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 获取详细信息(ip地址)</span>
</span></span><span class="line"><span class="cl">kubectl get po -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl 10.244.36.70:80/lifecycle.html
</span></span><span class="line"><span class="cl"><span class="c1"># this is postStart</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再开一个窗口，持续监听po状态 kubectl get po -w</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -w 代表持续监听pod状态</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 删除pod并查看删除的时间</span>
</span></span><span class="line"><span class="cl"><span class="c1"># time代表打印执行命令消耗的时间</span>
</span></span><span class="line"><span class="cl"><span class="nb">time</span> kubectl delete po pod_name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 此时发现并没有在50s时删除(因为我们`preStop`里定义的是sleep时间是50s)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 是因为存在一个删除默认时间配置，默认是`30s`(terminationGracePeriodSeconds)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 打印结果如下</span>
</span></span><span class="line"><span class="cl">NAME         READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-demo   1/1     Running   <span class="m">0</span>          14s
</span></span><span class="line"><span class="cl">nginx-demo   1/1     Terminating   <span class="m">0</span>          15s
</span></span><span class="line"><span class="cl">nginx-demo   1/1     Terminating   <span class="m">0</span>          45s
</span></span><span class="line"><span class="cl">nginx-demo   0/1     Terminating   <span class="m">0</span>          45s
</span></span><span class="line"><span class="cl">nginx-demo   0/1     Terminating   <span class="m">0</span>          45s
</span></span><span class="line"><span class="cl">nginx-demo   0/1     Terminating   <span class="m">0</span>          45s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 从第一个Terminating到最后，消耗了30s，并不是50s</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 因为k8s 默认给 pod 的停止宽限时间为 30s，配置参数为terminationGracePeriodSeconds: 30</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
<div class="post-img-view">
	<a data-fancybox="gallery" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222125697.png">
		<img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222125697.png" alt="image-20241215171021871"  />
	</a>
</div>
</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># api文档版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w"> </span><span class="c"># 资源对象类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># Pod相关的元数据，用于描述Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-po</span><span class="w"> </span><span class="c"># Pod的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义Pod的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">myFirstApp</span><span class="w"> </span><span class="c"># 以下全部都是自定义标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望Pod根据这里的描述进行创建</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="c"># 当pod被删除时，给这个pod宽限多长时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># 对于Pod中容器的描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 指定容器的镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 指定镜像的拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w"> </span><span class="c"># 生命周期的配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">postStart</span><span class="p">:</span><span class="w"> </span><span class="c"># 生命周期启动阶段做的事，不一定在command之前执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="s2">&#34;echo &#39;hello&#39; &gt; /usr/share/nginx/html/prestop.html&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="s2">&#34;sleep 50;echo &#39;sleep..&#39; &gt;&gt; /usr/share/nginx/html/prestop.html&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定容器启动时，执行的命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">g</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;daemon off;&#39;</span><span class="w"> </span><span class="c"># nginx -g &#39;daemon off;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w"> </span><span class="c"># 指定工作目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w"> </span><span class="c"># 端口名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># 容器内暴露的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w"> </span><span class="c"># 描述该端口是基于什么协议进行通讯的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 环境变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JVM_OPTS</span><span class="w"> </span><span class="c"># 环境变量名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms128m -Xmx128m&#39;</span><span class="w"> </span><span class="c"># 环境变量值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 最少需要多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w"> </span><span class="c"># 1000m等于一个cpu核心，最少使用0.1个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w"> </span><span class="c"># 限制内存最少使用128兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 最多使用多少资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w"> </span><span class="c"># 限制cpu最多使用0.2个核心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w"> </span><span class="c"># 限制内存最多使用256兆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w"> </span><span class="c"># 配置重启策略</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>发现这次就是<code>50s</code>了</p>
<h5 id="pod-退出流程">Pod 退出流程
</h5><h6 id="删除操作">删除操作
</h6><ol>
<li>
<p>Endpoint 删除 pod 的 ip 地址</p>
</li>
<li>
<p>Pod 变成 Terminating 状态</p>
<p>变为删除中的状态后，会给 pod 一个宽限期，让 pod 去执行一些清理或销毁操作。</p>
<p>配置参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 作用与 pod 中的所有容器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="l">\- xxx</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>执行 preStop 的指令</p>
</li>
</ol>
<h5 id="prestop-的应用">PreStop 的应用
</h5><p>如果应用销毁操作耗时需要比较长，可以在 preStop 按照如下方式进行配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">\- sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">\- -c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">\- &#39;sleep 20; kill pgrep java&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但是需要注意，由于 k8s 默认给 pod 的停止宽限时间为 30s，如果我们停止操作会超过 30s 时，不要光设置 sleep 50，还要将 terminationGracePeriodSeconds: 30 也更新成更长的时间，否则 k8s 最多只会在这个时间的基础上再宽限几秒，不会真正等待 50s</p>
<ol>
<li>注册中心下线</li>
<li>数据清理</li>
<li>数据销毁</li>
</ol>
<h3 id="资源调度">资源调度
</h3><h4 id="label-和-selector">Label 和 Selector
</h4><h5 id="标签label">标签（Label）
</h5><p><code>deploy</code>和<code>rs</code>之间的绑定关系，如果采用 mysql 表中<code>一对多</code>或<code>多对多</code>就会形成<code>强绑定</code>关系，k8s 并没有采用这种方式</p>
<h6 id="配置文件">配置文件
</h6><p>在各类资源的 metadata.labels 中进行配置</p>
<h6 id="kubectl">kubectl
</h6><ol>
<li>
<p>临时创建 label</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl label po &lt;资源名称&gt; <span class="nv">app</span><span class="o">=</span>hello
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 指定命名空间</span>
</span></span><span class="line"><span class="cl">kubectl label po &lt;资源名称&gt; <span class="nv">app</span><span class="o">=</span>hello -n kube-public
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>修改已经存在的标签</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl label po &lt;资源名称&gt; <span class="nv">app</span><span class="o">=</span>hello2 --overwrite
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>查看 label</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># selector 按照 label 单值查找节点</span>
</span></span><span class="line"><span class="cl">kubectl get po -A -l <span class="nv">app</span><span class="o">=</span>hello
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看所有节点的 labels</span>
</span></span><span class="line"><span class="cl">kubectl get po --show-labels
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>修改配置文件的形式修改 lable</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl edit po nginx-demo
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>如果希望给<code>deploy</code>打上标签有两种方式</p>
<ol>
<li>修改对应的 yaml 配置文件(spec.meta.data.labels)</li>
<li>使用命令打标签
<ol>
<li>创建临时 label(kubectl label po pod_name app=hello)</li>
<li>修改已经存在的 label(kubectl label po pod_name app=hello1 &ndash;overwrite)</li>
<li>查看 label(kubectl get po [pod_name] &ndash;show-labels)</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl create -f nginx-po.yaml</span>
</span></span><span class="line"><span class="cl">pod/nginx-po created
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-po   1/1     Running   <span class="m">0</span>          2m5s
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po --show-labels</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span class="line"><span class="cl">nginx-po   1/1     Running   <span class="m">0</span>          2m32s   <span class="nv">type</span><span class="o">=</span>myFirstApp,version<span class="o">=</span>0.0.1
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po nginx-po --show-labels</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span class="line"><span class="cl">nginx-po   1/1     Running   <span class="m">0</span>          2m40s   <span class="nv">type</span><span class="o">=</span>myFirstApp,version<span class="o">=</span>0.0.1
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1">#</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
<div class="post-img-view">
	<a data-fancybox="gallery" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222125573.png">
		<img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222125573.png" alt="image-20241215192454549"  />
	</a>
</div>
</p>
<p>能查看到标签是因为在原来的 yaml 里我们已经配置了一部分 label</p>
<blockquote>
<p>除此之外，如果希望在已经存在的 po 上<code>新建/修改</code>label 可以使用如下命令</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po nginx-po --show-labels</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">nginx-po   1/1     Running   <span class="m">0</span>          17m   <span class="nv">type</span><span class="o">=</span>app1,version<span class="o">=</span>0.0.1
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl edit po nginx-po</span>
</span></span><span class="line"><span class="cl">pod/nginx-po edited
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po nginx-po --show-labels</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">nginx-po   1/1     Running   <span class="m">0</span>          25m   <span class="nv">type</span><span class="o">=</span>app2,version<span class="o">=</span>0.0.1
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="选择器selector">选择器（Selector）
</h5><blockquote>
<p>在各对象的配置 spec.selector 或其他可以写 selector 的属性中编写</p>
</blockquote>
<h6 id="配置文件-1">配置文件
</h6><p>在各对象的配置 spec.selector 或其他可以写 selector 的属性中编写</p>
<h6 id="kubectl-1">kubectl
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># -l表示根据label进行匹配,匹配单个值，查找 =app2 的 pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po -l type=app2</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-po   1/1     Running   <span class="m">0</span>          27m
</span></span><span class="line"><span class="cl"><span class="c1"># -A显示命名空间</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po -A -l type=app2</span>
</span></span><span class="line"><span class="cl">NAMESPACE   NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">default     nginx-po   1/1     Running   <span class="m">0</span>          29m
</span></span><span class="line"><span class="cl"><span class="c1"># 同时使用--show-labels</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po -A -l type=app2 --show-labels</span>
</span></span><span class="line"><span class="cl">NAMESPACE   NAME       READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">default     nginx-po   1/1     Running   <span class="m">0</span>          85m   <span class="nv">type</span><span class="o">=</span>app2,version<span class="o">=</span>0.0.1
</span></span><span class="line"><span class="cl"><span class="c1"># in</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po -l &#39;version in (0.0.1, 0,0.2, 0.0.3)&#39;</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-po   1/1     Running   <span class="m">0</span>          88m
</span></span><span class="line"><span class="cl"><span class="c1"># 同时匹配多个label</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master pods<span class="o">]</span><span class="c1"># kubectl get po -l version!=0.0.2,type=app2</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-po   1/1     Running   <span class="m">0</span>          89m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查找 version!=1 and app=nginx 的 pod 信息</span>
</span></span><span class="line"><span class="cl">kubectl get po -l version!<span class="o">=</span>1,app<span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 不等值 + 语句</span>
</span></span><span class="line"><span class="cl">kubectl get po -A -l version!<span class="o">=</span>1,<span class="s1">&#39;app in (busybox, nginx)&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="deployment">Deployment
</h4><h5 id="功能">功能
</h5><h6 id="创建">创建
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl delete po nginx-po
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ../
</span></span><span class="line"><span class="cl">mkdir deployments
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> deployments
</span></span><span class="line"><span class="cl"><span class="c1"># 创建deploy</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># kubectl create deploy nginx-deploy --image=nginx:latest</span>
</span></span><span class="line"><span class="cl">deployment.apps/nginx-deploy created
</span></span><span class="line"><span class="cl"><span class="c1"># 或执行 kubectl create -f xxx.yaml --record</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --record 会在 annotation 中记录当前命令创建或升级了资源，后续可以查看做过哪些变动操作。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看状态</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># kubectl get deploy</span>
</span></span><span class="line"><span class="cl">NAME           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">nginx-deploy   1/1     <span class="m">1</span>            <span class="m">1</span>           72s
</span></span><span class="line"><span class="cl"><span class="c1"># 如果没有ready，查看下pod，看看对应pod是否启动成功</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># kubectl get po</span>
</span></span><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-deploy-65bdccd7c7-rj8xw   1/1     Running   <span class="m">0</span>          70s
</span></span><span class="line"><span class="cl"><span class="c1"># 查看rs</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># kubectl get replicaset</span>
</span></span><span class="line"><span class="cl">NAME                      DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">nginx-deploy-65bdccd7c7   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>       4m56s
</span></span><span class="line"><span class="cl"><span class="c1"># 也可以使用缩写</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># kubectl get rs</span>
</span></span><span class="line"><span class="cl">NAME                      DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">nginx-deploy-65bdccd7c7   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>       5m19s
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 pod 以及展示标签，可以看到是关联的那个 rs</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># kubectl get pods --show-labels</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>仔细观察你可能会发现如下特点，他们的名字逐步增加了 id</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># deploy</span>
</span></span><span class="line"><span class="cl">nginx-deploy
</span></span><span class="line"><span class="cl"><span class="c1"># replicset</span>
</span></span><span class="line"><span class="cl">nginx-deploy-65bdccd7c7
</span></span><span class="line"><span class="cl"><span class="c1"># pod</span>
</span></span><span class="line"><span class="cl">nginx-deploy-65bdccd7c7-rj8xw
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>如果希望自己通过配置文件来创建 deploy，而不是直接通过镜像来创建</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># kubectl get deploy</span>
</span></span><span class="line"><span class="cl">NAME           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">nginx-deploy   1/1     <span class="m">1</span>            <span class="m">1</span>           8m6s
</span></span><span class="line"><span class="cl"><span class="c1"># 以yaml格式输出`nginx-deploy`的配置</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># kubectl get deploy nginx-deploy -o yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">piVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 期望的副本数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 进行滚动更新后，保留的历史版本数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w"> </span><span class="c"># 按照标签匹配rs、po</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w"> </span><span class="c"># 进行滚动更新时，更新个数最多可以超过期望副本数的个数/比例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w"> </span><span class="c"># 更新时，最大不可用更新比例，表示所有副本中，有多少个/比例更新不成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># pod模板</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 元信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>deploy</code>、<code>rs</code>、<code>pod</code>通过<code>app=nginx-deploy</code>的**<code>label</code>**进行关联</p>
<blockquote>
<p>修改已经创建好的 deploy</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl edit deploy nginx-deploy
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="滚动更新">滚动更新
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 只有修改了 deployment 配置文件中的 template 中的属性后，才会触发更新操作</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改 nginx 版本号</span>
</span></span><span class="line"><span class="cl">kubectl <span class="nb">set</span> image deployment/nginx-deployment <span class="nv">nginx</span><span class="o">=</span>nginx:1.9.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 或者通过 kubectl edit deployment/nginx-deployment 进行修改</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看滚动更新的过程</span>
</span></span><span class="line"><span class="cl">kubectl rollout status deploy &lt;deployment_name&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看部署描述，最后展示发生的事件列表也可以看到滚动更新过程</span>
</span></span><span class="line"><span class="cl">kubectl describe deploy &lt;deployment_name&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过 kubectl get deployments 获取部署信息，UP-TO-DATE 表示已经有多少副本达到了配置中要求的数目</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过 kubectl get rs 可以看到增加了一个新的 rs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过 kubectl get pods 可以看到所有 pod 关联的 rs 变成了新的</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>还可以通过修改 yaml 的<code>replicas</code>来增加副本数</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">deployment.kubernetes.io/revision</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-12-15T13:37:52Z&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;123&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;110810&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">55fcd95d-2217-4c6e-91c4-e112e88edb2e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 副本数</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get deploy</span>
</span></span><span class="line"><span class="cl">NAME           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">nginx-deploy   3/3     <span class="m">3</span>            <span class="m">3</span>           23h
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>在修改 template 的时候就会触发滚动更新</p>
<p>比如这里 nginx 的版本是<code>latest</code>，修改 image 的版本就会触发滚动更新</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/termination-log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l">File</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterFirst</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l">default-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>查看滚动更新的过程
<code>kubectl rollout status deploy &lt;deployment_name&gt;</code></p>
<p>查看部署描述，最后展示发生的事件列表也可以看到滚动更新过程
<code>kubectl describe deploy &lt;deployment_name&gt;</code></p>
<p>通过 kubectl get deployments 获取部署信息，UP-TO-DATE 表示已经有多少副本达到了配置中要求的数目</p>
<p>通过 kubectl get rs 可以看到增加了一个新的 rs</p>
<p>通过 kubectl get pods 可以看到所有 pod 关联的 rs 变成了新的</p>
<blockquote>
<p>假设当前有 5 个 nginx:1.7.9 版本，你想将版本更新为 1.9.1，当更新成功第三个以后，你马上又将期望更新的版本改为 1.9.2，那么此时会立马删除之前的三个，并且立马开启更新 1.9.2 的任务(k8s 判断之前的更新没有意义，所以会从初始版本开始更新，忽略掉上一次没有意义的更新)</p>
<p>如下，我将 image 版本从<code>latest</code>更新为<code>1.7.9</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get deploy</span>
</span></span><span class="line"><span class="cl">NAME           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">nginx-deploy   3/3     <span class="m">3</span>            <span class="m">3</span>           23h
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl describe deploy nginx-deploy</span>
</span></span><span class="line"><span class="cl">Name:                   nginx-deploy
</span></span><span class="line"><span class="cl">Namespace:              default
</span></span><span class="line"><span class="cl">CreationTimestamp:      Sun, <span class="m">15</span> Dec <span class="m">2024</span> 21:37:52 +0800
</span></span><span class="line"><span class="cl">Labels:                 <span class="nv">app</span><span class="o">=</span>nginx-deploy
</span></span><span class="line"><span class="cl">                        <span class="nv">test</span><span class="o">=</span><span class="m">123</span>
</span></span><span class="line"><span class="cl">Annotations:            deployment.kubernetes.io/revision: <span class="m">2</span>
</span></span><span class="line"><span class="cl">Selector:               <span class="nv">app</span><span class="o">=</span>nginx-deploy
</span></span><span class="line"><span class="cl">Replicas:               <span class="m">3</span> desired <span class="p">|</span> <span class="m">3</span> updated <span class="p">|</span> <span class="m">3</span> total <span class="p">|</span> <span class="m">3</span> available <span class="p">|</span> <span class="m">0</span> unavailable
</span></span><span class="line"><span class="cl">StrategyType:           RollingUpdate
</span></span><span class="line"><span class="cl">MinReadySeconds:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">RollingUpdateStrategy:  25% max unavailable, 25% max surge
</span></span><span class="line"><span class="cl">Pod Template:
</span></span><span class="line"><span class="cl">  Labels:  <span class="nv">app</span><span class="o">=</span>nginx-deploy
</span></span><span class="line"><span class="cl">  Containers:
</span></span><span class="line"><span class="cl">   nginx:
</span></span><span class="line"><span class="cl">    Image:        nginx:1.7.9
</span></span><span class="line"><span class="cl">    Port:         &lt;none&gt;
</span></span><span class="line"><span class="cl">    Host Port:    &lt;none&gt;
</span></span><span class="line"><span class="cl">    Environment:  &lt;none&gt;
</span></span><span class="line"><span class="cl">    Mounts:       &lt;none&gt;
</span></span><span class="line"><span class="cl">  Volumes:        &lt;none&gt;
</span></span><span class="line"><span class="cl">Conditions:
</span></span><span class="line"><span class="cl">  Type           Status  Reason
</span></span><span class="line"><span class="cl">  ----           ------  ------
</span></span><span class="line"><span class="cl">  Available      True    MinimumReplicasAvailable
</span></span><span class="line"><span class="cl">  Progressing    True    NewReplicaSetAvailable
</span></span><span class="line"><span class="cl">OldReplicaSets:  &lt;none&gt;
</span></span><span class="line"><span class="cl">NewReplicaSet:   nginx-deploy-65976b546f <span class="o">(</span>3/3 replicas created<span class="o">)</span>
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason             Age    From                   Message
</span></span><span class="line"><span class="cl">  ----    ------             ----   ----                   -------
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  23h    deployment-controller  Scaled up replica <span class="nb">set</span> nginx-deploy-65bdccd7c7 to <span class="m">1</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  20m    deployment-controller  Scaled up replica <span class="nb">set</span> nginx-deploy-65bdccd7c7 to <span class="m">3</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  18m    deployment-controller  Scaled down replica <span class="nb">set</span> nginx-deploy-65bdccd7c7 to <span class="m">1</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  12m    deployment-controller  Scaled up replica <span class="nb">set</span> nginx-deploy-65bdccd7c7 to <span class="m">3</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  2m16s  deployment-controller  Scaled up replica <span class="nb">set</span> nginx-deploy-65976b546f to <span class="m">1</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  115s   deployment-controller  Scaled down replica <span class="nb">set</span> nginx-deploy-65bdccd7c7 to <span class="m">2</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  115s   deployment-controller  Scaled up replica <span class="nb">set</span> nginx-deploy-65976b546f to <span class="m">2</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  94s    deployment-controller  Scaled down replica <span class="nb">set</span> nginx-deploy-65bdccd7c7 to <span class="m">1</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  94s    deployment-controller  Scaled up replica <span class="nb">set</span> nginx-deploy-65976b546f to <span class="m">3</span>
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  73s    deployment-controller  Scaled down replica <span class="nb">set</span> nginx-deploy-65bdccd7c7 to <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="多个滚动更新并行">多个滚动更新并行
</h6><p>假设当前有 5 个 nginx:1.7.9 版本，你想将版本更新为 1.9.1，当更新成功第三个以后，你马上又将期望更新的版本改为 1.9.2，那么此时会立马删除之前的三个，并且立马开启更新 1.9.2 的任务</p>
<h6 id="回滚">回滚
</h6><p>有时候你可能想回退一个 Deployment，例如，当 Deployment 不稳定时，比如一直 crash looping。</p>
<p>默认情况下，kubernetes 会在系统中保存前两次的 Deployment 的 rollout 历史记录，以便你可以随时会退（你可以修改 revision history limit 来更改保存的 revision 数）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 案例：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 更新 deployment 时参数不小心写错，如 nginx:1.9.1 写成了 nginx:1.91</span>
</span></span><span class="line"><span class="cl">kubectl <span class="nb">set</span> image deployment/nginx-deploy <span class="nv">nginx</span><span class="o">=</span>nginx:1.91
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 监控滚动升级状态，由于镜像名称错误，下载镜像失败，因此更新过程会卡住</span>
</span></span><span class="line"><span class="cl">kubectl rollout status deployments nginx-deploy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 结束监听后，获取 rs 信息，我们可以看到新增的 rs 副本数是 2 个</span>
</span></span><span class="line"><span class="cl">kubectl get rs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过 kubectl get pods 获取 pods 信息，我们可以看到关联到新的 rs 的 pod，状态处于 ImagePullBackOff 状态</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为了修复这个问题，我们需要找到需要回退的 revision 进行回退</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 通过 以下命令 可以获取 revison 的列表</span>
</span></span><span class="line"><span class="cl">kubectl rollout <span class="nb">history</span> deployment/nginx-deploy
</span></span><span class="line"><span class="cl"><span class="c1"># deployment.apps/nginx-deploy</span>
</span></span><span class="line"><span class="cl"><span class="c1"># REVISION  CHANGE-CAUSE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1         &lt;none&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2         &lt;none&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这里是none的原因是因为更新的时候没有写明原因，比如</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubectl set image deployment/nginx-deploy nginx=nginx:1.7.9 --record</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 回退到上一个版本，即1，先查看一下该版本的信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过 以下命令 可以查看指定版本的详细信息</span>
</span></span><span class="line"><span class="cl">kubectl rollout <span class="nb">history</span> deployment/nginx-deploy --revision<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 确认要回退的版本后，可以通过 以下命令 可以回退到上一个版本</span>
</span></span><span class="line"><span class="cl">kubectl rollout undo deployment/nginx-deploy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 也可以回退到指定的 revision</span>
</span></span><span class="line"><span class="cl">kubectl rollout undo deployment/nginx-deploy --to-revision<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次通过 以下命令 可以看到，我们的版本已经回退到对应的 revison 上了</span>
</span></span><span class="line"><span class="cl">kubectl get deployment
</span></span><span class="line"><span class="cl">kubectl describe deployment
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 我们可以回退版本是因为在yaml里设置了`revisionHistoryLimit`</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可以通过设置 .spec.revisonHistoryLimit 来指定 deployment 保留多少 revison，如果设置为 0，则不允许 deployment 回退了。</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="扩容缩容">扩容缩容
</h6><p>通过 kube scale 命令可以进行自动扩容/缩容，以及通过 kube edit 编辑 replcas 也可以实现扩容/缩容</p>
<p>扩容与缩容只是直接创建副本数，没有更新 pod template 因此不会创建新的 rs</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl scale --replicas<span class="o">=</span><span class="m">6</span> deployment nginx-deploy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看帮助文档</span>
</span></span><span class="line"><span class="cl">kubectl scale --help
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="暂停与恢复">暂停与恢复
</h6><p>由于每次对 pod template 中的信息发生修改后，都会触发更新 deployment 操作，那么此时如果频繁修改信息，就会产生多次更新，而实际上只需要执行最后一次更新即可，当出现此类情况时我们就可以暂停 deployment 的 rollout</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 通过 kubectl rollout pause deployment &lt;name&gt; 就可以实现暂停，直到你下次恢复后才会继续进行滚动更新</span>
</span></span><span class="line"><span class="cl">kubectl rollout pause deployment nginx-deploy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 尝试对容器进行修改，然后查看是否发生更新操作了</span>
</span></span><span class="line"><span class="cl">kubectl <span class="nb">set</span> image deploy &lt;name&gt; <span class="nv">nginx</span><span class="o">=</span>nginx:1.17.9
</span></span><span class="line"><span class="cl">kubectl get po
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过以上操作可以看到实际并没有发生修改，此时我们再次进行修改一些属性，如限制 nginx 容器的最大 cpu 为 0.2 核，最大内存为 128M，最小内存为 64M，最小 cpu 为 0.1 核</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl <span class="nb">set</span> resources deploy &lt;deploy_name&gt; -c &lt;container_name&gt; --limits<span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>200m,memory<span class="o">=</span>128Mi --requests<span class="o">=</span>cpu100m,memory<span class="o">=</span>64Mi
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过格式化输出 kubectl get deploy &lt;name&gt; -oyaml，可以看到配置确实发生了修改，再通过 kubectl get po 可以看到 pod 没有被更新</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 那么此时我们再恢复 rollout，通过命令 kubectl rollout resume deploy &lt;name&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl rollout resume deploy nginx-deploy
</span></span><span class="line"><span class="cl"><span class="c1"># 恢复后，我们再次查看 rs 和 po 信息，我们可以看到就开始进行滚动更新操作了</span>
</span></span><span class="line"><span class="cl">kubectl get rs
</span></span><span class="line"><span class="cl">kubectl get po
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 暂停</span>
</span></span><span class="line"><span class="cl">kubectl rollout pause deploy &lt;name&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 恢复</span>
</span></span><span class="line"><span class="cl">kubectl rollout resume deploy &lt;name&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="配置文件-2">配置文件
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w"> </span><span class="c"># deployment api 版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w"> </span><span class="c"># 资源类型为 deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># 标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app: nginx-deploy # 具体的 key</span><span class="p">:</span><span class="w"> </span><span class="l">value 配置形式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w"> </span><span class="c"># deployment 的名字</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w"> </span><span class="c"># 所在的命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 期望副本数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 进行滚动更新后，保留的历史版本数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，用于找到匹配的 RS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c"># 按照标签匹配</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w"> </span><span class="c"># 匹配的标签key/value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w"> </span><span class="c"># 滚动更新配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w"> </span><span class="c"># 进行滚动更新时，更新的个数最多可以超过期望副本数的个数/比例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w"> </span><span class="c"># 进行滚动更新时，最大不可用比例更新比例，表示在所有副本数中，最多可以有多少个不更新成功</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 更新类型，采用滚动更新</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># pod 模板</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># pod 的元信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c"># pod 的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># pod 期望信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c"># pod 的容器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w"> </span><span class="c"># 镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w"> </span><span class="c"># 拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w"> </span><span class="c"># 容器名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w"> </span><span class="c"># 重启策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="c"># 删除操作最多宽限多长时间</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="statefulset-1">StatefulSet
</h4><blockquote>
<p>以上是关于无状态应用的内容，增加删除简单执行命令即可
但是有状态应用却不一样，可能会依赖本地的文件、网络</p>
</blockquote>
<h5 id="功能-1">功能
</h5><h6 id="创建-1">创建
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create -f web.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 service 和 statefulset =&gt; sts</span>
</span></span><span class="line"><span class="cl">kubectl get service nginx
</span></span><span class="line"><span class="cl">kubectl get statefulset web
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看service(简写)</span>
</span></span><span class="line"><span class="cl">kubectl get svc
</span></span><span class="line"><span class="cl"><span class="c1"># 查看statefulset(简写)</span>
</span></span><span class="line"><span class="cl">kubectl get sts
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 PVC 信息</span>
</span></span><span class="line"><span class="cl">kubectl get pvc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看创建的 pod，这些 pod 是有序的</span>
</span></span><span class="line"><span class="cl">kubectl get pods -l <span class="nv">app</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看这些 pod 的 dns</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 运行一个 pod，基础镜像为 busybox 工具包，利用里面的 nslookup 可以看到 dns 信息</span>
</span></span><span class="line"><span class="cl">kubectl run -i --tty --image busybox dns-test --restart<span class="o">=</span>Never --rm /bin/sh
</span></span><span class="line"><span class="cl">nslookup web-0.nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建sts</span>
</span></span><span class="line"><span class="cl">kubectl create -f web.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># service/nginx created</span>
</span></span><span class="line"><span class="cl"><span class="c1"># statefulset.apps/web created</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次查看情况</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这里没有绑定ip，所以ip显示none</span>
</span></span><span class="line"><span class="cl">kubectl get svc
</span></span><span class="line"><span class="cl"><span class="c1"># NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   69d</span>
</span></span><span class="line"><span class="cl"><span class="c1"># nginx        ClusterIP   None         &lt;none&gt;        80/TCP    47s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get sts
</span></span><span class="line"><span class="cl"><span class="c1"># NAME   READY   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># web    0/2     51s</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 查看持久卷(数据卷)</span>
</span></span><span class="line"><span class="cl">kubectl get pvc
</span></span><span class="line"><span class="cl"><span class="c1"># NAME        STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># www-web-0   Pending                                                     2m4s</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 查看详细信息，发现有问题</span>
</span></span><span class="line"><span class="cl">kubectl describe pvc www-web-0
</span></span><span class="line"><span class="cl"><span class="c1"># Name:          www-web-0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Namespace:     default</span>
</span></span><span class="line"><span class="cl"><span class="c1"># StorageClass:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Status:        Pending</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Volume:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Labels:        app=nginx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Annotations:   volume.alpha.kubernetes.io/storage-class: anything</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Finalizers:    [kubernetes.io/pvc-protection]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Capacity:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Access Modes:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># VolumeMode:    Filesystem</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Used By:       web-0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Events:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   Type    Reason         Age                  From                         Message</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   ----    ------         ----                 ----                         -------</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   Normal  FailedBinding  8s (x15 over 3m34s)  persistentvolume-controller  no persistent volumes available for this claim and no storage class is set</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 由于没有可用的持久卷而且没有设置存储类，所以sts依旧没有ready</span>
</span></span><span class="line"><span class="cl">kubectl get sts
</span></span><span class="line"><span class="cl"><span class="c1"># NAME   READY   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># web    0/2     4m18s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;nginx&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">www</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeClaimTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">www</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volume.alpha.kubernetes.io/storage-class</span><span class="p">:</span><span class="w"> </span><span class="l">anything</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;ReadWriteOnce&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>由于存储卷的问题，现在修改一下 yaml，暂时不添加存储卷</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;nginx&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 直接替换掉sts的yaml</span>
</span></span><span class="line"><span class="cl">kubectl replace -f web.yaml sts web
</span></span><span class="line"><span class="cl"><span class="c1"># service/nginx replaced</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The StatefulSet &#34;web&#34; is invalid: spec: Forbidden: updates to statefulset spec for fields other than &#39;replicas&#39;, &#39;template&#39;, &#39;updateStrategy&#39;, &#39;persistentVolumeClaimRetentionPolicy&#39; and &#39;minReadySeconds&#39; are forbidden</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 这个提示的原因是有些参数是不能替换的，所以还是删除重建吧</span>
</span></span><span class="line"><span class="cl">kubectl delete sts web
</span></span><span class="line"><span class="cl"><span class="c1"># statefulset.apps &#34;web&#34; deleted</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl delete svc nginx
</span></span><span class="line"><span class="cl"><span class="c1"># service &#34;nginx&#34; deleted</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl delete pvc www-web-0
</span></span><span class="line"><span class="cl"><span class="c1"># persistentvolumeclaim &#34;www-web-0&#34; deleted</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl create -f web.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># service/nginx created</span>
</span></span><span class="line"><span class="cl"><span class="c1"># statefulset.apps/web created</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看信息</span>
</span></span><span class="line"><span class="cl">kubectl get sts
</span></span><span class="line"><span class="cl"><span class="c1"># NAME   READY   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># web    2/2     39s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get svc
</span></span><span class="line"><span class="cl"><span class="c1"># NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   69d</span>
</span></span><span class="line"><span class="cl"><span class="c1"># nginx        ClusterIP   None         &lt;none&gt;        80/TCP    42s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get pvc
</span></span><span class="line"><span class="cl"><span class="c1"># No resources found in default namespace.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看po</span>
</span></span><span class="line"><span class="cl">kubectl get po
</span></span><span class="line"><span class="cl"><span class="c1"># NAME    READY   STATUS    RESTARTS   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># web-0   1/1     Running   0          65s</span>
</span></span><span class="line"><span class="cl"><span class="c1"># web-1   1/1     Running   0          58s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 新建一个po，去ping这两个po，观察是否可以ping通</span>
</span></span><span class="line"><span class="cl"><span class="c1"># busybox是linux里的一个工具镜像</span>
</span></span><span class="line"><span class="cl">kubectl run -it --image busybox:1.28.4 dns-test /bin/sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get po
</span></span><span class="line"><span class="cl"><span class="c1"># NAME       READY   STATUS    RESTARTS   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dns-test   1/1     Running   0          77s</span>
</span></span><span class="line"><span class="cl"><span class="c1"># web-0      1/1     Running   1          13h</span>
</span></span><span class="line"><span class="cl"><span class="c1"># web-1      1/1     Running   1          13h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 我这里执行完命令之后没有自动进入po内部，查看发现已经ready了</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 执行以下命令进入po内部</span>
</span></span><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it dns-test -- /bin/sh
</span></span><span class="line"><span class="cl"><span class="c1">#statefulset中每个pod的dns格式为statefulsetName-{0,1...n}.serviceName.namespace.svc.cluster.local</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># nslookup web-0.nginx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Server:    10.96.0.10</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Name:      web-0.nginx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Address 1: 10.244.36.74 web-0.nginx.default.svc.cluster.local</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="扩容缩容-1">扩容缩容
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 扩容</span>
</span></span><span class="line"><span class="cl">kubectl scale statefulset web --replicas<span class="o">=</span><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 或者如下</span>
</span></span><span class="line"><span class="cl">kubectl patch statefulset web -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;replicas&#34;:5}}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 缩容</span>
</span></span><span class="line"><span class="cl">kubectl patch statefulset web -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;replicas&#34;:3}}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="镜像更新">镜像更新
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 镜像更新（目前不支持直接使用`edit`命令以及参数`-o yaml`来修改yaml里的image，需要 patch 来间接实现）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl patch sts web --type<span class="o">=</span><span class="s1">&#39;json&#39;</span> -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/image&#34;, &#34;value&#34;:&#34;nginx:1.9.1&#34;}]&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用如下</span>
</span></span><span class="line"><span class="cl"><span class="c1"># web是sts的名字，类型是json数据，操作是replace，将/spec/.../image替换成nginx:1.9.1</span>
</span></span><span class="line"><span class="cl">kubectl patch sts web --type<span class="o">=</span><span class="s1">&#39;json&#39;</span> -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/template/spec/containers/0/image&#34;,&#34;value&#34;:&#34;nginx:1.9.1&#34;}]&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c1"># kubectl patch sts web --type=&#39;json&#39; -p=&#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/template/spec/containers/0/image&#34;,&#34;value&#34;:&#34;nginx:1.9.1&#34;}]&#39;</span>
</span></span><span class="line"><span class="cl">statefulset.apps/web patched
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c1"># kubectl get sts</span>
</span></span><span class="line"><span class="cl">NAME   READY   AGE
</span></span><span class="line"><span class="cl">web    1/2     24h
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c1"># kubectl get po</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="cl">dns-test   1/1     Running             <span class="m">0</span>          10h
</span></span><span class="line"><span class="cl">web-0      0/1     ContainerCreating   <span class="m">0</span>          40s
</span></span><span class="line"><span class="cl">web-1      1/1     Running             <span class="m">0</span>          55s
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c1"># kubectl describe po web-0</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  Type    Reason     Age   From               Message
</span></span><span class="line"><span class="cl">  ----    ------     ----  ----               -------
</span></span><span class="line"><span class="cl">  Normal  Scheduled  44s   default-scheduler  Successfully assigned default/web-0 to k8s-node1
</span></span><span class="line"><span class="cl">  Normal  Pulling    43s   kubelet            Pulling image <span class="s2">&#34;nginx:1.9.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 等待pull完成</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c1"># kubectl get po</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">dns-test   1/1     Running   <span class="m">0</span>          10h
</span></span><span class="line"><span class="cl">web-0      1/1     Running   <span class="m">0</span>          2m7s
</span></span><span class="line"><span class="cl">web-1      1/1     Running   <span class="m">0</span>          2m22s
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c1"># kubectl get sts</span>
</span></span><span class="line"><span class="cl">NAME   READY   AGE
</span></span><span class="line"><span class="cl">web    2/2     24h
</span></span><span class="line"><span class="cl"><span class="c1"># 查看历史版本</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可以明显看到镜像从latest更新到1.9.1了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl rollout history sts</span>
</span></span><span class="line"><span class="cl">statefulset.apps/web
</span></span><span class="line"><span class="cl">REVISION  CHANGE-CAUSE
</span></span><span class="line"><span class="cl"><span class="m">1</span>         &lt;none&gt;
</span></span><span class="line"><span class="cl"><span class="m">2</span>         &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl rollout history sts --revision=2</span>
</span></span><span class="line"><span class="cl">statefulset.apps/web with revision <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">Pod Template:
</span></span><span class="line"><span class="cl">  Labels:	<span class="nv">app</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">  Containers:
</span></span><span class="line"><span class="cl">   nginx:
</span></span><span class="line"><span class="cl">    Image:	nginx:1.9.1
</span></span><span class="line"><span class="cl">    Port:	80/TCP
</span></span><span class="line"><span class="cl">    Host Port:	0/TCP
</span></span><span class="line"><span class="cl">    Environment:	&lt;none&gt;
</span></span><span class="line"><span class="cl">    Mounts:	&lt;none&gt;
</span></span><span class="line"><span class="cl">  Volumes:	&lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl rollout history sts --revision=1</span>
</span></span><span class="line"><span class="cl">statefulset.apps/web with revision <span class="c1">#1</span>
</span></span><span class="line"><span class="cl">Pod Template:
</span></span><span class="line"><span class="cl">  Labels:	<span class="nv">app</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">  Containers:
</span></span><span class="line"><span class="cl">   nginx:
</span></span><span class="line"><span class="cl">    Image:	nginx:latest
</span></span><span class="line"><span class="cl">    Port:	80/TCP
</span></span><span class="line"><span class="cl">    Host Port:	0/TCP
</span></span><span class="line"><span class="cl">    Environment:	&lt;none&gt;
</span></span><span class="line"><span class="cl">    Mounts:	&lt;none&gt;
</span></span><span class="line"><span class="cl">  Volumes:	&lt;none&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 查看sts内容，先删除web-1，再创建web-1，web-0也是如此</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl describe sts web</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  Type    Reason            Age                  From                    Message
</span></span><span class="line"><span class="cl">  ----    ------            ----                 ----                    -------
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreate  9h                   statefulset-controller  create Pod web-2 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreate  9h                   statefulset-controller  create Pod web-3 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreate  9h                   statefulset-controller  create Pod web-4 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulDelete  9h                   statefulset-controller  delete Pod web-4 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulDelete  9h                   statefulset-controller  delete Pod web-3 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulDelete  9h                   statefulset-controller  delete Pod web-2 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulDelete  6m38s                statefulset-controller  delete Pod web-1 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreate  6m37s <span class="o">(</span>x2 over 24h<span class="o">)</span>  statefulset-controller  create Pod web-1 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulDelete  6m23s                statefulset-controller  delete Pod web-0 in StatefulSet web successful
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreate  6m22s <span class="o">(</span>x2 over 24h<span class="o">)</span>  statefulset-controller  create Pod web-0 in StatefulSet web successful
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>RollingUpdate</p>
</blockquote>
<p>StatefulSet 也可以采用滚动更新策略，同样是修改 pod template 属性后会触发更新，但是由于 pod 是有序的，在 StatefulSet 中更新时是基于 pod 的顺序倒序更新的</p>
<blockquote>
<p>灰度发布</p>
</blockquote>
<p>利用滚动更新中的 partition 属性，可以实现简易的灰度发布的效果</p>
<p>例如我们有 5 个 pod，如果当前 partition 设置为 3，那么此时滚动更新时，只会更新那些 序号 &gt;= 3 的 pod</p>
<p>利用该机制，我们可以通过控制 partition 的值，来决定只更新其中一部分 pod，确认没有问题后再主键增大更新的 pod 数量，最终实现全部 pod 更新</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 实现灰度发布(金丝雀发布)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 扩容</span>
</span></span><span class="line"><span class="cl">kubectl scale sts web --replicas <span class="m">6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 更新如下内容</span>
</span></span><span class="line"><span class="cl">kubectl edit sts web
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  updateStrategy:
</span></span><span class="line"><span class="cl">    rollingUpdate:
</span></span><span class="line"><span class="cl">      partition: <span class="m">3</span> <span class="c1"># 改为3</span>
</span></span><span class="line"><span class="cl">    type: RollingUpdate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get po</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">dns-test   1/1     Running   <span class="m">0</span>          47h
</span></span><span class="line"><span class="cl">web-0      1/1     Running   <span class="m">0</span>          37h
</span></span><span class="line"><span class="cl">web-1      1/1     Running   <span class="m">0</span>          37h
</span></span><span class="line"><span class="cl">web-2      1/1     Running   <span class="m">0</span>          12h
</span></span><span class="line"><span class="cl">web-3      1/1     Running   <span class="m">0</span>          12h
</span></span><span class="line"><span class="cl">web-4      1/1     Running   <span class="m">0</span>          12h
</span></span><span class="line"><span class="cl">web-5      1/1     Running   <span class="m">0</span>          12h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果sts发生更新，优先更新web-3、web-4、web-5(优先更新&gt;=3的po)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时更新sts的image版本，查看po的内容</span>
</span></span><span class="line"><span class="cl"><span class="c1"># image从1.9.1更新为latest</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl describe po web-3</span>
</span></span><span class="line"><span class="cl">Name:         web-3
</span></span><span class="line"><span class="cl">Namespace:    default
</span></span><span class="line"><span class="cl">Priority:     <span class="m">0</span>
</span></span><span class="line"><span class="cl">Node:         k8s-node1/192.168.42.132
</span></span><span class="line"><span class="cl">Start Time:   Thu, <span class="m">19</span> Dec <span class="m">2024</span> 21:29:18 +0800
</span></span><span class="line"><span class="cl">Labels:       <span class="nv">app</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">              controller-revision-hash<span class="o">=</span>web-7974cc466
</span></span><span class="line"><span class="cl">              statefulset.kubernetes.io/pod-name<span class="o">=</span>web-3
</span></span><span class="line"><span class="cl">Annotations:  cni.projectcalico.org/containerID: 0c73e705476bd47bae66ff1b3e3763705fb433000aaf7411ad30cf4dd358bfb9
</span></span><span class="line"><span class="cl">              cni.projectcalico.org/podIP: 10.244.36.70/32
</span></span><span class="line"><span class="cl">              cni.projectcalico.org/podIPs: 10.244.36.70/32
</span></span><span class="line"><span class="cl">Status:       Running
</span></span><span class="line"><span class="cl">IP:           10.244.36.70
</span></span><span class="line"><span class="cl">IPs:
</span></span><span class="line"><span class="cl">  IP:           10.244.36.70
</span></span><span class="line"><span class="cl">Controlled By:  StatefulSet/web
</span></span><span class="line"><span class="cl">Containers:
</span></span><span class="line"><span class="cl">  nginx:
</span></span><span class="line"><span class="cl">    Container ID:   docker://873c777e9938672b070e104e0d9453d4c8caa16761c327cdaadb45a3aa078fa9
</span></span><span class="line"><span class="cl">    Image:          nginx:latest <span class="c1"># 可以看到web-3已经更新为latest版本了</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl describe po web-2</span>
</span></span><span class="line"><span class="cl">Name:         web-2
</span></span><span class="line"><span class="cl">Namespace:    default
</span></span><span class="line"><span class="cl">Priority:     <span class="m">0</span>
</span></span><span class="line"><span class="cl">Node:         k8s-node2/192.168.42.133
</span></span><span class="line"><span class="cl">Start Time:   Thu, <span class="m">19</span> Dec <span class="m">2024</span> 08:30:21 +0800
</span></span><span class="line"><span class="cl">Labels:       <span class="nv">app</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">              controller-revision-hash<span class="o">=</span>web-567b56dd
</span></span><span class="line"><span class="cl">              statefulset.kubernetes.io/pod-name<span class="o">=</span>web-2
</span></span><span class="line"><span class="cl">Annotations:  cni.projectcalico.org/containerID: 737d7c5bb252479092322bfa6edceb42b6538b29e6615402f68a6767f891de85
</span></span><span class="line"><span class="cl">              cni.projectcalico.org/podIP: 10.244.169.131/32
</span></span><span class="line"><span class="cl">              cni.projectcalico.org/podIPs: 10.244.169.131/32
</span></span><span class="line"><span class="cl">Status:       Running
</span></span><span class="line"><span class="cl">IP:           10.244.169.131
</span></span><span class="line"><span class="cl">IPs:
</span></span><span class="line"><span class="cl">  IP:           10.244.169.131
</span></span><span class="line"><span class="cl">Controlled By:  StatefulSet/web
</span></span><span class="line"><span class="cl">Containers:
</span></span><span class="line"><span class="cl">  nginx:
</span></span><span class="line"><span class="cl">    Container ID:   docker://d9efaad9065e835a888499244edecd5e83b66513905ea08d3908c893782f1049
</span></span><span class="line"><span class="cl">    Image:          nginx:1.9.1 <span class="c1"># 但是web-2还没有更新</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 最终逐步减小`partition`的值直至为0，这样就实现了灰度发布(金丝雀发布)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>OnDelete</p>
</blockquote>
<p>只有在 pod 被删除时会进行更新操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 将如下代码进行更新</span>
</span></span><span class="line"><span class="cl">  updateStrategy:
</span></span><span class="line"><span class="cl">    rollingUpdate:
</span></span><span class="line"><span class="cl">      partition: <span class="m">0</span>
</span></span><span class="line"><span class="cl">    type: RollingUpdate
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># 更新为如下代码</span>
</span></span><span class="line"><span class="cl">  updateStrategy:
</span></span><span class="line"><span class="cl">    type: OnDelete
</span></span><span class="line"><span class="cl"><span class="c1"># 表示更新策略设置为当删除时才更新</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时再修改image的版本从latest更新为1.9.1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时po是不会对版本进行更新的，只有在删除对应po时才会进行更新，删除po之后就会重建po，并更新image</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这样就能实现指定更新的po，比如我只希望更新web-3，而其他的po不希望进行更新</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时删除web-3这个po即可</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="删除">删除
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在无状态应用中，删除deploy之后，对应的po也会自动删除</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 而在有状态应用中，删除sts之后，默认也会进行级联删除</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 StatefulSet 和 Headless Service</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 默认级联删除：删除 statefulset 时会同时删除 pods</span>
</span></span><span class="line"><span class="cl">kubectl delete statefulset web
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 非级联删除：删除 statefulset 时不会删除 pods，删除 sts 后，pods 就没人管了，此时再删除 pod 不会重建的</span>
</span></span><span class="line"><span class="cl">kubectl deelte sts web --cascade<span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 service</span>
</span></span><span class="line"><span class="cl">kubectl delete service nginx
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="删除-pvc">删除 pvc
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># StatefulSet删除后PVC还会保留着，数据不再使用的话也需要删除</span>
</span></span><span class="line"><span class="cl">kubectl delete pvc www-web-0 www-web-1
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="配置文件-3">配置文件
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;nginx&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">www</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/nginx/html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeClaimTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">www</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volume.alpha.kubernetes.io/storage-class</span><span class="p">:</span><span class="w"> </span><span class="l">anything</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;ReadWriteOnce&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="daemonset">DaemonSet
</h4><blockquote>
<p>为每一个匹配到的 Node 都部署一个守护进程</p>
<p>如果有以下的业务场景，以下是微服务的调用链路</p>
</blockquote>
<p>
<div class="post-img-view">
	<a data-fancybox="gallery" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222124413.png">
		<img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222124413.png" alt="image-20241222212431460"  />
	</a>
</div>
</p>
<p>一般会存在第四个节点，部署普罗米修斯(监控)、elasticsearch(存放日志)</p>
<p>加入这种模式出现问题，我们一个个节点调查日志未免太过麻烦，最好有一个东西可以给每个节点的 log 信息统一写入 es 就好了</p>
<p><code>DaemonSet</code>正好符合需求，通过<code>nodeSelector</code>匹配到对应的<code>pod</code>，通过<code>Fluentd</code>收集日志并发送到 es</p>
<p>
<div class="post-img-view">
	<a data-fancybox="gallery" href="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222129683.png">
		<img src="https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo03/202412222129683.png" alt="image-20241222212953278"  />
	</a>
</div>
</p>
<p>DaemonSet 会忽略 Node 的 unschedulable 状态，有两种方式来指定 Pod 只运行在指定的 Node 节点上：</p>
<ul>
<li>nodeSelector：只调度到匹配指定 label 的 Node 上</li>
<li>nodeAffinity：功能更丰富的 Node 选择器，比如支持集合操作</li>
<li>podAffinity：调度到满足条件的 Pod 所在的 Node 上</li>
</ul>
<p>暂时先讲一下<code>nodeSelector</code>，其他两种后文再讲</p>
<h5 id="配置文件-4">配置文件
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 匹配po</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd-es</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">agilestacks/fluentd-elasticsearch:v1.3.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENTD_ARGS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span>-<span class="l">qq</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/docker/containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/docker/containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master daemonset<span class="o">]</span><span class="c1"># kubectl get ds</span>
</span></span><span class="line"><span class="cl">NAME      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span class="line"><span class="cl">fluentd   <span class="m">2</span>         <span class="m">2</span>         <span class="m">0</span>       <span class="m">2</span>            <span class="m">0</span>           &lt;none&gt;          8s
</span></span><span class="line"><span class="cl"><span class="c1"># 查看对应的po</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get po --show-labels</span>
</span></span><span class="line"><span class="cl">NAME            READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">dns-test        1/1     Running   <span class="m">0</span>          12d   <span class="nv">run</span><span class="o">=</span>dns-test
</span></span><span class="line"><span class="cl">fluentd-drcr8   1/1     Running   <span class="m">0</span>          13m   <span class="nv">app</span><span class="o">=</span>logging,controller-revision-hash<span class="o">=</span>b96747bc7,id<span class="o">=</span>fluentd,pod-template-generation<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">fluentd-ndlcf   1/1     Running   <span class="m">0</span>          13m   <span class="nv">app</span><span class="o">=</span>logging,controller-revision-hash<span class="o">=</span>b96747bc7,id<span class="o">=</span>fluentd,pod-template-generation<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">web-0           1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-0
</span></span><span class="line"><span class="cl">web-1           1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-1
</span></span><span class="line"><span class="cl">web-2           1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-2
</span></span><span class="line"><span class="cl">web-3           1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-3
</span></span><span class="line"><span class="cl">web-4           1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-4
</span></span><span class="line"><span class="cl">web-5           1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-5
</span></span><span class="line"><span class="cl"><span class="c1"># 查看标签，因为没有选择需要部署的节点，所以现在往每一个非master节点都部署了一份</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get nodes --show-labels</span>
</span></span><span class="line"><span class="cl">NAME         STATUS   ROLES                  AGE   VERSION   LABELS
</span></span><span class="line"><span class="cl">k8s-master   Ready    control-plane,master   82d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-master,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/control-plane<span class="o">=</span>,node-role.kubernetes.io/master<span class="o">=</span>,node.kubernetes.io/exclude-from-external-load-balancers<span class="o">=</span>
</span></span><span class="line"><span class="cl">k8s-node1    Ready    &lt;none&gt;                 82d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-node1,kubernetes.io/os<span class="o">=</span>linux
</span></span><span class="line"><span class="cl">k8s-node2    Ready    &lt;none&gt;                 82d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-node2,kubernetes.io/os<span class="o">=</span>linux
</span></span><span class="line"><span class="cl"><span class="c1"># 重新编辑daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl edit ds fluentd</span>
</span></span><span class="line"><span class="cl">daemonset.apps/fluentd edited
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># reopened with the relevant failures.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">deprecated.daemonset.template.generation</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-12-30T13:34:32Z&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;205641&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">022c628c-ca36-4c97-b149-f201569ed32e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENTD_ARGS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span>-<span class="l">qq</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">agilestacks/fluentd-elasticsearch:v1.3.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd-es</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/termination-log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l">File</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/docker/containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterFirst</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="c">## 添加这两行，用来选择对应label的nodes节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">microservices</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l">default-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/docker/containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 我们这边nodes节点没有匹配`type: microservices`的，所以下面没有daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get nodes --show-labels</span>
</span></span><span class="line"><span class="cl">NAME         STATUS   ROLES                  AGE   VERSION   LABELS
</span></span><span class="line"><span class="cl">k8s-master   Ready    control-plane,master   83d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-master,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/control-plane<span class="o">=</span>,node-role.kubernetes.io/master<span class="o">=</span>,node.kubernetes.io/exclude-from-external-load-balancers<span class="o">=</span>
</span></span><span class="line"><span class="cl">k8s-node1    Ready    &lt;none&gt;                 83d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-node1,kubernetes.io/os<span class="o">=</span>linux
</span></span><span class="line"><span class="cl">k8s-node2    Ready    &lt;none&gt;                 82d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-node2,kubernetes.io/os<span class="o">=</span>linux
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get po --show-labels</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">dns-test   1/1     Running   <span class="m">0</span>          12d   <span class="nv">run</span><span class="o">=</span>dns-test
</span></span><span class="line"><span class="cl">web-0      1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-0
</span></span><span class="line"><span class="cl">web-1      1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-1
</span></span><span class="line"><span class="cl">web-2      1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-2
</span></span><span class="line"><span class="cl">web-3      1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-3
</span></span><span class="line"><span class="cl">web-4      1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-4
</span></span><span class="line"><span class="cl">web-5      1/1     Running   <span class="m">0</span>          11d   <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-5
</span></span><span class="line"><span class="cl"><span class="c1"># 给nodes节点增加label</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl label nodes k8s-node1 type=microservices</span>
</span></span><span class="line"><span class="cl">node/k8s-node1 labeled
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get nodes --show-labels</span>
</span></span><span class="line"><span class="cl">NAME         STATUS   ROLES                  AGE   VERSION   LABELS
</span></span><span class="line"><span class="cl">k8s-master   Ready    control-plane,master   83d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-master,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/control-plane<span class="o">=</span>,node-role.kubernetes.io/master<span class="o">=</span>,node.kubernetes.io/exclude-from-external-load-balancers<span class="o">=</span>
</span></span><span class="line"><span class="cl">k8s-node1    Ready    &lt;none&gt;                 83d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-node1,kubernetes.io/os<span class="o">=</span>linux,type<span class="o">=</span>microservices
</span></span><span class="line"><span class="cl">k8s-node2    Ready    &lt;none&gt;                 83d   v1.23.6   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>k8s-node2,kubernetes.io/os<span class="o">=</span>linux
</span></span><span class="line"><span class="cl"><span class="c1"># 这个时候就自动增加了一个ds</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get ds</span>
</span></span><span class="line"><span class="cl">NAME      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR        AGE
</span></span><span class="line"><span class="cl">fluentd   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>       <span class="m">1</span>            <span class="m">1</span>           <span class="nv">type</span><span class="o">=</span>microservices   21m
</span></span><span class="line"><span class="cl"><span class="c1"># 查看发现果然`fluentd-7rxmk`被部署到k8s-node1上了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get po --show-labels -o wide</span>
</span></span><span class="line"><span class="cl">NAME            READY   STATUS    RESTARTS   AGE   IP               NODE        NOMINATED NODE   READINESS GATES   LABELS
</span></span><span class="line"><span class="cl">dns-test        1/1     Running   <span class="m">0</span>          12d   10.244.169.129   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">run</span><span class="o">=</span>dns-test
</span></span><span class="line"><span class="cl">fluentd-7rxmk   1/1     Running   <span class="m">0</span>          73s   10.244.36.67     k8s-node1   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>logging,controller-revision-hash<span class="o">=</span>5b4769fc56,id<span class="o">=</span>fluentd,pod-template-generation<span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">web-0           1/1     Running   <span class="m">0</span>          11d   10.244.36.71     k8s-node1   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-0
</span></span><span class="line"><span class="cl">web-1           1/1     Running   <span class="m">0</span>          11d   10.244.169.136   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-1
</span></span><span class="line"><span class="cl">web-2           1/1     Running   <span class="m">0</span>          11d   10.244.169.135   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-2
</span></span><span class="line"><span class="cl">web-3           1/1     Running   <span class="m">0</span>          11d   10.244.36.70     k8s-node1   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-3
</span></span><span class="line"><span class="cl">web-4           1/1     Running   <span class="m">0</span>          11d   10.244.36.69     k8s-node1   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-4
</span></span><span class="line"><span class="cl">web-5           1/1     Running   <span class="m">0</span>          11d   10.244.169.134   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-5
</span></span><span class="line"><span class="cl"><span class="c1"># 再给k8s-node2加一个标签</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl label no k8s-node2 type=microservices</span>
</span></span><span class="line"><span class="cl">node/k8s-node2 labeled
</span></span><span class="line"><span class="cl"><span class="c1"># 这边也自动部署了第二个fluentd(fluentd-zjrqp)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master k8s<span class="o">]</span><span class="c1"># kubectl get po --show-labels -o wide</span>
</span></span><span class="line"><span class="cl">NAME            READY   STATUS    RESTARTS   AGE     IP               NODE        NOMINATED NODE   READINESS GATES   LABELS
</span></span><span class="line"><span class="cl">dns-test        1/1     Running   <span class="m">0</span>          12d     10.244.169.129   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">run</span><span class="o">=</span>dns-test
</span></span><span class="line"><span class="cl">fluentd-7rxmk   1/1     Running   <span class="m">0</span>          2m53s   10.244.36.67     k8s-node1   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>logging,controller-revision-hash<span class="o">=</span>5b4769fc56,id<span class="o">=</span>fluentd,pod-template-generation<span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">fluentd-zjrqp   1/1     Running   <span class="m">0</span>          3s      10.244.169.131   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>logging,controller-revision-hash<span class="o">=</span>5b4769fc56,id<span class="o">=</span>fluentd,pod-template-generation<span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">web-0           1/1     Running   <span class="m">0</span>          11d     10.244.36.71     k8s-node1   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-0
</span></span><span class="line"><span class="cl">web-1           1/1     Running   <span class="m">0</span>          11d     10.244.169.136   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-1
</span></span><span class="line"><span class="cl">web-2           1/1     Running   <span class="m">0</span>          11d     10.244.169.135   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-2
</span></span><span class="line"><span class="cl">web-3           1/1     Running   <span class="m">0</span>          11d     10.244.36.70     k8s-node1   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-3
</span></span><span class="line"><span class="cl">web-4           1/1     Running   <span class="m">0</span>          11d     10.244.36.69     k8s-node1   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-4
</span></span><span class="line"><span class="cl">web-5           1/1     Running   <span class="m">0</span>          11d     10.244.169.134   k8s-node2   &lt;none&gt;           &lt;none&gt;            <span class="nv">app</span><span class="o">=</span>nginx,controller-revision-hash<span class="o">=</span>web-7974cc466,statefulset.kubernetes.io/pod-name<span class="o">=</span>web-5
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>nodeAffinity</p>
</blockquote>
<p>nodeAffinity 目前支持两种：<code>requiredDuringSchedulingIgnoredDuringExecution</code> 和 <code>preferredDuringSchedulingIgnoredDuringExecution</code>，分别代表必须满足条件和优选条件。</p>
<p>比如下面的例子代表调度到包含标签 <code>wolfcode.cn/framework-name</code> 并且值为 <code>spring</code> 或 <code>springboot</code> 的 Node 上，并且优选还带有标签 <code>another-node-label-key=another-node-label-value</code> 的 Node。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with-node-affinity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">wolfcode.cn/framework-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>- <span class="l">spring</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>- <span class="l">springboot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">preference</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">another-node-label-key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>- <span class="l">another-node-label-value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with-node-affinity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">pauseyyf/pause</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>podAffinity</p>
</blockquote>
<p>podAffinity 基于 Pod 的标签来选择 Node，仅调度到满足条件 Pod 所在的 Node 上，支持 podAffinity 和 podAntiAffinity。这个功能比较绕，以下面的例子为例：</p>
<ul>
<li>如果一个 “Node 所在空间中包含至少一个带有 auth=oauth2 标签且运行中的 Pod”，那么可以调度到该 Node</li>
<li>不调度到 “包含至少一个带有 auth=jwt 标签且运行中 Pod”的 Node 上</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with-pod-affinity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>- <span class="l">oauth2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">failure-domain.beta.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podAntiAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">podAffinityTerm</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">jwt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with-pod-affinity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">pauseyyf/pause</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="滚动更新-1">滚动更新
</h5><blockquote>
<p>不建议使用 RollingUpdate，建议使用 OnDelete 模式，这样避免频繁更新 ds</p>
<p>默认 daemonset 滚动更新的模式是<code>RollingUpdate</code></p>
<p>但是不建议使用<code>RollingUpdate</code>，建议使用<code>Ondelete</code></p>
<p>因为如果我们希望对某个节点的 ds 进行更新，那么此时会将所有结点的 ds 全部更新</p>
<p>如果使用<code>Ondelete</code>，我们只需要将需要更新的<code>po</code>删掉即可，会自动创建并更新</p>
</blockquote>
<h4 id="hpa-自动扩缩容">HPA 自动扩/缩容
</h4><p>通过观察 pod 的 cpu、内存使用率或自定义 metrics 指标进行自动的扩容或缩容 pod 的数量。</p>
<p>通常用于 Deployment，不适用于无法扩/缩容的对象，如 <code>DaemonSet</code></p>
<p>控制管理器每隔 30s（可以通过–horizontal-pod-autoscaler-sync-period 修改）查询 metrics 的资源使用情况</p>
<blockquote>
<p>这里演示就先将副本数改成 1，让他自动扩容</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># ll</span>
</span></span><span class="line"><span class="cl">total <span class="m">4</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">569</span> Dec <span class="m">15</span> 21:52 nginx-deploy.yaml
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master deployments<span class="o">]</span><span class="c1"># vim nginx-deploy.yaml</span>
</span></span><span class="line"><span class="cl"><span class="c1"># spec:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   replicas: 1 # 副本数</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="开启指标服务">开启指标服务
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 下载 metrics-server 组件配置文件</span>
</span></span><span class="line"><span class="cl">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server-components.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改镜像地址为国内的地址</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/k8s.gcr.io\/metrics-server/registry.cn-hangzhou.aliyuncs.com\/google_containers/g&#39;</span> metrics-server-components.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改容器的 tls 配置，不验证 tls，在 containers 的 args 参数中增加 --kubelet-insecure-tls 参数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装组件</span>
</span></span><span class="line"><span class="cl">kubectl apply -f metrics-server-components.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 pod 状态</span>
</span></span><span class="line"><span class="cl">kubectl get pods --all-namespaces <span class="p">|</span> grep metrics
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="cpu内存指标监控">cpu、内存指标监控
</h5><p>实现 cpu 或内存的监控，首先有个前提条件是该对象必须配置了 <code>resources.requests.cpu</code> 或 <code>resources.requests.memory</code> 才可以，可以配置当 cpu/memory 达到上述配置的百分比后进行扩容或缩容</p>
<p>创建一个 HPA：</p>
<ol>
<li>
<p>先准备一个好一个有做资源限制的 deployment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.7.9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置资源限制，配小一点，便于测试自动扩容</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我们之前已经创建过一个<code>nginx-deploy</code>了，这次直接替换就好</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl replace -f nginx-deploy.yaml
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>执行命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl autoscale deploy nginx-deploy --cpu-percent<span class="o">=</span><span class="m">20</span> --min<span class="o">=</span><span class="m">2</span> --max<span class="o">=</span><span class="m">5</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>通过 <code>kubectl get hpa</code> 可以获取 HPA 信息</p>
</li>
</ol>
<p>测试：找到对应服务的 service，编写循环测试脚本提升内存与 cpu 负载</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">while</span> true<span class="p">;</span> <span class="k">do</span> wget -q -O- http://&lt;ip:port&gt; &gt; /dev/null <span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以通过多台机器执行上述命令，增加负载，当超过负载后可以查看 pods 的扩容情况 <code>kubectl get pods</code></p>
<p>查看 pods 资源使用情况
<code>kubectl top pods</code></p>
<p>扩容测试完成后，再关闭循环执行的指令，让 cpu 占用率降下来，然后过 5 分钟后查看自动缩容情况</p>
<h5 id="自定义-metrics">自定义 metrics
</h5><ul>
<li>控制管理器开启–horizontal-pod-autoscaler-use-rest-clients</li>
<li>控制管理器的–apiserver 指向<a class="link" href="https://github.com/kubernetes/kube-aggregator"  target="_blank" rel="noopener" >API Server Aggregator</a></li>
<li>在 API Server Aggregator 中注册自定义的 metrics API</li>
</ul>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 深海火锅店
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
